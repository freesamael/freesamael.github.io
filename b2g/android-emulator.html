<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Study on Emulator - Marxico - Markdown Editor for Evernote</title>
        <link rel="icon" href="http://marxi.co/favicon.ico">	
        <link rel="bookmark" href="http://marxi.co/favicon.ico">
        <link rel="shortcut icon" sizes="16x16" href="http://marxi.co/ico/icon16.png" type="image/png">
        <link rel="shortcut icon" sizes="32x32" href="http://marxi.co/ico/icon32.png" type="image/png">
        <link rel="shortcut icon" sizes="48x48" href="http://marxi.co/ico/icon48.png" type="image/png">
        <link rel="shortcut icon" sizes="128x128" href="http://marxi.co/ico/icon128.png" type="image/png">
        <link rel="chrome-webstore-item" href="https://chrome.google.com/webstore/detail/kidnkfckhbdkfgbicccmdggmpgogehop">
        <meta name="description" content="The Missing Markdown Editor for Evernote">
        <meta name="author" content="gock">
        <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <script src="android-emulator_files/analytics.js" async=""></script><script src="android-emulator_files/analytics.js" async=""></script><script>

        
            window.CDN = "//d31qtcb7c58z3n.cloudfront.net"
        

        window.MX_VERSION = 20150826
        </script>


        <style>
        #loading{position:fixed;top:0;left:0;bottom:0;right:0;z-index:10000000;background:white;color:#74b936;text-align:center}#loading .loading-container{position:absolute;margin:auto;left:0;right:0;top:30%;bottom:0}#loading b{color:white;background:#74b936;font-weight:normal;padding:5px 5px;margin:10px;font-size:50px}#loading h1,#loading h2,#loading h3,#loading h4{font-family:"Helvetica Neue",Arial,"Hiragino Sans GB","STHeiti","Microsoft YaHei","WenQuanYi Micro Hei",SimSun,sans-serif;text-align:center}#loading .reverse{color:white !important;background:#74b936 !important;padding:4px;border-radius:4px}#loading #loading-app-name{text-align:center;font-size:54px;margin-top:0;margin-bottom:.8em}#loading #loading-slogan{font-weight:normal}#loading #loading-text{margin:80px auto;text-align:center;margin-bottom:40px}#loading #loading-view-doc{font-size:16px;margin:10px auto}#loading #loading-view-doc a{padding:10px;border-radius:6px;border:1px solid #74b936}#loading #loading-view-doc a:link,#loading #loading-view-doc a:hover,#loading #loading-view-doc a:active,#loading #loading-view-doc a:visited{color:#74b936;text-decoration:none}.slim-scroll ::-webkit-scrollbar{height:10px;width:7px;background:transparent}.slim-scroll ::-webkit-scrollbar:hover{background:rgba(128,128,128,0.1)}.slim-scroll ::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.3);-webkit-border-radius:6px}.slim-scroll ::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,0.6)}.slim-scroll ::-webkit-scrollbar-corner{background:#000}.slim-scroll .ace_dark .ace_scrollbar::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.3);-webkit-border-radius:6px}.slim-scroll .ace_dark .ace_scrollbar::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.6)}.slim-scroll .ace_scroller{right:4px !important}.slim-scroll .ace_scrollbar-v{right:4px !important}.slim-scroll #preview{right:2px}
        </style>
        <script>
        (function(){
        		var url = window.location.href
                if (/guid/.test(location.hash)){
                    if (/fast_redirect=1/.test(document.cookie) || localStorage.getItem('client_installed') == 1){
                        window.location.href = window.location.href.replace(/^\w*:/, "mxdown:");
                        return;
                    } else {
                        if (window.chrome){
                        
                            /*
                            if (window.confirm('{%= REDIRECT %}')){
                            
                                document.cookie = "fast_redirect=1; expires=Fri, 31 Dec 9999 23:59:59 GMT; " + "domain=" + (/^[\d\.]*$/.test(window.location.host) ? "" : ".") + window.location.host.replace(/^app/, '')
                                window.location.href = window.location.href.replace(/^\w*:/, "mxdown:");
                            }
                            */
                            //setTimeout('window.location.href=window.location.href.replace(/^\\w*:\\/\\//, "mxdown://")', 500)
                        } else {
                            //window.open(window.location.href.replace(/^\w*:/, "mxdown:"));
                        }
                    }
                }
        		if (/guid/.test(location.hash) && !/note/.test(location.pathname) && window.chrome){
        			window.location.pathname = '/note/'
        		}
        
        	}())
        console.debug = function(){};
        window.BACKEND = ""
        window.BACKEND_YINXIANG = ""
        window.ENV = {    
        	web: true,
        	ua: navigator.userAgent,
        	version : "2014-08-24"
        }
        </script>
        
        <script>
            // Use ?debug to serve original JavaScript files instead of minified
            
                window.baseDir = ''
            

            
        </script>

        <link href="android-emulator_files/marxico.css" rel="stylesheet">

        <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        
        ga('create', 'UA-43559825-4', 'marxi.co');
        ga('send', 'pageview');
        </script>
        
    <style type="text/css">#wikiwand-ext-switch-button {
      position:fixed;
      bottom:-100px;
      right:10px;
      width:227px;
      height:48px;
      z-index:200000;
      cursor:pointer;
  }

  .wikiwand-ext-switch-button-RTL {
      right:auto !important;
      left:60px;
  }
  #wikiwand-ext-switch-link {
      cursor:pointer;
  }
  #wikiwand-ext-loading {
      position:fixed;
      width:120px;
      height:120px;
      margin-left:-60px;
      margin-top:-60px;
      top:50%;
      left:50%;
      z-index:100000;
      opacity:0;
  }</style><script src="android-emulator_files/MathJax.js" data-requiremodule="mathjax" data-requirecontext="_" async="" charset="utf-8" type="text/javascript"></script><style id="ace_editor.css">.ace_editor {
    position: relative;
    overflow: hidden;
    font: 12px/normal 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
    direction: ltr;
}

.ace_scroller {
    position: absolute;
    overflow: hidden;
    top: 0;
    bottom: 0;
    background-color: inherit;
    -ms-user-select: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    user-select: none;
    cursor: text;
}

.ace_content {
    position: absolute;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    min-width: 100%;
}

.ace_dragging .ace_scroller:before{
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    content: '';
    background: rgba(250, 250, 250, 0.01);
    z-index: 1000;
}
.ace_dragging.ace_dark .ace_scroller:before{
    background: rgba(0, 0, 0, 0.01);
}

.ace_selecting, .ace_selecting * {
    cursor: text !important;
}

.ace_gutter {
    position: absolute;
    overflow : hidden;
    width: auto;
    top: 0;
    bottom: 0;
    left: 0;
    cursor: default;
    z-index: 4;
    -ms-user-select: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    user-select: none;
}

.ace_gutter-active-line {
    position: absolute;
    left: 0;
    right: 0;
}

.ace_scroller.ace_scroll-left {
    box-shadow: 17px 0 16px -16px rgba(0, 0, 0, 0.4) inset;
}

.ace_gutter-cell {
    padding-left: 19px;
    padding-right: 6px;
    background-repeat: no-repeat;
}

.ace_gutter-cell.ace_error {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAABOFBMVEX/////////QRswFAb/Ui4wFAYwFAYwFAaWGAfDRymzOSH/PxswFAb/SiUwFAYwFAbUPRvjQiDllog5HhHdRybsTi3/Tyv9Tir+Syj/UC3////XurebMBIwFAb/RSHbPx/gUzfdwL3kzMivKBAwFAbbvbnhPx66NhowFAYwFAaZJg8wFAaxKBDZurf/RB6mMxb/SCMwFAYwFAbxQB3+RB4wFAb/Qhy4Oh+4QifbNRcwFAYwFAYwFAb/QRzdNhgwFAYwFAbav7v/Uy7oaE68MBK5LxLewr/r2NXewLswFAaxJw4wFAbkPRy2PyYwFAaxKhLm1tMwFAazPiQwFAaUGAb/QBrfOx3bvrv/VC/maE4wFAbRPBq6MRO8Qynew8Dp2tjfwb0wFAbx6eju5+by6uns4uH9/f36+vr/GkHjAAAAYnRSTlMAGt+64rnWu/bo8eAA4InH3+DwoN7j4eLi4xP99Nfg4+b+/u9B/eDs1MD1mO7+4PHg2MXa347g7vDizMLN4eG+Pv7i5evs/v79yu7S3/DV7/498Yv24eH+4ufQ3Ozu/v7+y13sRqwAAADLSURBVHjaZc/XDsFgGIBhtDrshlitmk2IrbHFqL2pvXf/+78DPokj7+Fz9qpU/9UXJIlhmPaTaQ6QPaz0mm+5gwkgovcV6GZzd5JtCQwgsxoHOvJO15kleRLAnMgHFIESUEPmawB9ngmelTtipwwfASilxOLyiV5UVUyVAfbG0cCPHig+GBkzAENHS0AstVF6bacZIOzgLmxsHbt2OecNgJC83JERmePUYq8ARGkJx6XtFsdddBQgZE2nPR6CICZhawjA4Fb/chv+399kfR+MMMDGOQAAAABJRU5ErkJggg==");
    background-repeat: no-repeat;
    background-position: 2px center;
}

.ace_gutter-cell.ace_warning {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAmVBMVEX///8AAAD///8AAAAAAABPSzb/5sAAAAB/blH/73z/ulkAAAAAAAD85pkAAAAAAAACAgP/vGz/rkDerGbGrV7/pkQICAf////e0IsAAAD/oED/qTvhrnUAAAD/yHD/njcAAADuv2r/nz//oTj/p064oGf/zHAAAAA9Nir/tFIAAAD/tlTiuWf/tkIAAACynXEAAAAAAAAtIRW7zBpBAAAAM3RSTlMAABR1m7RXO8Ln31Z36zT+neXe5OzooRDfn+TZ4p3h2hTf4t3k3ucyrN1K5+Xaks52Sfs9CXgrAAAAjklEQVR42o3PbQ+CIBQFYEwboPhSYgoYunIqqLn6/z8uYdH8Vmdnu9vz4WwXgN/xTPRD2+sgOcZjsge/whXZgUaYYvT8QnuJaUrjrHUQreGczuEafQCO/SJTufTbroWsPgsllVhq3wJEk2jUSzX3CUEDJC84707djRc5MTAQxoLgupWRwW6UB5fS++NV8AbOZgnsC7BpEAAAAABJRU5ErkJggg==");
    background-position: 2px center;
}

.ace_gutter-cell.ace_info {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAAAAAA6mKC9AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAJ0Uk5TAAB2k804AAAAPklEQVQY02NgIB68QuO3tiLznjAwpKTgNyDbMegwisCHZUETUZV0ZqOquBpXj2rtnpSJT1AEnnRmL2OgGgAAIKkRQap2htgAAAAASUVORK5CYII=");
    background-position: 2px center;
}
.ace_dark .ace_gutter-cell.ace_info {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQBAMAAADt3eJSAAAAJFBMVEUAAAChoaGAgIAqKiq+vr6tra1ZWVmUlJSbm5s8PDxubm56enrdgzg3AAAAAXRSTlMAQObYZgAAAClJREFUeNpjYMAPdsMYHegyJZFQBlsUlMFVCWUYKkAZMxZAGdxlDMQBAG+TBP4B6RyJAAAAAElFTkSuQmCC");
}

.ace_scrollbar {
    position: absolute;
    right: 0;
    bottom: 0;
    z-index: 6;
}

.ace_scrollbar-inner {
    position: absolute;
    cursor: text;
    left: 0;
    top: 0;
}

.ace_scrollbar-v{
    overflow-x: hidden;
    overflow-y: scroll;
    top: 0;
}

.ace_scrollbar-h {
    overflow-x: scroll;
    overflow-y: hidden;
    left: 0;
}

.ace_print-margin {
    position: absolute;
    height: 100%;
}

.ace_text-input {
    position: absolute;
    z-index: 0;
    width: 0.5em;
    height: 1em;
    opacity: 0;
    background: transparent;
    -moz-appearance: none;
    appearance: none;
    border: none;
    resize: none;
    outline: none;
    overflow: hidden;
    font: inherit;
    padding: 0 1px;
    margin: 0 -1px;
    text-indent: -1em;
    -ms-user-select: text;
    -moz-user-select: text;
    -webkit-user-select: text;
    user-select: text;
}

.ace_text-input.ace_composition {
    background: inherit;
    color: inherit;
    z-index: 1000;
    opacity: 1;
    text-indent: 0;
}

.ace_layer {
    z-index: 1;
    position: absolute;
    overflow: hidden;
    /* workaround for chrome bug https://github.com/ajaxorg/ace/issues/2312*/
    word-wrap: normal;
    white-space: pre;
    height: 100%;
    width: 100%;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    /* setting pointer-events: auto; on node under the mouse, which changes
        during scroll, will break mouse wheel scrolling in Safari */
    pointer-events: none;
}

.ace_gutter-layer {
    position: relative;
    width: auto;
    text-align: right;
    pointer-events: auto;
}

.ace_text-layer {
    font: inherit !important;
}

.ace_cjk {
    display: inline-block;
    text-align: center;
}

.ace_cursor-layer {
    z-index: 4;
}

.ace_cursor {
    z-index: 4;
    position: absolute;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    border-left: 2px solid
}

.ace_slim-cursors .ace_cursor {
    border-left-width: 1px;
}

.ace_overwrite-cursors .ace_cursor {
    border-left-width: 0;
    border-bottom: 1px solid;
}

.ace_hidden-cursors .ace_cursor {
    opacity: 0.2;
}

.ace_smooth-blinking .ace_cursor {
    -webkit-transition: opacity 0.18s;
            transition: opacity 0.18s;
}

.ace_editor.ace_multiselect .ace_cursor {
    border-left-width: 1px;
}

.ace_marker-layer .ace_step, .ace_marker-layer .ace_stack {
    position: absolute;
    z-index: 3;
}

.ace_marker-layer .ace_selection {
    position: absolute;
    z-index: 5;
}

.ace_marker-layer .ace_bracket {
    position: absolute;
    z-index: 6;
}

.ace_marker-layer .ace_active-line {
    position: absolute;
    z-index: 2;
}

.ace_marker-layer .ace_selected-word {
    position: absolute;
    z-index: 4;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}

.ace_line .ace_fold {
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;

    display: inline-block;
    height: 11px;
    margin-top: -2px;
    vertical-align: middle;

    background-image:
        url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAAJCAYAAADU6McMAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAJpJREFUeNpi/P//PwOlgAXGYGRklAVSokD8GmjwY1wasKljQpYACtpCFeADcHVQfQyMQAwzwAZI3wJKvCLkfKBaMSClBlR7BOQikCFGQEErIH0VqkabiGCAqwUadAzZJRxQr/0gwiXIal8zQQPnNVTgJ1TdawL0T5gBIP1MUJNhBv2HKoQHHjqNrA4WO4zY0glyNKLT2KIfIMAAQsdgGiXvgnYAAAAASUVORK5CYII="),
        url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAA3CAYAAADNNiA5AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAACJJREFUeNpi+P//fxgTAwPDBxDxD078RSX+YeEyDFMCIMAAI3INmXiwf2YAAAAASUVORK5CYII=");
    background-repeat: no-repeat, repeat-x;
    background-position: center center, top left;
    color: transparent;

    border: 1px solid black;
    border-radius: 2px;

    cursor: pointer;
    pointer-events: auto;
}

.ace_dark .ace_fold {
}

.ace_fold:hover{
    background-image:
        url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAAJCAYAAADU6McMAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAJpJREFUeNpi/P//PwOlgAXGYGRklAVSokD8GmjwY1wasKljQpYACtpCFeADcHVQfQyMQAwzwAZI3wJKvCLkfKBaMSClBlR7BOQikCFGQEErIH0VqkabiGCAqwUadAzZJRxQr/0gwiXIal8zQQPnNVTgJ1TdawL0T5gBIP1MUJNhBv2HKoQHHjqNrA4WO4zY0glyNKLT2KIfIMAAQsdgGiXvgnYAAAAASUVORK5CYII="),
        url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAA3CAYAAADNNiA5AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAACBJREFUeNpi+P//fz4TAwPDZxDxD5X4i5fLMEwJgAADAEPVDbjNw87ZAAAAAElFTkSuQmCC");
}

.ace_tooltip {
    background-color: #FFF;
    background-image: -webkit-linear-gradient(top, transparent, rgba(0, 0, 0, 0.1));
    background-image: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.1));
    border: 1px solid gray;
    border-radius: 1px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    color: black;
    max-width: 100%;
    padding: 3px 4px;
    position: fixed;
    z-index: 999999;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    cursor: default;
    white-space: pre;
    word-wrap: break-word;
    line-height: normal;
    font-style: normal;
    font-weight: normal;
    letter-spacing: normal;
    pointer-events: none;
}

.ace_folding-enabled > .ace_gutter-cell {
    padding-right: 13px;
}

.ace_fold-widget {
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;

    margin: 0 -12px 0 1px;
    display: none;
    width: 11px;
    vertical-align: top;

    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAANElEQVR42mWKsQ0AMAzC8ixLlrzQjzmBiEjp0A6WwBCSPgKAXoLkqSot7nN3yMwR7pZ32NzpKkVoDBUxKAAAAABJRU5ErkJggg==");
    background-repeat: no-repeat;
    background-position: center;

    border-radius: 3px;
    
    border: 1px solid transparent;
    cursor: pointer;
}

.ace_folding-enabled .ace_fold-widget {
    display: inline-block;   
}

.ace_fold-widget.ace_end {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAANElEQVR42m3HwQkAMAhD0YzsRchFKI7sAikeWkrxwScEB0nh5e7KTPWimZki4tYfVbX+MNl4pyZXejUO1QAAAABJRU5ErkJggg==");
}

.ace_fold-widget.ace_closed {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAAGCAYAAAAG5SQMAAAAOUlEQVR42jXKwQkAMAgDwKwqKD4EwQ26sSOkVWjgIIHAzPiCgaqiqnJHZnKICBERHN194O5b9vbLuAVRL+l0YWnZAAAAAElFTkSuQmCCXA==");
}

.ace_fold-widget:hover {
    border: 1px solid rgba(0, 0, 0, 0.3);
    background-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 1px 1px rgba(255, 255, 255, 0.7);
}

.ace_fold-widget:active {
    border: 1px solid rgba(0, 0, 0, 0.4);
    background-color: rgba(0, 0, 0, 0.05);
    box-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
}
/**
 * Dark version for fold widgets
 */
.ace_dark .ace_fold-widget {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHklEQVQIW2P4//8/AzoGEQ7oGCaLLAhWiSwB146BAQCSTPYocqT0AAAAAElFTkSuQmCC");
}
.ace_dark .ace_fold-widget.ace_end {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAH0lEQVQIW2P4//8/AxQ7wNjIAjDMgC4AxjCVKBirIAAF0kz2rlhxpAAAAABJRU5ErkJggg==");
}
.ace_dark .ace_fold-widget.ace_closed {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAAFCAYAAACAcVaiAAAAHElEQVQIW2P4//+/AxAzgDADlOOAznHAKgPWAwARji8UIDTfQQAAAABJRU5ErkJggg==");
}
.ace_dark .ace_fold-widget:hover {
    box-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);
    background-color: rgba(255, 255, 255, 0.1);
}
.ace_dark .ace_fold-widget:active {
    box-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);
}

.ace_fold-widget.ace_invalid {
    background-color: #FFB4B4;
    border-color: #DE5555;
}

.ace_fade-fold-widgets .ace_fold-widget {
    -webkit-transition: opacity 0.4s ease 0.05s;
            transition: opacity 0.4s ease 0.05s;
    opacity: 0;
}

.ace_fade-fold-widgets:hover .ace_fold-widget {
    -webkit-transition: opacity 0.05s ease 0.05s;
            transition: opacity 0.05s ease 0.05s;
    opacity:1;
}

.ace_underline {
    text-decoration: underline;
}

.ace_bold {
    font-weight: bold;
}

.ace_nobold .ace_bold {
    font-weight: normal;
}

.ace_italic {
    font-style: italic;
}


.ace_error-marker {
    background-color: rgba(255, 0, 0,0.2);
    position: absolute;
    z-index: 9;
}

.ace_highlight-marker {
    background-color: rgba(255, 255, 0,0.2);
    position: absolute;
    z-index: 8;
}
</style><style id="ace-tm">.ace-tm .ace_gutter {
  background: #f0f0f0;
  color: #333;
}

.ace-tm .ace_print-margin {
  width: 1px;
  background: #e8e8e8;
}

.ace-tm .ace_fold {
    background-color: #6B72E6;
}

.ace-tm {
  background-color: #FFFFFF;
  color: black;
}

.ace-tm .ace_cursor {
  color: black;
}
        
.ace-tm .ace_invisible {
  color: rgb(191, 191, 191);
}

.ace-tm .ace_storage,
.ace-tm .ace_keyword {
  color: blue;
}

.ace-tm .ace_constant {
  color: rgb(197, 6, 11);
}

.ace-tm .ace_constant.ace_buildin {
  color: rgb(88, 72, 246);
}

.ace-tm .ace_constant.ace_language {
  color: rgb(88, 92, 246);
}

.ace-tm .ace_constant.ace_library {
  color: rgb(6, 150, 14);
}

.ace-tm .ace_invalid {
  background-color: rgba(255, 0, 0, 0.1);
  color: red;
}

.ace-tm .ace_support.ace_function {
  color: rgb(60, 76, 114);
}

.ace-tm .ace_support.ace_constant {
  color: rgb(6, 150, 14);
}

.ace-tm .ace_support.ace_type,
.ace-tm .ace_support.ace_class {
  color: rgb(109, 121, 222);
}

.ace-tm .ace_keyword.ace_operator {
  color: rgb(104, 118, 135);
}

.ace-tm .ace_string {
  color: rgb(3, 106, 7);
}

.ace-tm .ace_comment {
  color: rgb(76, 136, 107);
}

.ace-tm .ace_comment.ace_doc {
  color: rgb(0, 102, 255);
}

.ace-tm .ace_comment.ace_doc.ace_tag {
  color: rgb(128, 159, 191);
}

.ace-tm .ace_constant.ace_numeric {
  color: rgb(0, 0, 205);
}

.ace-tm .ace_variable {
  color: rgb(49, 132, 149);
}

.ace-tm .ace_xml-pe {
  color: rgb(104, 104, 91);
}

.ace-tm .ace_entity.ace_name.ace_function {
  color: #0000A2;
}


.ace-tm .ace_heading {
  color: rgb(12, 7, 255);
}

.ace-tm .ace_list {
  color:rgb(185, 6, 144);
}

.ace-tm .ace_meta.ace_tag {
  color:rgb(0, 22, 142);
}

.ace-tm .ace_string.ace_regex {
  color: rgb(255, 0, 0)
}

.ace-tm .ace_marker-layer .ace_selection {
  background: rgb(181, 213, 255);
}
.ace-tm.ace_multiselect .ace_selection.ace_start {
  box-shadow: 0 0 3px 0px white;
  border-radius: 2px;
}
.ace-tm .ace_marker-layer .ace_step {
  background: rgb(252, 255, 0);
}

.ace-tm .ace_marker-layer .ace_stack {
  background: rgb(164, 229, 101);
}

.ace-tm .ace_marker-layer .ace_bracket {
  margin: -1px 0 0 -1px;
  border: 1px solid rgb(192, 192, 192);
}

.ace-tm .ace_marker-layer .ace_active-line {
  background: rgba(0, 0, 0, 0.07);
}

.ace-tm .ace_gutter-active-line {
    background-color : #dcdcdc;
}

.ace-tm .ace_marker-layer .ace_selected-word {
  background: rgb(250, 250, 255);
  border: 1px solid rgb(200, 200, 250);
}

.ace-tm .ace_indent-guide {
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAE0lEQVQImWP4////f4bLly//BwAmVgd1/w11/gAAAABJRU5ErkJggg==") right repeat-y;
}
</style><style>    .error_widget_wrapper {        background: inherit;        color: inherit;        border:none    }    .error_widget {        border-top: solid 2px;        border-bottom: solid 2px;        margin: 5px 0;        padding: 10px 40px;        white-space: pre-wrap;    }    .error_widget.ace_error, .error_widget_arrow.ace_error{        border-color: #ff5a5a    }    .error_widget.ace_warning, .error_widget_arrow.ace_warning{        border-color: #F1D817    }    .error_widget.ace_info, .error_widget_arrow.ace_info{        border-color: #5a5a5a    }    .error_widget.ace_ok, .error_widget_arrow.ace_ok{        border-color: #5aaa5a    }    .error_widget_arrow {        position: absolute;        border: solid 5px;        border-top-color: transparent!important;        border-right-color: transparent!important;        border-left-color: transparent!important;        top: -5px;    }</style><style id="vimMode">.normal-mode .ace_cursor{  border: 0!important;  background-color: red;  opacity: 0.5;}.ace_dialog {  position: absolute;  left: 0; right: 0;  background: white;  z-index: 15;  padding: .1em .8em;  overflow: hidden;  color: #333;}.ace_dialog-top {  border-bottom: 1px solid #eee;  top: 0;}.ace_dialog-bottom {  border-top: 1px solid #eee;  bottom: 0;}.ace_dialog input {  border: none;  outline: none;  background: transparent;  width: 20em;  color: inherit;  font-family: monospace;}</style><style id="incremental-occur-highlighting">.ace_occur-highlight {
    border-radius: 4px;
    background-color: rgba(87, 255, 8, 0.25);
    position: absolute;
    z-index: 4;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    box-shadow: 0 0 4px rgb(91, 255, 50);
}
.ace_dark .ace_occur-highlight {
    background-color: rgb(80, 140, 85);
    box-shadow: 0 0 4px rgb(60, 120, 70);
}
</style><style id="incremental-search-highlighting">.ace_marker-layer .ace_isearch-result {  position: absolute;  z-index: 6;  -moz-box-sizing: border-box;  -webkit-box-sizing: border-box;  box-sizing: border-box;}div.ace_isearch-result {  border-radius: 4px;  background-color: rgba(255, 200, 0, 0.5);  box-shadow: 0 0 4px rgb(255, 200, 0);}.ace_dark div.ace_isearch-result {  background-color: rgb(100, 110, 160);  box-shadow: 0 0 4px rgb(80, 90, 140);}</style><style>.ace_snippet-marker {    -moz-box-sizing: border-box;    box-sizing: border-box;    background: rgba(194, 193, 208, 0.09);    border: 1px dotted rgba(211, 208, 235, 0.62);    position: absolute;}</style><style>.ace_editor.ace_autocomplete .ace_marker-layer .ace_active-line {    background-color: #CAD6FA;    z-index: 1;}.ace_editor.ace_autocomplete .ace_line-hover {    border: 1px solid #abbffe;    margin-top: -1px;    background: rgba(233,233,253,0.4);}.ace_editor.ace_autocomplete .ace_line-hover {    position: absolute;    z-index: 2;}.ace_editor.ace_autocomplete .ace_scroller {   background: none;   border: none;   box-shadow: none;}.ace_rightAlignedText {    color: gray;    display: inline-block;    position: absolute;    right: 4px;    text-align: right;    z-index: -1;}.ace_editor.ace_autocomplete .ace_completion-highlight{    color: #000;    text-shadow: 0 0 0.01em;}.ace_editor.ace_autocomplete {    width: 280px;    z-index: 200000;    background: #fbfbfb;    color: #444;    border: 1px lightgray solid;    position: fixed;    box-shadow: 2px 3px 5px rgba(0,0,0,.2);    line-height: 1.4;}</style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1px; bottom: 2px; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style id="ace-earthsong">/* THIS THEME WAS AUTOGENERATED BY Theme.tmpl.css (UUID: def18d1f-ce25-72b7-34a3-565c0bcbc74e) */.ace-earthsong .ace_gutter {background: #e8e8e8;color: #333;}.ace-earthsong .ace_print-margin {width: 1px;background: #e8e8e8;}.ace-earthsong {background-color: #36312C;color: #EBD1B7;}.ace-earthsong .ace_cursor {color: #f8f8f0;}.ace-earthsong .ace_marker-layer .ace_selection {background: #DB784D;}.ace-earthsong.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px #36312C;border-radius: 2px;}.ace-earthsong .ace_marker-layer .ace_step {background: rgb(198, 219, 174);}.ace-earthsong .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid #3b3a32;}.ace-earthsong .ace_marker-layer .ace_active-line {background: #45403B;}.ace-earthsong .ace_gutter-active-line {background-color: #45403B;}.ace-earthsong .ace_marker-layer .ace_selected-word {border: 1px solid #DB784D;}.ace-earthsong .ace_fold {background-color: #60A365;border-color: #EBD1B7;}.ace-earthsong .ace_keyword{color:#DB784D;}.ace-earthsong .ace_keyword.ace_other.ace_unit{color:#95CC5E;}.ace-earthsong .ace_constant.ace_language{color:#DB784D;}.ace-earthsong .ace_constant.ace_numeric{color:#F8BB39;}.ace-earthsong .ace_constant.ace_character{color:#DB784D;}.ace-earthsong .ace_constant.ace_other{color:#DB784D;}.ace-earthsong .ace_support.ace_function{color:#95CC5E;}.ace-earthsong .ace_support.ace_constant{color:#DB784D;}.ace-earthsong .ace_support.ace_constant.ace_property-value{color:#F8BB39;}.ace-earthsong .ace_support.ace_class{font-style:italic;color:#DB784D;}.ace-earthsong .ace_support.ace_type{font-style:italic;color:#DB784D;}.ace-earthsong .ace_storage{color:#DB784D;}.ace-earthsong .ace_storage.ace_type{color:#95CC5E;}.ace-earthsong .ace_invalid{color:#f8f8f0;background-color:#00a8c6;}.ace-earthsong .ace_invalid.ace_deprecated{color:#f8f8f0;background-color:#00a8c6;}.ace-earthsong .ace_string{color:#F8BB39;}.ace-earthsong .ace_comment{color:#7A7267;}.ace-earthsong .ace_variable{color:#60A365;}.ace-earthsong .ace_variable.ace_parameter{font-style:italic;}.ace-earthsong .ace_entity.ace_other.ace_attribute-name{color:#DB784D;}.ace-earthsong .ace_entity.ace_name.ace_function{color:#60A365;}.ace-earthsong .ace_entity.ace_name.ace_tag{color:#95CC5E;}</style></head>

    <body class="slim-scroll ltr mac"><div style="display: none;" id="MathJax_Message"></div>


    
<div id="readme" platform-related="">
# Welcome to Marxico

@(Sample notebook)[Marxico|Manual|Markdown]

**Marxico** is a delicate Markdown editor for Evernote. With reliable 
storage and sync powered by Evernote, **Marxico** offers greate writing 
experience. 

- **Versatile** - supporting code highlight, *LaTeX* &amp; flow charts, 
 inserting images &amp; attachments by all means.
- **Exquisite** -  neat but powerful editor, featuring offline docs, 
live preview, and offering the [desktop client][1] and offline [Chrome 
App][2].
- **Sophisticated** - deeply integrated with Evernote, supporting 
notebook &amp; tags, two-way bind editing.   

----------

[TOC]

## Introducing Markdown

&gt; Markdown is a plain text formatting syntax designed to be converted
 to HTML. Markdown is popularly used as format for readme files, ... or 
in text editors for the quick creation of rich text documents.  - 
[Wikipedia](http://en.wikipedia.org/wiki/Markdown)

As showed in this manual, it uses hash(#) to identify headings, 
emphasizes some text to be **bold** or *italic*. You can insert a 
[link](http://www.example.com) , or a footnote[^demo]. Serveral advanced
 syntax are listed below, please press `Cmd + /` to view Markdown 
cheatsheet.

### Code block
``` python
@requires_authorization
def somefunc(param1='', param2=0):
    '''A docstring'''
    if param1 &gt; param2: # interesting
        print 'Greater'
    return (param2 - param1 + 1) or None
class SomeClass:
    pass
&gt;&gt;&gt; message = '''interpreter
... prompt'''
```

### LaTeX expression
$$	x = \dfrac{-b \pm \sqrt{b^2 - 4ac}}{2a} $$

### Table
| Item      |    Value | Qty  |
| :-------- | --------:| :--: |
| Computer  | 1600 USD |  5   |
| Phone     |   12 USD |  12  |
| Pipe      |    1 USD | 234  |

### Diagrams
#### Flow charts
```flow
st=&gt;start: Start
e=&gt;end
op=&gt;operation: My Operation
cond=&gt;condition: Yes or No?

st-&gt;op-&gt;cond
cond(yes)-&gt;e
cond(no)-&gt;op
```
#### Sequence diagrams 
```sequence
Alice-&gt;Bob: Hello Bob, how are you?
Note right of Bob: Bob thinks
Bob--&gt;Alice: I am good thanks!
```

&gt; **Note:** You can find more information:

&gt; - about **Sequence diagrams** syntax [here][3],
&gt; - about **Flow charts** syntax [here][4].

### Checkbox
You can use `- [ ]` and `- [x]` to create checkboxes, for example:

- [x] Item1
- [ ] Item2
- [ ] Item3

&gt; **Note:** Currently it is only partially supported. You can't 
toggle checkboxes in Evernote. You can only modify the Markdown in 
Marxico to do that. Next version will fix this.  


### Dancing with Evernote

#### Notebook &amp; Tags
**Marxico** add `@(Notebook)[tag1|tag2|tag3]` syntax to select notebook 
and set tags for the note. After typing `@(`, the notebook list would 
appear, please select one from it.  

#### Title
**Marxico** would adopt the first heading encountered as the note title.
 For example, in this manual the first line `Welcome to Marxico` is the 
title.

#### Quick Editing
Note saved by **Marxico** in Evernote would have a red ribbon button on 
the top-right corner. Click it and it would bring you back to 
**Marxico** to edit the note. 

&gt; **Note:** Currently **Marxico** is unable to detect and merge any 
modifications in Evernote by user. Please go back to **Marxico** to 
edit.

#### Data Synchronization
While saving rich HTML content in Evernote, **Marxico** puts the 
Markdown text in a hidden area of the note, which makes it possible to 
get the original text in **Marxico** and edit it again. This is a really
 brilliant design because:

- it is beyond just one-way exporting HTML which other services do;
- and it avoids privacy and security problems caused by storing content 
in a intermediate server. 

&gt; **Privacy Statement: All of your notes data are saved in Evernote. 
Marxico doesn't save any of them.** 

#### Offline Storage
**Marxico** stores your unsynchronized content locally in browser 
storage, so no worries about network and broswer crash. It also keeps 
the recent file list you've edited in `Document Management(Cmd + O)`.

&gt; **Note:** Opthough browser storage is reliable in the most time, 
Evernote is born to do that. So please sync the document regularly while
 writing.

## Shortcuts
Help    `Cmd + /`
Sync Doc    `Cmd + S`
Create Doc    `Cmd + Opt + N`
Maximize Editor    `Cmd + Enter`
Preview Doc `Cmd + Opt + Enter`
Doc Management    `Cmd + O`
Menu    `Cmd + M`

Bold    `Cmd + B`
Insert Image    `Cmd + G`
Insert Link    `Cmd + L`
Convert Heading    `Cmd + H`

## About Pro
**Marixo** offers a free trial of 10 days. After that, you need to 
[purchase](http://marxi.co/purchase.html) the Pro service. Otherwise, 
you would not be able to sync new notes. Previous notes can be edited 
and synced all the time.

## Credits
**Marxico** was first built upon [Dillinger][5], and the newest version 
is almost based on the awesome [StackEdit][6]. Acknowledgments to them 
and other incredible open source projects!

## Feedback &amp; Bug Report
- Twitter: [@gock2][7]
- Email: &lt;hustgock@gmail.com&gt;

----------
Thank you for reading this manual. Now please press `Cmd + M` and click 
`Link with Evernote`. Enjoy your **Marxico** journey!


[^demo]: This is a demo footnote. Read the [MultiMarkdown Syntax 
Guide](https://github.com/fletcher/MultiMarkdown/wiki/MultiMarkdown-Syntax-Guide#footnotes)
 to learn more. Note that Evernote disables ID attributes in its notes ,
 so `footnote` and `TOC` are not actually working. 

  [1]: http://marxi.co/client_en
  [2]: 
https://chrome.google.com/webstore/detail/kidnkfckhbdkfgbicccmdggmpgogehop

  [3]: http://bramp.github.io/js-sequence-diagrams/
  [4]: http://adrai.github.io/flowchart.js/
  [5]: http://dillinger.io
  [6]: http://stackedit.io
  [7]: https://twitter.com/gock2

</div>
<div id="images_area"><img type="image/png" longdesc="./emulator.png" lazysrc="blob:http://marxi.co/67dce4e8-f5b3-da42-a9ad-86c0ad3d7665"></div>
<div style="transform: translate(-385px, 0px); width: 1585px; height: 678px;" class="layout-wrapper-l1">
    <div style="left: 385px; width: 1200px; height: 678px;" class="layout-wrapper-l2 full-preview" id="app_wrap">
        <div class="navbar navbar-default" style="display:none">
            <div class="navbar-inner">
                <div class="nav left-space"></div>
                <div class="nav right-space pull-right"></div>
                <div class="buttons-dropdown dropdown hide">
                    <div class="nav">
                        <button class="btn btn-success" data-toggle="dropdown" title="Show buttons">
                            <i class="icon-th-large"></i>
                        </button>
                        <div class="dropdown-menu">
                        </div>
                    </div>
                </div>
                
                
                
                
                
                
                <ul class="nav pull-right right-buttons">
                    <li class="offline-status hide">
                    <div class="text-danger">
                        <i class="icon-attention-circled"></i>offline
                    </div>
                    </li>
                    <li class="extension-buttons"></li>
                </ul><ul class="nav left-buttons">
                    <li class="wmd-button-group1 btn-group"><li title="Strong &lt;strong&gt; Ctrl/Cmd+B" id="wmd-bold-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: 0px 0px; display: none;"></span><i class="icon-bold"></i></li></li>
                </ul><ul class="nav left-buttons">
                    <li class="wmd-button-group2 btn-group"><li title="Hyperlink &lt;a&gt; Ctrl/Cmd+L" id="wmd-link-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -40px 0px; display: none;"></span><i class="icon-globe"></i></li><li title="Blockquote &lt;blockquote&gt;" id="wmd-quote-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -60px 0px; display: none;"></span><i class="icon-indent-right"></i></li><li title="Code Sample &lt;pre&gt;&lt;code&gt; Ctrl/Cmd+K" id="wmd-code-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -80px 0px; display: none;"></span><i class="icon-code"></i></li></li>
                </ul><ul class="nav left-buttons">
                    <li class="wmd-button-group3 btn-group"><li title="Heading &lt;h1&gt;/&lt;h2&gt; Ctrl/Cmd+H" id="wmd-heading-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -160px 0px; display: none;"></span><i class="icon-text-height"></i></li><li title="Horizontal Rule &lt;hr&gt; Ctrl/Cmd+R" id="wmd-hr-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -180px 0px; display: none;"></span><i class="icon-ellipsis"></i></li></li>
                </ul><ul class="nav left-buttons">
                    <li class="wmd-button-group5 btn-group"></li>
                </ul><ul class="nav left-buttons">
                    <li class="wmd-button-group4 btn-group">
                    <a class="btn btn-success button-open-discussion" title="Comments Ctrl/Cmd+M"><i class="icon-comment-alt"></i></a>
                    </li>
                </ul><ul class="nav pull-right title-container">
                    <li><div class="working-indicator"></div></li>
                    <li><a style="max-width: 318px;" class="btn btn-success file-title-navbar" href="#" title="Rename document"> </a></li>
                    <li><div class="input-file-title-container"><input style="max-width: 318px;" class="col-sm-4 form-control hide input-file-title" placeholder="Document title" type="text"></div></li>
                </ul>
            </div>
        </div>

        <div class="sync-ace-theme ace-earthsong">
            <div class="ace_string ace_constant ace_numeric">
                <button data-original-title="Select document" class="btn open-folder-btn" title="">
                    <i class="icon-book"></i>
                </button>
            </div>
        </div>
        <div class="editor-navbar sync-ace-theme ace-earthsong">
            <div class="editor-navbar-bg sync-ace-theme ace-earthsong"></div>
            <div class="navbar-inner ace_string ace_constant ace_numeric ">
    
                <div class="editor-navbar-buttons">
                    <span class="toolbar-group">
                        <div class="wmd-buttons-group">
                            <ul class="nav wmd-button-group1 wmd-button-group3  wmd-button-group2 wmd-button-group4 btn-group"><li data-original-title="Strong &lt;strong&gt; Ctrl/Cmd+B" title="" id="wmd-bold-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: 0px 0px; display: none;"></span><i class="icon-bold"></i></li><li data-original-title="Hyperlink &lt;a&gt; Ctrl/Cmd+L" title="" id="wmd-link-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -40px 0px; display: none;"></span><i class="icon-globe"></i></li><li data-original-title="Blockquote &lt;blockquote&gt;" title="" id="wmd-quote-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -60px 0px; display: none;"></span><i class="icon-indent-right"></i></li><li data-original-title="Code Sample &lt;pre&gt;&lt;code&gt; Ctrl/Cmd+K" title="" id="wmd-code-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -80px 0px; display: none;"></span><i class="icon-code"></i></li><li data-original-title="Heading &lt;h1&gt;/&lt;h2&gt; Ctrl/Cmd+H" title="" id="wmd-heading-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -160px 0px; display: none;"></span><i class="icon-text-height"></i></li><li data-original-title="Horizontal Rule &lt;hr&gt; Ctrl/Cmd+R" title="" id="wmd-hr-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -180px 0px; display: none;"></span><i class="icon-ellipsis"></i></li></ul>
                            <ul class="nav image-button-group btn-group"><li data-original-title="Image &lt;img&gt; Ctrl/Cmd+G" title="" id="wmd-image-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -100px 0px; display: none;"></span><i class="icon-picture"></i></li></ul>
                        </div>
                        <div class="editor-hosted-buttons"><!--<button
                    class="btn btn-success action-create-file" title='Markdown syntax' vine-click='SHOW_HELP'>
                    <i class="icon-help-circled"></i>
                </button>-->
                            <button data-original-title="Editor theme" class="btn btn-success dropdown-toggle" title="" id="theme-button" data-toggle="dropdown">
                                <i class="icon-magic"></i>
                            </button>
                            <ul id="theme-list" class="dropdown-menu ui" role="menu" aria-labelledby="drop6">
                                <li><a tabindex="-1" href="#" data-value="ace/theme/default">Default</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/active4d">Active4d</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/all_hallows_eve">All Hallows Eve</a></li>
                                <!-- <li><a tabindex="-1" href="#" data-value="ace/theme/ambiance">Ambiance</a></li> -->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/amy">Amy</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/arstotzka">Arstotzka</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/azure">Azure</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/blackboard">Blackboard</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/bold">Bold</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/boxuk">Boxuk</a></li>
                                <!-- <li><a tabindex="-1" href="#" data-value="ace/theme/brilliance_black">Brilliance Black</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/brilliance_dull">Brilliance Dull</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/carbonight">Carbonight</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/carbonight_contrast">Carbonight Contrast</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/chaos">Chaos</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/chocolate">Chocolate</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/chrome">Chrome</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/chrome_devtools">Chrome Devtools</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/clouds">Clouds</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/clouds_midnight">Clouds Midnight</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/cobalt">Cobalt</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/crimson_editor">Crimson Editor</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/crisp">Crisp</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/darkside">Darkside</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/darkside_contrast">Darkside Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/dawn">Dawn</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/dreamweaver">Dreamweaver</a></li>
                                <li><a class="selected" tabindex="-1" href="#" data-value="ace/theme/earthsong">Earthsong</a></li>
                                <!-- <li><a tabindex="-1" href="#" data-value="ace/theme/earthsong_contrast">Earthsong Contrast</a></li>-->
                                <!-- <li><a tabindex="-1" href="#" data-value="ace/theme/earthsong_light">Earthsong Light</a></li>-->
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/eclipse">Eclipse</a></li>-->
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/eiffel">Eiffel</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/espresso_libre">Espresso Libre</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/freshcut">Freshcut</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/freshcut_contrast">Freshcut Contrast</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/frontier">Frontier</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/frontier_contrast">Frontier Contrast</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/github">Github</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/gloom">Gloom</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/gloom_contrast">Gloom Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/glowfish">Glowfish</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/glowfish_contrast">Glowfish Contrast</a></li>-->
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/goldfish">Goldfish</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/goldfish_contrast">Goldfish Contrast</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/grunge">Grunge</a></li>-->
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/grunge_contrast">Grunge Contrast</a></li>-->
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/halflife">Halflife</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/halflife_contrast">Halflife Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/heroku">Heroku</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/hyrule">Hyrule</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/hyrule_contrast">Hyrule Contrast</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/iceberg">Iceberg</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/iceberg_contrast">Iceberg Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/idle">Idle</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/idle_fingers">Idle Fingers</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/idlefingers">Idlefingers</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/iplastic">Iplastic</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/juicy">Juicy</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/juicy_contrast">Juicy Contrast</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/katzenmilch">Katzenmilch</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/keen">Keen</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/keen_contrast">Keen Contrast</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/kiwi">Kiwi</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/kr_theme">Kr Theme</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/krtheme">Krtheme</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/kuroir">Kuroir</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/laravel">Laravel</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/laravel_contrast">Laravel Contrast</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/lavender">Lavender</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/lavender_contrast">Lavender Contrast</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/lazy">Lazy</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/legacy">Legacy</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/magicwb_(amiga)">Magicwb (Amiga)</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/mellow">Mellow</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/mellow_contrast">Mellow Contrast</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/merbivore">Merbivore</a></li>-->
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/merbivore_soft">Merbivore Soft</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/mintchoc">Mintchoc</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/mono_industrial">Mono Industrial</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/monoindustrial">Monoindustrial</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/monokai">Monokai</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/mud">Mud</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/mud_contrast">Mud Contrast</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/otakon">Otakon</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/pastel">Pastel</a></li>
                                <!--
 <li><a tabindex="-1" href="#" data-value="ace/theme/pastel_on_dark">Pastel On Dark</a></li>
 <li><a tabindex="-1" href="#" data-value="ace/theme/pastels_on_dark">Pastels On Dark</a></li>
 <li><a tabindex="-1" href="#" data-value="ace/theme/patriot">Patriot</a></li>
 <li><a tabindex="-1" href="#" data-value="ace/theme/patriot_contrast">Patriot Contrast</a></li>
 -->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/peacock">Peacock</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/peacock_contrast">Peacock Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/peacocks_in_space">Peacocks In Space</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/peel">Peel</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/piggy">Piggy</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/potpourri">Potpourri</a></li>
 <li><a tabindex="-1" href="#" data-value="ace/theme/potpourri_contrast">Potpourri Contrast</a></li>
 -->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/rainbow">Rainbow</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/revelation">Revelation</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/revelation_contrast">Revelation Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/shrek">Shrek</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/slate">Slate</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/slime">Slime</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/slime_contrast">Slime Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/slush_and_poppies">Slush And Poppies</a></li>
                                <!--
 <li><a tabindex="-1" href="#" data-value="ace/theme/snappy">Snappy</a></li>
 <li><a tabindex="-1" href="#" data-value="ace/theme/snappy_contrast">Snappy Contrast</a></li>
 <li><a tabindex="-1" href="#" data-value="ace/theme/snappy_light">Snappy Light</a></li>
 <li><a tabindex="-1" href="#" data-value="ace/theme/solarflare">Solarflare</a></li>
 -->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/solarflare_contrast">Solarflare Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/solarized_dark">Solarized Dark</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/solarized_light">Solarized Light</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/sourlick">Sourlick</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/sourlick_contrast">Sourlick Contrast</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/spacecadet">Spacecadet</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/spearmint">Spearmint</a></li>
                                <!--
 <li><a tabindex="-1" href="#" data-value="ace/theme/stark">Stark</a></li>
 <li><a tabindex="-1" href="#" data-value="ace/theme/stark_contrast">Stark Contrast</a></li>
 -->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/sunburst">Sunburst</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/super">Super</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/terminal">Terminal</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/textmate">Textmate</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/textmate_(mac_classic)">Textmate (Mac Classic)</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/tomorrow">Tomorrow</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/tomorrow_night">Tomorrow Night</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/tomorrow_night_blue">Tomorrow Night Blue</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/tomorrow_night_bright">Tomorrow Night Bright</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/tomorrow_night_eighties">Tomorrow Night Eighties</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/tonic">Tonic</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/tribal">Tribal</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/tron">Tron</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/tron_contrast">Tron Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/turnip">Turnip</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/turnip_contrast">Turnip Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/twilight">Twilight</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/userscape">Userscape</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/vibrant_ink">Vibrant Ink</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/xcode">Xcode</a></li>
                                <!--<li><a tabindex="-1" href="#" data-value="ace/theme/xcode_default">Xcode Default</a></li>-->
                                <li><a tabindex="-1" href="#" data-value="ace/theme/yule">Yule</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/zacks">Zacks</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/zacks_contrast">Zacks Contrast</a></li>
                                <li><a tabindex="-1" href="#" data-value="ace/theme/zenburnesque">Zenburnesque</a></li>

                            </ul>
                            <button data-original-title="Toggle resize" class="btn btn-success full-editor-btn open" title="" vine-click="TOGGLE_RESIZE">
                                <i class="icon-resize-full"></i>
                                <i class="icon-resize-small-1"></i>
                            </button>
                        </div>
                    </span>
                </div>


            </div>

        </div>


        <div class="preview-buttons-container">
            <div class="preview-buttons">
                <button title="" data-original-title="" class="btn btn-success dropdown-toggle save-file" data-toggle="dropdown" id="indicator-file-status" vine-switch-on="FILE_STATUS_CHANGED" vine-click="SYNC_FILE">
                    <i style="display: none;" class="icon-flash" tooltip-title="Local draft. Click to sync.&quot;" switch-when="created"></i>
                    <i style="display: none;" class="icon-asterisk " tooltip-title="Have changes. Click to sync." switch-when="modified"></i>
                    <i style="display: none;" class="icon-spin6 animate-spin" tooltip-title="Syncing" switch-when="syncing"></i>
                    <i style="display: inline-block;" class="icon-ok" tooltip-title="Synced" switch-when="synced"></i>
                </button>

                <button data-original-title="Readonly mode" class="btn btn-success dropdown-toggle file-status-lock disabled" title="">
                    <i class="icon-lock"></i>
                </button>
                <button data-original-title="New document" class="btn btn-success action-create-file" title="" vine-click="CREATE_FILE">
                    <i class="icon-doc"></i>
                </button>

                <custom vine-switch-on="IS_USER_AUTHED">
                <button data-original-title="Profile" style="display: inline-block;" class="btn profile-btn btn-success" title="" switch-when="true">
                    <i class="icon-user"></i>
                </button>
                <button data-original-title="Profile" style="display: none;" class="btn profile-btn" title="" switch-when="false">
                    <i class="icon-evernote"></i>
                </button>
                </custom>
            </div>
        </div>


        <div style="top: 0px; width: 1200px; height: 678px;" class="layout-wrapper-l3">
            <pre style="width: 600px; height: 678px;" id="wmd-input" class="form-control editor font-rich ace-earthsong ace_dark"><div style="padding: 40px 35px 618px;" class="editor-content" contenteditable="true"><span class="wmd-input-section" id="wmd-input-section-1"></span><span class="wmd-input-section" id="wmd-input-section-2"><span class="token h1 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">#</span> Study on Emulator</span><span class="token lf">
</span><span class="token p"><span class="token md md-toc">[toc]</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-3"><span class="token h2 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">##</span> Prefix</span><span class="token lf">
</span><span class="token p">The study focuses on the branch <span class="token code ace_support ace_function"><span class="token md md-code">`</span>emu-master-dev<span class="token md md-code">`</span></span> implementation of the <span class="token em"><span class="token md md-em md-start">*</span>classic<span class="token md md-em md-close">*</span></span> Android emulator, in combination of gonk layer and kernel used in <span class="token code ace_support ace_function"><span class="token md md-code">`</span>emulator-x86-kk<span class="token md md-code">`</span></span>. Mozilla's customization is not a main focus in this document, but might still be referred.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-4"><span class="token h2 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">##</span> Build &amp; Run Emulator</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-5"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Classic and QEMU2 Emulator</span><span class="token lf">
</span><span class="token p">The original emulator was based on QEMU 0.10.5 around 2009. There's a new project based on QEMU 2.2.0 for Android M or later. Therefore, the legacy emulator is referred as <span class="token em"><span class="token md md-em md-start">*</span>classic<span class="token md md-em md-close">*</span></span> emulator while the new emulator is referred as <span class="token em"><span class="token md md-em md-start">*</span>qemu2<span class="token md md-em md-close">*</span></span> emulator.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">To summary, here's the comparison.</span><span class="token lf">
</span><span class="token table">| --------------------------- | classic            | qemu2         |<span class="token lf">
</span>| --------------------------- | ------------------ | ------------- |<span class="token lf">
</span>| QEMU Version                | 0.10.5             | 2.2.0         |<span class="token lf">
</span>| Since                       | ~2009              | ~2014         |<span class="token lf">
</span>| Virtual Platform            | Goldfish           | Ranchu        |<span class="token lf">
</span>| Compatible Android Versions | Cupcake ~ Lollipop | M ~           |<span class="token lf">
</span>| Support Emulation Arch      | x86, arm, mips     | arm64, mips64 |<span class="token lf">
</span><span class="token lf">
</span></span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-6"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Build Emulator</span><span class="token lf">
</span><span class="token p">Get the latest dev branch source code:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-7"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>bash<span class="token lf">
</span>$ mkdir emu-master-dev &amp;&amp; cd emu-master-dev<span class="token lf">
</span>$ repo init -u https://android.googlesource.com/platform/manifest -b emu-master-dev<span class="token lf">
</span>$ repo sync<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Use the build script to build <span class="token em"><span class="token md md-em md-start">*</span>classic<span class="token md md-em md-close">*</span></span> and <span class="token em"><span class="token md md-em md-start">*</span>qemu2<span class="token md md-em md-close">*</span></span> emulators:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-8"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>bash<span class="token lf">
</span>$ cd external/qemu<span class="token lf">
</span>$ ./android-rebuild.sh --build-qemu-android<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>To build with the experimental Qt GUI, pass <span class="token code ace_support ace_function"><span class="token md md-code">`</span>--ui=qt<span class="token md md-code">`</span></span>. The default is SDL2.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-9"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Emulator Binaries</span><span class="token lf">
</span><span class="token p"><span class="token img"><span class="token md md-bang">!</span><span class="token md md-bracket-start">[</span><span class="token md md-alt">Alt text</span><span class="token md md-bracket-end">]</span><span class="token md img-parens"><span class="token md md-paren-start">(</span><span class="token md md-src">./emulator.png</span><span class="token md md-paren-end">)</span></span></span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token li"><span class="token md md-li">- </span><span class="token strong ace_keyword ace_strong"><span class="token md md-strong">**</span>emulator<span class="token md md-strong">**</span></span> - front-end used to find proper emulation engine and setup environment variables (mainly <span class="token code ace_support ace_function"><span class="token md md-code">`</span>LD_LIBRARY_PATH<span class="token md md-code">`</span></span>).<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span><span class="token strong ace_keyword ace_strong"><span class="token md md-strong">**</span>green nodes<span class="token md md-strong">**</span></span> - classic emulation engines.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span><span class="token strong ace_keyword ace_strong"><span class="token md md-strong">**</span>blue nodes<span class="token md md-strong">**</span></span> - qemu2 emulation engines.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span><span class="token strong ace_keyword ace_strong"><span class="token md md-strong">**</span>orange nodes<span class="token md md-strong">**</span></span> - GLES / EGL emulation libraries.<span class="token lf">
</span><span class="token lf">
</span></span></span><span class="wmd-input-section" id="wmd-input-section-10"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Launch Emulator from AOSP / B2G Tree</span><span class="token lf">
</span><span class="token p">Besides using AVD or passing everything through the command line arguments, emulator is capable of finding images from the built AOSP / B2G tree directly if you have proper environment variables set. Here's an example:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-11"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>bash<span class="token lf">
</span># In ${B2G} or ${AOSP}<span class="token lf">
</span>$ export ANDROID_BUILD_TOP=${PWD}<span class="token lf">
</span>$ export ANDROID_PRODUCT_OUT=${PWD}/out/target/product/generic_x86/<span class="token lf">
</span>$ ./out/host/darwin-x86/bin/emulator -gpu on <span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">If the emulator doesn't boot, try deleting <span class="token code ace_support ace_function"><span class="token md md-code">`</span>${ANDROID_PRODUCT_OUT}/userdata-qemu.img<span class="token md md-code">`</span></span> first. Note that <span class="token code ace_support ace_function"><span class="token md md-code">`</span>-gpu on<span class="token md md-code">`</span></span> is necessary for B2G. </span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">To show kernel message, use <span class="token code ace_support ace_function"><span class="token md md-code">`</span>-show-kernel<span class="token md md-code">`</span></span>. The message is redirected through the emulated system's <span class="token code ace_support ace_function"><span class="token md md-code">`</span>ttyS0<span class="token md md-code">`</span></span> or <span class="token code ace_support ace_function"><span class="token md md-code">`</span>ttyGF0<span class="token md md-code">`</span></span> (goldfish tty).</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">For older emulator builds, qemu monitor can be redirected to stdio through <span class="token code ace_support ace_function"><span class="token md md-code">`</span>-qemu -monitor stdio<span class="token md md-code">`</span></span>, but it's no longer support in newer code. See <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">console.c</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/console.c#L2601</span><span class="token md md-paren-end">)</span></span>.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-12"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Use Writable System Image</span><span class="token lf">
</span><span class="token p">By default, <span class="token code ace_support ace_function"><span class="token md md-code">`</span>system.img<span class="token md md-code">`</span></span> and <span class="token code ace_support ace_function"><span class="token md md-code">`</span>userdata.img<span class="token md md-code">`</span></span> are read only init images, while <span class="token code ace_support ace_function"><span class="token md md-code">`</span>system-qemu.img<span class="token md md-code">`</span></span> and <span class="token code ace_support ace_function"><span class="token md md-code">`</span>userdata-qemu.img<span class="token md md-code">`</span></span> are writable. See <span class="token code ace_support ace_function"><span class="token md md-code">`</span>emulator -help-disk-images<span class="token md md-code">`</span></span> for more information.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">In usual case, a writable image is created under <span class="token code ace_support ace_function"><span class="token md md-code">`</span>/tmp/android-xxx/<span class="token md md-code">`</span></span>. To use a writable system image on boot directly, simply move <span class="token code ace_support ace_function"><span class="token md md-code">`</span>${ANDROID_PRODUCT_OUT}/system.img<span class="token md md-code">`</span></span> to <span class="token code ace_support ace_function"><span class="token md md-code">`</span>${ANDROID_PRODUCT_OUT}/system-qemu.img<span class="token md md-code">`</span></span>.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>The emulator version used in emulator-x86-kk has a bug and it complains <span class="token code ace_support ace_function"><span class="token md md-code">`</span>ko:Missing initial system image path!<span class="token md md-code">`</span></span> when using <span class="token code ace_support ace_function"><span class="token md md-code">`</span>system-qemu.img<span class="token md md-code">`</span></span>. It's fixed in newer versions.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-13"><span class="token h2 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">##</span> Emulator Initialization</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p"><span class="token em"><span class="token md md-em md-start">*</span>android/main-emulator.c:main<span class="token md md-em md-close">*</span></span></span><span class="token lf">
</span><span class="token p">It all starts with the front-end binary <span class="token code ace_support ace_function"><span class="token md md-code">`</span>emulator<span class="token md md-code">`</span></span> at [main-emulator.c]((<span class="token url">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/main-emulator.c#L87)</span> ). It's checks whether it should launch a 32 or 64 bits emulation engine, what emulation architecture it should pick, and setup necessary environment variables such as <span class="token code ace_support ace_function"><span class="token md md-code">`</span>LD_LIBRARY_PATH<span class="token md md-code">`</span></span>.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p"><span class="token em"><span class="token md md-em md-start">*</span>android/main.c:main<span class="token md md-em md-close">*</span></span></span><span class="token lf">
</span><span class="token p">The main function of an emulation engine binary is at <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">main.c</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/main.c#L171</span><span class="token md md-paren-end">)</span></span>. The main function setups UI skin window (with SDL2 or Qt5), parses the given AVD and auto-config for missing properties. Eventually it generates a full list of final hardware configuration at <span class="token code ace_support ace_function"><span class="token md md-code">`</span>hardware-qemu.ini<span class="token md md-code">`</span></span>, and pass the final configuration to another core main function at <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">vl-android.c</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/vl-android.c#L2144</span><span class="token md md-paren-end">)</span></span>. The core main function is redefined as <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemu_main</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/vl-android.c#L234</span><span class="token md md-paren-end">)</span></span> at compiling.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>Although skin window is setup here, nothing is shown on screen, even the window itself, until <span class="token code ace_support ace_function"><span class="token md md-code">`</span>qemu_main<span class="token md md-code">`</span></span> finishes machine setup and trigger the skin window to start working.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p"><span class="token em"><span class="token md md-em md-start">*</span>vl-android.c:main<span class="token md md-em md-close">*</span></span></span><span class="token lf">
</span><span class="token p"><span class="token code ace_support ace_function"><span class="token md md-code">`</span>qemu_main<span class="token md md-code">`</span></span> is the most interesting part of the initialization. It takes care of initializing all virtual hardware, as well as some android specific services defined in <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">android<span class="token em"><span class="token md md-em md-start">_</span>emulation<span class="token md md-em md-close">_</span></span>setup()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/qemu-setup.c#L229</span><span class="token md md-paren-end">)</span></span> -- mainly the telnet console and adb support. Most importantly, it starts the <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">main loop</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/main-loop.c#L311</span><span class="token md md-paren-end">)</span></span>, which is the core of all I/O handling in QEMU. </span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">The main loop runs on main thread when using SDL2, on the other hand, since Qt has its own event loop and must run on main thread, the QEMU main loop has to be run in a background thread when using Qt.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-14"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Machine Initialization</span><span class="token lf">
</span><span class="token p">In order to initialize proper platform on different emulation engine, each CPU-specific emulation engine (e.g. <span class="token code ace_support ace_function"><span class="token md md-code">`</span>emulator64-x86<span class="token md md-code">`</span></span>) registers its emulated machines statically through <span class="token code ace_support ace_function"><span class="token md md-code">`</span>machine_init<span class="token md md-code">`</span></span> statement. </span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">The macro generates a function to register a machine with gcc special attribute <span class="token code ace_support ace_function"><span class="token md md-code">`</span> __attribute__((constructor))<span class="token md md-code">`</span></span>, which conceptually resembles static constructor in modern languages, and is invoked when the program loads.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token li"><span class="token md md-li">- </span><span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">x86 machine registration</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/i386/pc.c#L1332</span><span class="token md md-paren-end">)</span></span><span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span><span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">arm machine registration</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/android_arm.c#L159</span><span class="token md md-paren-end">)</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="token p">Later in <span class="token code ace_support ace_function"><span class="token md md-code">`</span>qemu_main<span class="token md md-code">`</span></span>, it invokes <span class="token code ace_support ace_function"><span class="token md md-code">`</span>module_call_init(MODULE_INIT_MACHINE)<span class="token md md-code">`</span></span>, which triggers the registered machine initialization function to initialize the platform.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Refer <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">machine_init()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/qemu/module.h#L34</span><span class="token md md-paren-end">)</span></span>, <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">module_init()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/qemu/module.h#L18-L21</span><span class="token md md-paren-end">)</span></span>, <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">register<span class="token em"><span class="token md md-em md-start">_</span>module<span class="token md md-em md-close">_</span></span>init()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/util/module.c#L58-L69</span><span class="token md md-paren-end">)</span></span>, and <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">QEMUMachine</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/hw/boards.h#L15-L23</span><span class="token md md-paren-end">)</span></span>.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-15"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> The Main Loop</span><span class="token lf">
</span><span class="token p">The core of qemu is designed to be event driven (although worker threads are also used in some cases) by using an event loop. Quote the description from <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">QEMU Internals: Overall architecture and threading model</span><span class="token md md-bracket-end">](</span><span class="token md md-href">http://blog.vmsplice.net/2011/03/qemu-internals-overall-architecture-and.html</span><span class="token md md-paren-end">)</span></span>: </span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">*QEMU's main event loop is <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">main<span class="token em"><span class="token md md-em md-start">_</span>loop<span class="token md md-em md-close">_</span></span>wait()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/main-loop.c#L262</span><span class="token md md-paren-end">)</span></span> and it performs the following tasks:*</span><span class="token lf">
</span><span class="token lf">
</span><span class="token li"><span class="token md md-li">1. </span><span class="token em"><span class="token md md-em md-start">*</span>Waits for file descriptors to become readable or writable. File descriptors play a critical role because files, sockets, pipes, and various other resources are all file descriptors. File descriptors can be added using qemu_set_fd_handler().<span class="token md md-em md-close">*</span></span><span class="token lf">
</span></span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>In Android emulator, the main loop also <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">polls charpipe</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/main-loop.c#L299</span><span class="token md md-paren-end">)</span></span> right after file descriptors which will be explained later.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token li"><span class="token md md-li">2. </span><span class="token em"><span class="token md md-em md-start">*</span>Runs expired timers. Timers can be added using qemu_mod_timer().<span class="token md md-em md-close">*</span></span><span class="token lf">
</span></span><span class="token li"><span class="token md md-li">3. </span><span class="token em"><span class="token md md-em md-start">*</span>Runs bottom-halves (BHs), which are like timers that expire immediately. BHs are used to avoid reentrancy and overflowing the call stack. BHs can be added using qemu_bh_schedule().<span class="token md md-em md-close">*</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="token p">The term <span class="token em"><span class="token md md-em md-start">*</span>bottom half<span class="token md md-em md-close">*</span></span> mentioned above comes from the concept of <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">Linux Device Driver</span><span class="token md md-bracket-end">](</span><span class="token md md-href">http://www.makelinux.net/ldd3/chp-10-sect-4</span><span class="token md md-paren-end">)</span></span>, where interrupt handlers can choose to delay lengthy works later. In QEMU, this applies to event / timer handlers instead. Those handlers can schedule bottom halves to do some jobs later, and since executing bottom halves is the last step of an event loop, bottom halves are done in the same event loop as where they were scheduled. </span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-16"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>flow<span class="token lf">
</span>timeout=&gt;operation: select(rfd, timer)<span class="token lf">
</span>iopoll=&gt;operation: qemu_iohandler_poll<span class="token lf">
</span>pipepoll=&gt;operation: charpipe_poll<span class="token lf">
</span>timerpoll=&gt;operation: qemu_clock_run_all_timers<span class="token lf">
</span>alarm=&gt;operation: qemu_run_alarm_timer<span class="token lf">
</span>bhpoll=&gt;operation: qemu_bh_poll<span class="token lf">
</span><span class="token lf">
</span>timeout-&gt;iopoll<span class="token lf">
</span>iopoll-&gt;pipepoll<span class="token lf">
</span>pipepoll-&gt;timerpoll<span class="token lf">
</span>timerpoll-&gt;bhpoll<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>The main loop is often referred as iothread. If you're interested at QEMU's threading and event handling, check <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">Improving the QEMU Event Loop</span><span class="token md md-bracket-end">](</span><span class="token md md-href">http://events.linuxfoundation.org/sites/events/files/slides/Improving%20the%20QEMU%20Event%20Loop%20-%203.pdf</span><span class="token md md-paren-end">)</span></span> from KVM Forum 2015.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-17"><span class="token h2 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">##</span> Skin &amp; UI Handling</span><span class="token lf">
</span><span class="token p">Android emulator is designed to use a 60Hz refresh rate no matter how the underlying window system handles input events. It's done by registering the <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">gui_update()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/vl-android.c#L1202-L1217</span><span class="token md md-paren-end">)</span></span> callback (or <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">nographic_update()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/vl-android.c#L1219-L1224</span><span class="token md md-paren-end">)</span></span> in case the emulator is launched with <span class="token code ace_support ace_function"><span class="token md md-code">`</span>-nographic<span class="token md md-code">`</span></span>) with a timer to the main-loop. </span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">The timer times out around every 16ms. On each timeout, the callback updates framebuffer if OpenGL emulation is not enabled, collects input events and send the input events to the goldfish kernel.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-18"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>main_loop-&gt;vl_android: gui_update<span class="token lf">
</span>vl_android-&gt;console: dpy_refresh<span class="token lf">
</span>console-&gt;display: android_display_refresh<span class="token lf">
</span>display-&gt;framebuffer: qframebuffer_poll<span class="token lf">
</span>framebuffer-&gt;emulator_window: emulator_window_refresh<span class="token lf">
</span>emulator_window-&gt;framebuffer: qframebuffer_check_updates<span class="token lf">
</span>note right of framebuffer: update framebuffer if no OpenGL emulation<span class="token lf">
</span>emulator_window-&gt;ui: skin_ui_process_events<span class="token lf">
</span>ui-&gt;event_sdl2/qt: skin_event_poll<span class="token lf">
</span>ui-&gt;window: skin_window_process_event<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-19"><span class="token h2 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">##</span> The Goldfish Virtual Platform</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-20"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Goldfish Device Registration</span><span class="token lf">
</span><span class="token p">The core of goldfish device registration is <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">goldfish<span class="token em"><span class="token md md-em md-start">_</span>device<span class="token md md-em md-close">_</span></span>add()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/goldfish/device.c#L99-L102</span><span class="token md md-paren-end">)</span></span>:</span><span class="token lf">
</span><span class="token li"><span class="token md md-li">- </span>dev: the device description, refer <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">goldfish_device</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/hw/android/goldfish/device.h#L18-L29</span><span class="token md md-paren-end">)</span></span>.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span>mem_read: an array of callbacks for <span class="token em"><span class="token md md-em md-start">*</span>byte<span class="token md md-em md-close">*</span></span>, <span class="token em"><span class="token md md-em md-start">*</span>word<span class="token md md-em md-close">*</span></span> and <span class="token em"><span class="token md md-em md-start">*</span>dword<span class="token md md-em md-close">*</span></span> memory read operations, respectively. See <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">CPUReadMemoryFunc</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/exec/cpu-common.h#L59</span><span class="token md md-paren-end">)</span></span>.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span>mem_wrtie: an array of callbacks for <span class="token em"><span class="token md md-em md-start">*</span>byte<span class="token md md-em md-close">*</span></span>, <span class="token em"><span class="token md md-em md-start">*</span>word<span class="token md md-em md-close">*</span></span> and <span class="token em"><span class="token md md-em md-start">*</span>dword<span class="token md md-em md-close">*</span></span> memory write operations, respectively. See <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">CPUWriteMemoryFunc</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/exec/cpu-common.h#L58</span><span class="token md md-paren-end">)</span></span>.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span>opaque: anything the caller wants to keep. It will be carried back to the mem<span class="token em"><span class="token md md-em md-start">_</span>read / mem<span class="token md md-em md-close">_</span></span>write callback functions on invocation, which happens in <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">subpage_readlen()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/exec.c#L1610-L1611</span><span class="token md md-paren-end">)</span></span> and <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">subpage_writelen</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/exec.c#L1626-L1628</span><span class="token md md-paren-end">)</span></span>.<span class="token lf">
</span></span></span><span class="wmd-input-section" id="wmd-input-section-21"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>c<span class="token lf">
</span>int goldfish_device_add(struct goldfish_device *dev,<span class="token lf">
</span>                       CPUReadMemoryFunc **mem_read,<span class="token lf">
</span>                       CPUWriteMemoryFunc **mem_write,<span class="token lf">
</span>                       void *opaque);<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>All the goldfish virtual hardware are appeared as platform devices -- meaning they're connected to CPU directly, not through any kind of buses. Further, goldfish virtual devices are all operated through memory-mapped I/O.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-22"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Goldfish Platform Bus</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-23"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Discoverability</span><span class="token lf">
</span><span class="token p">Since a platform device is not naturally discoverable as it's not connected through any kind of buses, the driver doesn't know which I/O port, memory address or interrupt it should use.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p"><span class="token em"><span class="token md md-em md-start">*</span>Platform bus<span class="token md md-em md-close">*</span></span> is a special <span class="token em"><span class="token md md-em md-start">*</span>platform device<span class="token md md-em md-close">*</span></span> to overcome this issue. It plays the role of a bus for other platform devices. Think about PCI.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>In the new qemu-android implementation for Android M and later, it no longer uses <span class="token em"><span class="token md md-em md-start">*</span>platform bus<span class="token md md-em md-close">*</span></span> in favor of <span class="token em"><span class="token md md-em md-start">*</span>device tree<span class="token md md-em md-close">*</span></span>. Refer the article <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">Platform devices and device trees</span><span class="token md md-bracket-end">](</span><span class="token md md-href">http://lwn.net/Articles/448502/</span><span class="token md md-paren-end">)</span></span> for more information about device trees.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-24"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Virtual Device Design</span><span class="token lf">
</span><span class="token li"><span class="token md md-li">* </span>Goldfish Platform Bus uses the MMIO address region 0xff001000 to 0xff801000. <span class="token lf">
</span></span><span class="token li"><span class="token md md-li">* </span>0xff001000 - 0xff001fff are reserved by <span class="token code ace_support ace_function"><span class="token md md-code">`</span>goldfish_device_bus<span class="token md md-code">`</span></span> as a set of <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">32bit I/O registers</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/docs/GOLDFISH-VIRTUAL-HARDWARE.TXT#L73-L89</span><span class="token md md-paren-end">)</span></span> for bus operations.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">* </span>The bus itself uses IRQ 1 on ARM with goldfish interrupt controller, and IRQ 4 on x86 with qemu's built-in virtual i8259.<span class="token lf">
</span><span class="token lf">
</span></span></span><span class="wmd-input-section" id="wmd-input-section-25"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Kernel Driver Implementation</span><span class="token lf">
</span><span class="token p"><span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">pdev_bus.c</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/mozilla-b2g/kernel_goldfish/blob/b2g-goldfish-3.4/arch/x86/mach-goldfish/pdev_bus.c</span><span class="token md md-paren-end">)</span></span> registers a <span class="token em"><span class="token md md-em md-start">*</span>platform device<span class="token md md-em md-close">*</span></span> <span class="token code ace_support ace_function"><span class="token md md-code">`</span>goldfish_pdev_bus<span class="token md md-code">`</span></span> at I/O port 0x1000, which plays the role of a <span class="token em"><span class="token md md-em md-start">*</span>platform bus<span class="token md md-em md-close">*</span></span>.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">The bus scan process is as following:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-26"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>kernel-&gt;pdev_bus: goldfish_init<span class="token lf">
</span>pdev_bus-&gt;kernel: platform_device_register(&amp;goldfish_pdev_bus_device)<span class="token lf">
</span>kernel-&gt;pdev_bus: goldfish_pdev_bus_init<span class="token lf">
</span>pdev_bus-&gt;kernel: platform_driver_register(&amp;goldfish_pdev_bus_driver)<span class="token lf">
</span><span class="token lf">
</span>note right of kernel: found driver / device matches<span class="token lf">
</span><span class="token lf">
</span>kernel-&gt;pdev_bus: goldfish_pdev_bus_probe<span class="token lf">
</span>pdev_bus-&gt;kernel: writel<span class="token lf">
</span>note right of kernel: goldfish_bus_write<span class="token lf">
</span><span class="token lf">
</span>pdev_bus-&gt;kernel: request_irq<span class="token lf">
</span>kernel-&gt;pdev_bus: goldfish_pdev_bus_interrupt<span class="token lf">
</span>pdev_bus-&gt;kernel: readl<span class="token lf">
</span>note right of kernel: goldfish_bus_read<span class="token lf">
</span><span class="token lf">
</span>pdev_bus-&gt;pdev_bus: goldfish_new_pdev<span class="token lf">
</span>pdev_bus-&gt;kernel: readl<span class="token lf">
</span>note right of kernel: goldfish_bus_read<span class="token lf">
</span>note right of pdev_bus: loop until all devices info loaded<span class="token lf">
</span>pdev_bus-&gt;kernel: schedule_work(&amp;pdev_bus_worker)<span class="token lf">
</span>kernel-&gt;pdev_bus: goldfish_pdev_worker<span class="token lf">
</span>pdev_bus-&gt;kernel: platform_device_register<span class="token lf">
</span>note right of pdev_bus: loop until all devices registered<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">After the bus scan finishes, <span class="token code ace_support ace_function"><span class="token md md-code">`</span>goldfish_pdev_bus_device<span class="token md md-code">`</span></span> can be removed through <span class="token code ace_support ace_function"><span class="token md md-code">`</span>platform_device_unregister<span class="token md md-code">`</span></span>, although the driver didn't do so. </span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Those platform devices registered still need corresponding drivers to work. For exmaple, the driver for <span class="token em"><span class="token md md-em md-start">*</span>qemu_pipe<span class="token md md-em md-close">*</span></span> is at <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemu_pipe.c</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/mozilla-b2g/kernel_goldfish/blob/b2g-goldfish-3.4/drivers/misc/qemupipe/qemu_pipe.c</span><span class="token md md-paren-end">)</span></span>.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-27"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> /proc/ioports</span><span class="token lf">
</span><span class="token p">/proc/ioports lists all registered PMIO. <span class="token code ace_support ace_function"><span class="token md md-code">`</span>goldfish_pdev_bus<span class="token md md-code">`</span></span> is registered at I/O port 0x1000.</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-28"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>text<span class="token lf">
</span>0000-001f : dma1<span class="token lf">
</span>0020-0021 : pic1<span class="token lf">
</span>0040-0043 : timer0<span class="token lf">
</span>0050-0053 : timer1<span class="token lf">
</span>0060-0060 : keyboard<span class="token lf">
</span>0064-0064 : keyboard<span class="token lf">
</span>0070-0071 : rtc_cmos<span class="token lf">
</span>  0070-0071 : rtc0<span class="token lf">
</span>0080-008f : dma page reg<span class="token lf">
</span>00a0-00a1 : pic2<span class="token lf">
</span>00c0-00df : dma2<span class="token lf">
</span>00f0-00ff : fpu<span class="token lf">
</span>03c0-03df : vga+<span class="token lf">
</span>0cf8-0cff : PCI conf1<span class="token lf">
</span>1000-10ff : goldfish_pdev_bus<span class="token lf">
</span>c000-c0ff : 0000:00:02.0<span class="token lf">
</span>  c000-c01f : ne2k-pci<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-29"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> /proc/iomem</span><span class="token lf">
</span><span class="token p">/proc/iomen lists all registered MMIO and real memory.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p"><span class="token code ace_support ace_function"><span class="token md md-code">`</span>goldfish_device_bus<span class="token md md-code">`</span></span> is a special device which contains only the bus state for bus scanning only. It can be thought as the corresponding device implementation of <span class="token code ace_support ace_function"><span class="token md md-code">`</span>goldfish_pdev_bus_device<span class="token md md-code">`</span></span>, and can also be removed after scan finishes.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-30"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>text<span class="token lf">
</span>00000000-0000ffff : reserved<span class="token lf">
</span>00010000-0009efff : System RAM<span class="token lf">
</span>0009f000-0009ffff : reserved<span class="token lf">
</span>000a0000-000bffff : Video RAM area<span class="token lf">
</span>000c0000-000c8bff : Video ROM<span class="token lf">
</span>000c9000-000c91ff : Adapter ROM<span class="token lf">
</span>000e8000-000fffff : reserved<span class="token lf">
</span>  000f0000-000fffff : System ROM<span class="token lf">
</span>00100000-1ffeffff : System RAM<span class="token lf">
</span>  00200000-0067f9ec : Kernel code<span class="token lf">
</span>  0067f9ed-008906ff : Kernel data<span class="token lf">
</span>  008dd000-00a3dfff : Kernel bss<span class="token lf">
</span>1fff0000-1fffffff : ACPI Tables<span class="token lf">
</span>ff001000-ff001fff : goldfish_device_bus<span class="token lf">
</span>ff004000-ff004fff : goldfish_audio.0<span class="token lf">
</span>ff005000-ff005fff : goldfish_mmc.0<span class="token lf">
</span>ff010000-ff010fff : goldfish-battery.0<span class="token lf">
</span>ff011000-ff011fff : goldfish_nand.0<span class="token lf">
</span>ff012000-ff013fff : qemu_pipe<span class="token lf">
</span>ff014000-ff014fff : goldfish_tty.0<span class="token lf">
</span>ff015000-ff015fff : goldfish_tty.1<span class="token lf">
</span>ff016000-ff016fff : goldfish_fb.0<span class="token lf">
</span>ff017000-ff017fff : goldfish_events.0<span class="token lf">
</span>fffc0000-ffffffff : reserved<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-31"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Emulator Implementation (x86) </span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-32"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>vl_android-&gt;module: module_call_init(MODULE_INIT_MACHINE) <span class="token lf">
</span>module-&gt;pc: pc_machine_init<span class="token lf">
</span>pc-&gt;vl_android: qemu_register_machine(pc_machine)<span class="token lf">
</span>vl_android-&gt;pc_machine: init<span class="token lf">
</span>pc_machine-&gt;pc: pc_init1<span class="token lf">
</span>pc-&gt;device: goldfish_device_init<span class="token lf">
</span>pc-&gt;device: goldfish_device_bus_init<span class="token lf">
</span>device-&gt;device: goldfish_device_add<span class="token lf">
</span>pc-&gt;hw_pipe: pipe_dev_init<span class="token lf">
</span>hw_pipe-&gt;device: goldfish_device_add<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Log printed at <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">goldfish<span class="token em"><span class="token md md-em md-start">_</span>add<span class="token md md-em md-close">_</span></span>device<span class="token em"><span class="token md md-em md-start">_</span>no<span class="token md md-em md-close">_</span></span>io()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/goldfish/device.c#L86-L87</span><span class="token md md-paren-end">)</span></span>, if enabled:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-33"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span><span class="token lf">
</span>goldfish_device_bus_init: base ff001000, irq 4<span class="token lf">
</span>goldfish_add_device: goldfish_device_bus, base ff001000 1000, irq 4 1<span class="token lf">
</span>goldfish_add_device: goldfish-battery, base ff010000 1000, irq 5 1<span class="token lf">
</span>goldfish_add_device: goldfish_nand, base ff011000 1000, irq 0 0<span class="token lf">
</span>goldfish_add_device: qemu_pipe, base ff012000 2000, irq 6 1<span class="token lf">
</span>goldfish_add_device: goldfish_mmc, base ff005000 1000, irq 7 1<span class="token lf">
</span>goldfish_add_device: goldfish_tty, base ff014000 1000, irq 9 1<span class="token lf">
</span>goldfish_add_device: goldfish_tty, base ff015000 1000, irq 10 1<span class="token lf">
</span>goldfish_add_device: goldfish_fb, base ff016000 1000, irq 11 1<span class="token lf">
</span>goldfish_add_device: goldfish_events, base ff017000 1000, irq 3 1<span class="token lf">
</span>goldfish_add_device: goldfish_audio, base ff004000 1000, irq 14 1<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-34"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> QEMU Pipe / Goldfish Pipe</span><span class="token lf">
</span><span class="token p">QEMU Pipe, or Goldfish Pipe, is a special virtual device to provide very fast communication channel between the emulator and the emulated system. In the emulated system, it appears as <span class="token code ace_support ace_function"><span class="token md md-code">`</span>/dev/qemu_pipe<span class="token md md-code">`</span></span> on kernel 3.4 or before, and <span class="token code ace_support ace_function"><span class="token md md-code">`</span>/dev/goldfish_pipe<span class="token md md-code">`</span></span> on kernel 3.10.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-35"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> QEMU Pipe Services</span><span class="token lf">
</span><span class="token p">There are currently 4 types of services using qemu pipe, as described in the <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">document</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/docs/ANDROID-QEMU-PIPE.TXT#L288-L315</span><span class="token md md-paren-end">)</span></span>. Services are registered through <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">goldfish<span class="token em"><span class="token md md-em md-start">_</span>pipe<span class="token md md-em md-close">_</span></span>add_type()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/goldfish/pipe.c#L83-L86</span><span class="token md md-paren-end">)</span></span>:</span><span class="token lf">
</span><span class="token li"><span class="token md md-li">- </span>pipeName: an unique name of the pipe service.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span>pipeOpaque: anything the caller wants to keep. It will be carried back to the handler functions.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span>pipeFuncs: pipe handler functions. Refer <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">GoldfishPipeFuncs</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/hw/android/goldfish/pipe.h#L62-L119</span><span class="token md md-paren-end">)</span></span>. <span class="token lf">
</span></span></span><span class="wmd-input-section" id="wmd-input-section-36"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>c<span class="token lf">
</span>void<span class="token lf">
</span>goldfish_pipe_add_type(const char*               pipeName,<span class="token lf">
</span>                       void*                     pipeOpaque,<span class="token lf">
</span>                       const GoldfishPipeFuncs*  pipeFuncs );<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>The <span class="token code ace_support ace_function"><span class="token md md-code">`</span>hwpipe<span class="token md md-code">`</span></span> parameter in <span class="token code ace_support ace_function"><span class="token md md-code">`</span>init<span class="token md md-code">`</span></span> function is an instance of <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">struct Pipe</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/goldfish/pipe.c#L131-L142</span><span class="token md md-paren-end">)</span></span>, however the definition of the structure is never exposed to pipe services. Pipe services are responsible of generating their own identifier or encapsulation for a given pipe connection, and return it in the <span class="token code ace_support ace_function"><span class="token md md-code">`</span>init<span class="token md md-code">`</span></span> function. The return value will later be passed as <span class="token code ace_support ace_function"><span class="token md md-code">`</span>pipe<span class="token md md-code">`</span></span> parameter when <span class="token code ace_support ace_function"><span class="token md md-code">`</span>sendBuffers<span class="token md md-code">`</span></span>, <span class="token code ace_support ace_function"><span class="token md md-code">`</span>recvBuffers<span class="token md md-code">`</span></span>, <span class="token code ace_support ace_function"><span class="token md md-code">`</span>poll<span class="token md md-code">`</span></span> or <span class="token code ace_support ace_function"><span class="token md md-code">`</span>close<span class="token md md-code">`</span></span> functions are invoked.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-37"><span class="token h5 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">#####</span> Workflow</span><span class="token lf">
</span><span class="token p">For a user space program, the first write after a fd opened is always the pipe name (with optional arguments appended, <span class="token code ace_support ace_function"><span class="token md md-code">`</span>pipe:qemud:gsm<span class="token md md-code">`</span></span> for example). Afterward, readings / writings to the fd are redirected to the pipe service.</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-38"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>c<span class="token lf">
</span>fd = open("/dev/qemu_pipe", O_RDWR);<span class="token lf">
</span>const char* pipeName = "&lt;pipename&gt;";<span class="token lf">
</span>ret = write(fd, pipeName, strlen(pipeName)+1);<span class="token lf">
</span>if (ret &lt; 0) {<span class="token lf">
</span>    // error<span class="token lf">
</span>}<span class="token lf">
</span>... ready to go<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Here's what actually happened for the <span class="token code ace_support ace_function"><span class="token md md-code">`</span>open()<span class="token md md-code">`</span></span> call:</span><span class="token lf">
</span><span class="token li"><span class="token md md-li">1. </span>Kernel generates a channel id, sends it with the command <span class="token code ace_support ace_function"><span class="token md md-code">`</span>PIPE_CMD_OPEN<span class="token md md-code">`</span></span> to the qemu pipe device.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">2. </span>The qemu pipe generates a pipe connection with the given channel id.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">3. </span>The qemu pipe then generates a pipe connector, which has the interface as a pipe service, on the pipe channel.<span class="token lf">
</span></span></span><span class="wmd-input-section" id="wmd-input-section-39"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>kernel-&gt;hw_pipe: PIPE_CMD_OPEN(channel)<span class="token lf">
</span>hw_pipe-&gt;pipe: pipe_new(channel)<span class="token lf">
</span>hw_pipe-&gt;pipe_connector: pipeConnector_new(pipe)<span class="token lf">
</span>pipe_connector-&gt;pipe: funcs = &amp;pipeConnector_funcs<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Hence, after the open call, the fd connects to a pipe connector.</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-40"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>text<span class="token lf">
</span>+------+                          +----------------+<span class="token lf">
</span>|  fd  |&lt;------pipe channel------&gt;| pipe connector |<span class="token lf">
</span>+------+                          +----------------+<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">The first <span class="token code ace_support ace_function"><span class="token md md-code">`</span>write()<span class="token md md-code">`</span></span> is where the actual connection to a pipe service created:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-41"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>kernel-&gt;hw_pipe: PIPE_CMD_WRITE_BUFFER(pipename)<span class="token lf">
</span>hw_pipe-&gt;pipe_connector: sendBuffers<span class="token lf">
</span>pipe_connector-&gt;hw_pipe: goldfish_pipe_find_type<span class="token lf">
</span>hw_pipe--&gt;pipe_connector: pipe_service<span class="token lf">
</span>pipe_connector-&gt;pipe_service: init<span class="token lf">
</span>pipe_service--&gt;pipe_connector: peer<span class="token lf">
</span>pipe_connector-&gt;hw_pipe: funcs  = &amp;pipe_service-&gt;funcs<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">After the <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">evil switch</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/goldfish/pipe.c#L429-L433</span><span class="token md md-paren-end">)</span></span>, the connection becomes:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-42"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>text<span class="token lf">
</span>+------+                          +----------------+<span class="token lf">
</span>|  fd  |&lt;------pipe channel------&gt;|  pipe service  |<span class="token lf">
</span>+------+                          +----------------+<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Readings and writings afterward go to <span class="token code ace_support ace_function"><span class="token md md-code">`</span>recvBuffers<span class="token md md-code">`</span></span> and <span class="token code ace_support ace_function"><span class="token md md-code">`</span>sendBuffers<span class="token md md-code">`</span></span> of the pipe service, respectively.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt;</span>The service might not be able to consume more writes, or provide anything to read temporarily when a write / read request occurs. In this case, the service returns <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">PIPE<span class="token em"><span class="token md md-em md-start">_</span>ERROR<span class="token md md-em md-close">_</span></span>AGAIN</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/hw/android/goldfish/pipe.h#L189</span><span class="token md md-paren-end">)</span></span>. </span><span class="token lf">
</span><span class="token p">&gt;</span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>The client can then choose to be signaled when writing / reading is possible. See <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">waiting / signaling</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/docs/ANDROID-QEMU-PIPE.TXT#L167-L229</span><span class="token md md-paren-end">)</span></span> sections.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-43"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Adaptation of Legacy QEMUD</span><span class="token lf">
</span><span class="token p">Before qemu pipe was implemented, communications between emulator and the emulated system were all through serial port with a multiplexing daemon <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemud</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/mozilla-b2g/device_generic_goldfish/blob/b2g-4.4.2_r1/qemud/qemud.c</span><span class="token md md-paren-end">)</span></span> which lives in the emulated system.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">The daemon creates a socket <span class="token code ace_support ace_function"><span class="token md md-code">`</span>/dev/socket/qemud<span class="token md md-code">`</span></span>, and client programs transmit data through the socket. The whole architecture looks like this:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-44"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>text<span class="token lf">
</span>emulator &lt;==serial==&gt; qemud &lt;---&gt; /dev/socket/qemud &lt;-+--&gt; client1<span class="token lf">
</span>                                                      |<span class="token lf">
</span>                                                      +--&gt; client2<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">The benefit of using qemud was to avoid writing device drivers for all services such as gsm, gps and other emulated sensors, but instead only needed to implement the multiplexing protocol clients.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">The qemu pipe replaces the role and provides much better performance. However, to keep backward compatibility and to avoid too much change to the existing implementation, the <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">emulator side qemud</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.c</span><span class="token md md-paren-end">)</span></span> is kept but it works as one of the qemu pipe services now. The serial port channel no longer in use, unless you're running a very old version of Android on the emulator, such as Gingerbread.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">For emulated systems since ICS, both <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemud daemon</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/mozilla-b2g/device_generic_goldfish/blob/b2g-4.4.2_r1/qemud/qemud.c</span><span class="token md md-paren-end">)</span></span> and the corresponding socket <span class="token code ace_support ace_function"><span class="token md md-code">`</span>/dev/socket/qemud<span class="token md md-code">`</span></span> are no longer in use, however it still keeps legagy code for backward compatibility, and consequently the logs / configs look very confusing. For example, You can still find qemud service in <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">init.goldfish.rc</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/mozilla-b2g/device_generic_goldfish/blob/b2g-4.4.2_r1/init.goldfish.rc#L129-L131</span><span class="token md md-paren-end">)</span></span>.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-45"><span class="token h5 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">#####</span> Initialization Flow</span><span class="token lf">
</span><span class="token p">The first part of the initialization flow keeps the original design -- qemud was initailized as a char device since it was using serial port. The adaption happens in <span class="token code ace_support ace_function"><span class="token md md-code">`</span>_android_qemud_pipe_init<span class="token md md-code">`</span></span> function, in which it initialized itself as a pipe service.</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-46"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>qemu_main-&gt;vl_android: serial_hds_add_at<span class="token lf">
</span>vl_android-&gt;qemu_char: qemu_chr_open<span class="token lf">
</span>qemu_char-&gt;qemu_char: qemu_chr_open_opts<span class="token lf">
</span>qemu_char-&gt;qemu_char: backend_table[i].open<span class="token lf">
</span>qemu_char-&gt;qemu_char: qemu_chr_open_android_qemud<span class="token lf">
</span>qemu_char-&gt;hw_qemud: android_qemud_get_cs<span class="token lf">
</span>hw_qemud-&gt;hw_qemud: android_qemud_init<span class="token lf">
</span><span class="token lf">
</span>note right of hw_qemud: adapt qemu-pipe<span class="token lf">
</span>hw_qemud-&gt;hw_qemud: _android_qemud_pipe_init<span class="token lf">
</span>hw_qemud-&gt;pipe: goldfish_pipe_add_type<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-47"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> QEMUD Services</span><span class="token lf">
</span><span class="token p"><span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">Qemud services</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/docs/ANDROID-QEMUD-SERVICES.TXT</span><span class="token md md-paren-end">)</span></span> are registered through <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemud<span class="token em"><span class="token md md-em md-start">_</span>service<span class="token md md-em md-close">_</span></span>register()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.c#L2307-L2313</span><span class="token md md-paren-end">)</span></span>:</span><span class="token lf">
</span><span class="token li"><span class="token md md-li">- </span>service_name: an unique name for the service.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span>max_clients: the maximum number of clients accepted by the service concurrently. If this value is 0, then any number of clients can connect.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span>serv_opaque: anything the caller wants to keep. It will be carried back to the callback functions.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span>serv_connect: see <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">QemudServiceConnect</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L114-L121</span><span class="token md md-paren-end">)</span></span>. <span class="token lf">
</span></span><span class="token p">The <span class="token code ace_support ace_function"><span class="token md md-code">`</span>channel<span class="token md md-code">`</span></span> parameter was used in the legacy serial port implementation. For qemu pipe it's always -1. </span><span class="token lf">
</span><span class="token p">The <span class="token code ace_support ace_function"><span class="token md md-code">`</span>client_param<span class="token md md-code">`</span></span> is a string, if any, passed from the guest system after the service name. For example, Mozilla's multi-sim implementation passes "qemud:gsm:1" when connecting the second sim card, and in this case <span class="token code ace_support ace_function"><span class="token md md-code">`</span>client_param<span class="token md md-code">`</span></span> is "1".</span><span class="token lf">
</span><span class="token li"><span class="token md md-li">- </span>serv_save: see <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">QemudServiceSave</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L123-L126</span><span class="token md md-paren-end">)</span></span>.<span class="token lf">
</span></span><span class="token li"><span class="token md md-li">- </span>serv_load: see <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">QemudServiceLoad</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L128-L131</span><span class="token md md-paren-end">)</span></span>.<span class="token lf">
</span></span></span><span class="wmd-input-section" id="wmd-input-section-48"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>c<span class="token lf">
</span>QemudService*<span class="token lf">
</span>qemud_service_register( const char*          service_name,<span class="token lf">
</span>                        int                  max_clients,<span class="token lf">
</span>                        void*                serv_opaque,<span class="token lf">
</span>                        QemudServiceConnect  serv_connect,<span class="token lf">
</span>                        QemudServiceSave     serv_save,<span class="token lf">
</span>                        QemudServiceLoad     serv_load );<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">When the <span class="token code ace_support ace_function"><span class="token md md-code">`</span>serv_connect<span class="token md md-code">`</span></span> function is invoked, inside the function it should use <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemud<span class="token em"><span class="token md md-em md-start">_</span>client<span class="token md md-em md-close">_</span></span>new()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L85-L99</span><span class="token md md-paren-end">)</span></span> to create and return a new client if the service chooses to accept the connection.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Launch the emulator with <span class="token code ace_support ace_function"><span class="token md md-code">`</span>-debug-qemud<span class="token md md-code">`</span></span> option shows the log:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-49"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span><span class="token lf">
</span>emulator: Registered QEMUD service hw-control<span class="token lf">
</span>emulator: Registered QEMUD service boot-properties<span class="token lf">
</span>emulator: Registered QEMUD service gsm<span class="token lf">
</span>emulator: Registered QEMUD service gps<span class="token lf">
</span>emulator: Registered QEMUD service camera<span class="token lf">
</span>emulator: Registered QEMUD service sensors<span class="token lf">
</span>emulator: Registered QEMUD service fingerprintlisten<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>There were "adb" and "adb-debug" qemud services, but apparently adb services didn't work well and are currently disabled. See <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">propertyFile_getAdbdCommunicationMode</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/avd/util.c#L240-L244</span><span class="token md md-paren-end">)</span></span>.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-50"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Workflow</span><span class="token lf">
</span><span class="token p">The design of qemud differs from qemu pipe slightly. Here's a simple mapping of equivalent major callbacks used in pipe and qemud services.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token table">| Pipe Callback | QEMUD Callback | Purpose |<span class="token lf">
</span>| ------------- | -------------- | ------- |<span class="token lf">
</span>| GoldfishPipeFuncs.init | QemudServiceConnect | accepting an incoming client |<span class="token lf">
</span>| GoldfishPipeFuncs.sendBuffers | QemudClientRecv | a client is sending messages to the service |<span class="token lf">
</span>| GoldfishPipeFuncs.recvBuffers | - | a client is reading messages from the service<span class="token lf">
</span>| GoldfishPipeFuncs.close | QemudClientClose | a client closed the connection<span class="token lf">
</span><span class="token lf">
</span></span><span class="token p">Unlike pipe services, qemud services are not notified when clients are reading. Instead, qemud services send messages to clients proactively through <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemud<span class="token em"><span class="token md md-em md-start">_</span>client<span class="token md md-em md-close">_</span></span>send()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L107</span><span class="token md md-paren-end">)</span></span> or <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemud<span class="token em"><span class="token md md-em md-start">_</span>service<span class="token md md-em md-close">_</span></span>broadcast()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L145-L147</span><span class="token md md-paren-end">)</span></span>. For pipe implementation, it writes to the buffer <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">QemudPipeMessage</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.c#L587-L607</span><span class="token md md-paren-end">)</span></span>, and <span class="token code ace_support ace_function"><span class="token md md-code">`</span>recvBuffers<span class="token md md-code">`</span></span> reads from the buffer.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-51"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Initialization</span><span class="token lf">
</span><span class="token p">Functions start with <span class="token code ace_support ace_function"><span class="token md md-code">`</span>_qemudPipe_<span class="token md md-code">`</span></span> in qemud are the implementation of pipe callbacks. For example, <span class="token code ace_support ace_function"><span class="token md md-code">`</span>_qemudPipe_init<span class="token md md-code">`</span></span> implements the <span class="token code ace_support ace_function"><span class="token md md-code">`</span>init<span class="token md md-code">`</span></span> function, and convert the call to the corresponding <span class="token code ace_support ace_function"><span class="token md md-code">`</span>QemudServiceConnect<span class="token md md-code">`</span></span> implementation of a qemud service:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-52"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>hw_pipe-&gt;qemud: _qemudPipe_init<span class="token lf">
</span>qemud-&gt;qemud_service: serv_connect<span class="token lf">
</span>qemud_service-&gt;qemud: qemud_client_new<span class="token lf">
</span>qemud-&gt;qemud_client: create<span class="token lf">
</span>qemud-&gt;qemud: qemud_service_add_client<span class="token lf">
</span>qemud-&gt;qemud_client: set service<span class="token lf">
</span>qemud-&gt;qemud_service: add client<span class="token lf">
</span>note left of qemud_service: put qemud_client to the head of the client linked list<span class="token lf">
</span>qemud-&gt;qemud_pipe: create<span class="token lf">
</span>qemud--&gt;hw_pipe: qemud_pipe<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-53"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Client Sends Messages</span><span class="token lf">
</span><span class="token p">Sending messages to a qemud service is straightforward:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-54"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>hw_pipe-&gt;qemud: _qemudPipe_sendBuffers<span class="token lf">
</span>qemud-&gt;qemud_pipe: get client<span class="token lf">
</span>qemud_pipe--&gt;qemud: client<span class="token lf">
</span>qemud-&gt;qemud_client: clie_recv<span class="token lf">
</span>qemud_client-&gt;qemud_service: clie_recv<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-55"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Client Reads Messages</span><span class="token lf">
</span><span class="token p">Reading messages, on the other hand, is a bit more complex. Here shows the case that message buffer was empty when client was reading:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-56"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>hw_pipe-&gt;qemud: _qemudPipe_recvBuffers<span class="token lf">
</span>qemud-&gt;qemud_pipe: get client<span class="token lf">
</span>qemud_pipe--&gt;qemud: client<span class="token lf">
</span>qemud-&gt;qemud_client: msg_list = ProtocolSelector.Pipe.messages<span class="token lf">
</span>note right of qemud: found msg_list is empty<span class="token lf">
</span>qemud-&gt;hw_pipe: PIPE_ERROR_AGAIN<span class="token lf">
</span>qemud_service-&gt;qemud: client_send<span class="token lf">
</span>note left of qemud_service: service got something for client<span class="token lf">
</span>qemud-&gt;hw_pipe: goldfish_pipe_wake<span class="token lf">
</span>hw_pipe-&gt;qemud: _qemudPipe_recvBuffers<span class="token lf">
</span>note right of qemud: this time msg_list is not empty and client can read<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-57"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> CharDriverState</span><span class="token lf">
</span><span class="token p">In QEMU, a <span class="token em"><span class="token md md-em md-start">*</span>CharDriver<span class="token md md-em md-close">*</span></span> is an object to operate on a specific type of char devices. For exmaple, <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">TCPCharDriver</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/qemu-char.c#L1982-L1990</span><span class="token md md-paren-end">)</span></span> and the corresponding <span class="token code ace_support ace_function"><span class="token md md-code">`</span>tcp_chr_<span class="token md md-code">`</span></span> functions form a driver for TCP net console.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p"><span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string"><span class="token em"><span class="token md md-em md-start">*</span>CharDriverState<span class="token md md-em md-close">*</span></span></span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/sysemu/char.h#L54-L77</span><span class="token md md-paren-end">)</span></span>, on the other hand, forms an unified interface between a char driver and a user operating on the char driver. By forming an unified interface, the user needs not to know which driver it's actually operating on, and the driver needs not to know who the user is either. The char driver is referred as the <span class="token em"><span class="token md md-em md-start">*</span>backend<span class="token md md-em md-close">*</span></span> for the CharDriverState in this case.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Most character devices are associated with file descriptors, and therefore character devices are polled in the main loop for readings and incoming events (so as writing if opened non-blocking).</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-58"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>text<span class="token lf">
</span>+--------+                                 +---------------+     +-----+<span class="token lf">
</span>| User 1 |---+                         +---| TcpCharDriver |-----| tcp |<span class="token lf">
</span>+--------+   |                         |   +---------------+     +-----+<span class="token lf">
</span>             |                         |                                <span class="token lf">
</span>+--------+   |   +-----------------+   |   +---------------+     +-----+<span class="token lf">
</span>| User 2 |---+---| CharDriverState |---+---| FDCharDriver  |-----| fd  |<span class="token lf">
</span>+--------+   |   +-----------------+   |   +---------------+     +-----+<span class="token lf">
</span>             |                         |                                <span class="token lf">
</span>+--------+   |                         |   +---------------+     +-----+<span class="token lf">
</span>| User 3 |---+                         +---| PtyCharDriver |-----| pty |<span class="token lf">
</span>+--------+                                 +---------------+     +-----+<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token blockquote ace_string ace_constant ace_other"><span class="token md md-gt">&gt; </span>CharDriverState is usually used as a one-to-one connection. However it does support connections to multiple drivers through <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">MuxDriver</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/qemu-char.c#L260-L282</span><span class="token md md-paren-end">)</span></span>.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-59"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Initialization</span><span class="token lf">
</span><span class="token p"><span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemu<span class="token em"><span class="token md md-em md-start">_</span>chr<span class="token md md-em md-close">_</span></span>open()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/sysemu/char.h#L82</span><span class="token md md-paren-end">)</span></span> is used to create a new CharDriverState object from a descriptive string <span class="token em"><span class="token md md-em md-start">*</span>filename<span class="token md md-em md-close">*</span></span>. The function looks up for a proper backend from the filename, and then use the function defined in the <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">backend_table</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/qemu-char.c#L2553-L2594</span><span class="token md md-paren-end">)</span></span> to create a CharDriverState associated to the backend.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-60"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>user-&gt;qemu_char: qemu_chr_open<span class="token lf">
</span>qemu_char-&gt;backend: open<span class="token lf">
</span>backend-&gt;CharDriverState: create<span class="token lf">
</span>backend--&gt;qemu_char: cs<span class="token lf">
</span>qemu_char--&gt;user: cs<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-61"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Writing</span><span class="token lf">
</span><span class="token p"><span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemu<span class="token em"><span class="token md md-em md-start">_</span>chr<span class="token md md-em md-close">_</span></span>write()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/sysemu/char.h#L89</span><span class="token md md-paren-end">)</span></span> is used to try to write data into a CS object. Note that success is not guaranteed: the function returns the number of bytes that were really written (which can be 0) and the caller must deal with it. This is very similar to writing to a non-blocking BSD socket on Unix.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-62"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>user-&gt;qemu_char: qemu_chr_write(cs)<span class="token lf">
</span>qemu_char-&gt;CharDriverState: chr_write<span class="token lf">
</span>CharDriverState-&gt;backend: write<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-63"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Reading</span><span class="token lf">
</span><span class="token p">Reading is not so straightforward. As mentioned before, character devices are only polled in the main loop. Hence readings can not be performed directly, instead reading handlers should be registered to the CharDriverState though <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemu<span class="token em"><span class="token md md-em md-start">_</span>chr<span class="token md md-em md-close">_</span></span>add_handler()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/sysemu/char.h#L91-L95</span><span class="token md md-paren-end">)</span></span>.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-64"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>user-&gt;qemu_char: qemu_chr_add_handler(cs, can_read, read)<span class="token lf">
</span>qemu_char-&gt;CharDriverState: chr_update_read_handler<span class="token lf">
</span>CharDriverState-&gt;backend: update_read_handler<span class="token lf">
</span>backend-&gt;iohandler: qemu_set_fd_handler<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">In the next event loop, it will poll iohandlers and triggers read on registered handlers.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-65"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>sequence<span class="token lf">
</span>main_loop-&gt;iohandler: qemu_iohandler_fill<span class="token lf">
</span>iohandler-&gt;backend: fd_read_poll<span class="token lf">
</span>backend-&gt;CharDriverState: chr_can_read<span class="token lf">
</span>CharDriverState-&gt;user: can_read<span class="token lf">
</span>main_loop-&gt;iohandler: qemu_iohandler_poll<span class="token lf">
</span>iohandler-&gt;backend: fd_read<span class="token lf">
</span>backend-&gt;CharDriverState: chr_read<span class="token lf">
</span>CharDriverState-&gt;user: read<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-66"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> CharBuffer</span><span class="token lf">
</span><span class="token p">The problem of writing to a CharDriverState is that it doesn't tell how many bytes it can accept, nor notify the user when it's ready to accept data again. The actual accepted length of data depends wholly on the underlying implementation.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Android emulator provides a wrapper with internal bipartite buffers on top of CharDriverState called <span class="token em"><span class="token md md-em md-start">*</span>CharBuffer<span class="token md md-em md-close">*</span></span>. CharBuffer is created through <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemu<span class="token em"><span class="token md md-em md-start">_</span>chr<span class="token md md-em md-close">_</span></span>open_buffer()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/android/charpipe.h#L28</span><span class="token md md-paren-end">)</span></span>. It works as a CharDriverState but has different write implementation.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">On each write, CharBuffer tries to write as much as possible to the CharDriverState. The remaining bytes not accepted by the CharDriverState are stored to the internal buffer for writing later in the next event loop until it's empty.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">A use case is when user specifies a physical radio device on the host when launching emulator, the radio device will become the backend of a CharDriverState, and QEMUD will use a CharBuffer on top of the CharDriverState.</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-67"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>text<span class="token lf">
</span>+-------+       +-------------+               +--------------+<span class="token lf">
</span>| QEMUD |------&gt;| GSM Service |--CharBuffer--&gt;| Radio Device |<span class="token lf">
</span>+-------+       +-------------+               +--------------+<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-68"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> CharPipe</span><span class="token lf">
</span><span class="token p"><span class="token em"><span class="token md md-em md-start">*</span>CharBuffer<span class="token md md-em md-close">*</span></span> creates a write buffer on a CharDriverState, while <span class="token em"><span class="token md md-em md-start">*</span>CharPipe<span class="token md md-em md-close">*</span></span> works as if 2 CharBuffers are connected to each other -- it's used to create a bidirectional communication channel between 2 CharDriverState users. The CharPipe plays the backend of the CharDriverState on both sides, and also provides write buffers.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">CharPipe is created through <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">qemu<span class="token em"><span class="token md md-em md-start">_</span>chr<span class="token md md-em md-close">_</span></span>open_pipe()</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/android/charpipe.h#L21</span><span class="token md md-paren-end">)</span></span>. Writing on one endpoint triggers the read handler on the other endpoint directly. Remaining bytes not accepted by the read handler are stored to the internal buffer for retry later as how CharBuffer works.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">If user does not specify a physical radio device to use, QEMUD will use a CharPipe to connect to the internal emulated modem.</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-69"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>text<span class="token lf">
</span>+-------+       +-------------+                +-------------+<span class="token lf">
</span>| QEMUD |------&gt;| GSM Service |&lt;---CharPipe---&gt;| ModemDriver |<span class="token lf">
</span>+-------+       +-------------+                +-------------+<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-70"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> CharPipe / CharBuffer Polling</span><span class="token lf">
</span><span class="token p">As mentioned before, <span class="token link"><span class="token md md-bracket-start">[</span><span class="token md md-underlined-text ace_string">charpipe_poll</span><span class="token md md-bracket-end">](</span><span class="token md md-href">https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/charpipe.c#L442-L443</span><span class="token md md-paren-end">)</span></span> is invoked in the main loop. It triggers CharBuffers to re-writing remaining data in the buffers, and the read handlers of CharPipes to re-read.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-71"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> OpenGL Emulation</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-72"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>text<span class="token lf">
</span>         _________            __________          __________<span class="token lf">
</span>        |         |          |          |        |          |<span class="token lf">
</span>        |EMULATION|          |EMULATION |        |EMULATION |     GUEST<span class="token lf">
</span>        |   EGL   |          | GLES 1.1 |        | GLES 2.0 |     SYSTEM<span class="token lf">
</span>        |_________|          |__________|        |__________|     LIBRARIES<span class="token lf">
</span>             ^                    ^                    ^<span class="token lf">
</span>             |                    |                    |<span class="token lf">
</span>       - - - | - - - - - - - - -  | - - - - - - - - -  | - - - - -<span class="token lf">
</span>             |                    |                    |<span class="token lf">
</span>         ____v____________________v____________________v____      GUEST<span class="token lf">
</span>        |                                                   |     KERNEL<span class="token lf">
</span>        |                       QEMU PIPE                   |<span class="token lf">
</span>        |___________________________________________________|<span class="token lf">
</span>                                 ^<span class="token lf">
</span>                                 |<span class="token lf">
</span>      - - - - - - - - - - - - - -|- - - - - - - - - - - - - - - -<span class="token lf">
</span>                                 |<span class="token lf">
</span>                                 |    PROTOCOL BYTE STREAM<span class="token lf">
</span>                            _____v_____<span class="token lf">
</span>                           |           |<span class="token lf">
</span>                           |  EMULATOR |<span class="token lf">
</span>                           |___________|<span class="token lf">
</span>                                 ^<span class="token lf">
</span>                                 |   UNMODIFIED PROTOCOL BYTE STREAM<span class="token lf">
</span>                            _____v_____<span class="token lf">
</span>                           |           |<span class="token lf">
</span>                           |  RENDERER |<span class="token lf">
</span>                           |___________|<span class="token lf">
</span>                               ^ ^  ^<span class="token lf">
</span>                               | |  |<span class="token lf">
</span>             +-----------------+ |  +-----------------+<span class="token lf">
</span>             |                   |                    |<span class="token lf">
</span>         ____v____            ___v______          ____v_____<span class="token lf">
</span>        |         |          |          |        |          |<span class="token lf">
</span>        |TRANSLATOR          |TRANSLATOR|        |TRANSLATOR|     HOST<span class="token lf">
</span>        |   EGL   |          | GLES 1.1 |        | GLES 2.0 |     TRANSLATOR<span class="token lf">
</span>        |_________|          |__________|        |__________|     LIBRARIES<span class="token lf">
</span>             ^                    ^                    ^<span class="token lf">
</span>             |                    |                    |<span class="token lf">
</span>       - - - | - - - - - - - - -  | - - - - - - - - -  | - - - - -<span class="token lf">
</span>             |                    |                    |<span class="token lf">
</span>         ____v____            ____v_____          _____v____      HOST <span class="token lf">
</span>        |         |          |          |        |          |     SYSTEM<span class="token lf">
</span>        |   GLX   |          |  GL 2.0  |        |  GL 2.0  |     LIBRARIES<span class="token lf">
</span>        |_________|          |__________|        |__________|<span class="token lf">
</span><span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-73"><span class="token h2 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">##</span> Build Goldfish Kernel </span><span class="token lf">
</span><span class="token p">Follow the steps here if you're interested at building goldfish kernel by yourself.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-74"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Special Setup for Mac OS X</span><span class="token lf">
</span><span class="token p">Building qemu-kernel on Ubuntu Linux is quite straightforward, but on Mac OS X there are some tricks need to be done.</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-75"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Copy elfutils headers:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-76"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>bash<span class="token lf">
</span>cp ${B2G}/external/elfutils/host-darwin-fixup/* /usr/local/include/<span class="token lf">
</span>cp ${B2G}/external/elfutils/libelf/elf.h /usr/local/include/<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-77"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Create <span class="token code ace_support ace_function"><span class="token md md-code">`</span>/usr/local/include/linux/types.h<span class="token md md-code">`</span></span>:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-78"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>c<span class="token lf">
</span>#include &lt;stdint.h&gt;<span class="token lf">
</span><span class="token lf">
</span>#ifndef __u8<span class="token lf">
</span>typedef uint8_t __u8;<span class="token lf">
</span>#endif<span class="token lf">
</span><span class="token lf">
</span>#ifndef __u16<span class="token lf">
</span>typedef uint16_t __u16;<span class="token lf">
</span>#endif<span class="token lf">
</span><span class="token lf">
</span>#ifndef __u32<span class="token lf">
</span>typedef uint32_t __u32;<span class="token lf">
</span>#endif<span class="token lf">
</span><span class="token lf">
</span>#ifndef __u64<span class="token lf">
</span>typedef uint64_t __u64;<span class="token lf">
</span>#endif<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-79"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Install GNU sed. </span><span class="token lf">
</span><span class="token p">Linux kernel makefiles are not compatible with BSD sed:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-80"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>bash<span class="token lf">
</span>brew install gnu-sed<span class="token lf">
</span>export PATH="/usr/local/opt/gnu-sed/libexec/gnubin:$PATH"<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Otherwise you'll get this error compiling the kernel:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-81"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span><span class="token lf">
</span>arch/x86/boot/header.S: Assembler messages:<span class="token lf">
</span>arch/x86/boot/header.S:384: Error: can't resolve `VO__end' {*UND* section} - `VO__text' {*UND* section}<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-82"><span class="token h3 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">###</span> Build the Kernel</span><span class="token lf">
</span><span class="token p">This section applies to both Linux and Mac OS X.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Clean previous build with <span class="token code ace_support ace_function"><span class="token md md-code">`</span>make clean<span class="token md md-code">`</span></span> or clean all configs (only necessary for the very first time) with <span class="token code ace_support ace_function"><span class="token md md-code">`</span>make mrproper<span class="token md md-code">`</span></span>, then build the kernel (x86 as the example) with <span class="token code ace_support ace_function"><span class="token md md-code">`</span>build-kernel.sh<span class="token md md-code">`</span></span>:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-83"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>bash<span class="token lf">
</span>${B2G}/external/qemu/distrib/build-kernel.sh --arch=x86<span class="token lf">
</span># or ${AOSP}/prebuilts/qemu-kernel/build-kernel.sh --arch=x86<span class="token lf">
</span># omit --arch parameter to build arm kernel<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">The output should be at <span class="token code ace_support ace_function"><span class="token md md-code">`</span>/tmp/kernel-qemu<span class="token md md-code">`</span></span> directory.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">If the cross toolchain version differs from the default version (at the time this document is written, the default version is 4.8), pass <span class="token code ace_support ace_function"><span class="token md md-code">`</span>--gcc-version=&lt;version&gt;<span class="token md md-code">`</span></span>. If you're using an older version of build script and it doesn't have the option, export the path to cross compiler directly. For example:</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-84"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span><span class="token lf">
</span>export PATH=${PATH}:${B2G}/prebuilts/gcc/darwin-x86/x86/i686-linux-android-4.7/bin/<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-85"><span class="token h4 ace_markup ace_heading ace_constant ace_numeric"><span class="token md md-hash">####</span> Build the Kernel Manually</span><span class="token lf">
</span><span class="token p">To build kernel manually, export necessary variables</span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-86"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>bash<span class="token lf">
</span>export ARCH=x86 # or arm<span class="token lf">
</span>export SUBARCH=x86 # or am<span class="token lf">
</span>export REAL_CROSS_COMPILE=i686-linux-android-<span class="token lf">
</span># or x86_64-linux-android-<span class="token lf">
</span># or arm-linux-androideabi-<span class="token lf">
</span>export CROSS_COMPILE=${B2G}/external/qemu/distrib/kernel-toolchain/android-kernel-toolchain-<span class="token lf">
</span># or CROSS_COMPILE=${AOSP}/prebuilts/qemu-kernel/kernel-toolchain/android-kernel-toolchain-<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">Then build the kernel with </span><span class="token lf">
</span></span><span class="wmd-input-section" id="wmd-input-section-87"><span class="token pre gfm ace_support ace_function"><span class="token md md-pre">```</span>bash<span class="token lf">
</span>make distclean # optional, to clean all configs, outputs, etc.<span class="token lf">
</span>make goldfish_defconfig # or goldfish_armv7_defconfig for arm<span class="token lf">
</span>make nconfig # optional, only if you want to change the config<span class="token lf">
</span>make -j8<span class="token lf">
</span><span class="token md md-pre">```</span></span><span class="token lf">
</span><span class="token lf">
</span><span class="token p">The output should be at <span class="token code ace_support ace_function"><span class="token md md-code">`</span>arch/arm/boot/zImage<span class="token md md-code">`</span></span> or <span class="token code ace_support ace_function"><span class="token md md-code">`</span>arch/x86/boot/bzImage<span class="token md md-code">`</span></span>. Copy and rename it to <span class="token code ace_support ace_function"><span class="token md md-code">`</span>kernel-qemu<span class="token md md-code">`</span></span> before use.</span><span class="token lf">
</span><span class="token lf">
</span><span class="token hr">------</span><span class="token lf">
</span><span class="token lf">
</span></span><span class="token lf">
</span></div><div style="width: 35px;" class="editor-margin"></div></pre>
            <pre id="ace-input" class="form-control"><div class="editor-content" contenteditable="true"></div><div class="editor-margin"></div></pre>
            <div style="transform: translate(600px, 0px); width: 600px; height: 678px;" class="preview-panel">
                <div style="-moz-user-select: none; height: 678px;" class="layout-resizer layout-resizer-preview open"></div>
                <div style="height: 60px;" class="layout-toggler layout-toggler-navbar btn btn-info open" title="Toggle navigation bar"><i class="icon-th"></i></div>
                <div class="layout-toggler layout-toggler-preview btn btn-info" title="Toggle preview"><i class="icon-none"></i></div>
                <div style="left: 0px; width: 600px; height: 678px;" class="preview-container">
                    <div style="padding-left: 130px; padding-right: 130px; padding-bottom: 618px;" id="preview-contents" class="note-content">
                        <div id="wmd-preview" class="preview-content"></div>
                    <div class="wmd-preview-section preview-content" id="wmd-preview-section-1">

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-2">

<h1 id="study-on-emulator">Study on Emulator</h1>

<p><div class="toc">
<ul>
<li><a href="#study-on-emulator">Study on Emulator</a><ul>
<li><a href="#prefix">Prefix</a></li>
<li><a href="#build-run-emulator">Build &amp; Run Emulator</a><ul>
<li><a href="#classic-and-qemu2-emulator">Classic and QEMU2 Emulator</a></li>
<li><a href="#build-emulator">Build Emulator</a></li>
<li><a href="#emulator-binaries">Emulator Binaries</a></li>
<li><a href="#launch-emulator-from-aosp-b2g-tree">Launch Emulator from AOSP / B2G Tree</a></li>
<li><a href="#use-writable-system-image">Use Writable System Image</a></li>
</ul>
</li>
<li><a href="#emulator-initialization">Emulator Initialization</a><ul>
<li><a href="#machine-initialization">Machine Initialization</a></li>
<li><a href="#the-main-loop">The Main Loop</a></li>
</ul>
</li>
<li><a href="#skin-ui-handling">Skin &amp; UI Handling</a></li>
<li><a href="#the-goldfish-virtual-platform">The Goldfish Virtual Platform</a><ul>
<li><a href="#goldfish-device-registration">Goldfish Device Registration</a></li>
<li><a href="#goldfish-platform-bus">Goldfish Platform Bus</a><ul>
<li><a href="#discoverability">Discoverability</a></li>
<li><a href="#virtual-device-design">Virtual Device Design</a></li>
<li><a href="#kernel-driver-implementation">Kernel Driver Implementation</a></li>
<li><a href="#procioports">/proc/ioports</a></li>
<li><a href="#prociomem">/proc/iomem</a></li>
</ul>
</li>
<li><a href="#emulator-implementation-x86">Emulator Implementation (x86)</a></li>
<li><a href="#qemu-pipe-goldfish-pipe">QEMU Pipe / Goldfish Pipe</a><ul>
<li><a href="#qemu-pipe-services">QEMU Pipe Services</a><ul>
<li><a href="#workflow">Workflow</a></li>
</ul>
</li>
<li><a href="#adaptation-of-legacy-qemud">Adaptation of Legacy QEMUD</a><ul>
<li><a href="#initialization-flow">Initialization Flow</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#qemud-services">QEMUD Services</a><ul>
<li><a href="#workflow-1">Workflow</a></li>
<li><a href="#initialization">Initialization</a></li>
<li><a href="#client-sends-messages">Client Sends Messages</a></li>
<li><a href="#client-reads-messages">Client Reads Messages</a></li>
</ul>
</li>
<li><a href="#chardriverstate">CharDriverState</a><ul>
<li><a href="#initialization-1">Initialization</a></li>
<li><a href="#writing">Writing</a></li>
<li><a href="#reading">Reading</a></li>
<li><a href="#charbuffer">CharBuffer</a></li>
<li><a href="#charpipe">CharPipe</a></li>
<li><a href="#charpipe-charbuffer-polling">CharPipe / CharBuffer Polling</a></li>
</ul>
</li>
<li><a href="#opengl-emulation">OpenGL Emulation</a></li>
</ul>
</li>
<li><a href="#build-goldfish-kernel">Build Goldfish Kernel</a><ul>
<li><a href="#special-setup-for-mac-os-x">Special Setup for Mac OS X</a><ul>
<li><a href="#copy-elfutils-headers">Copy elfutils headers:</a></li>
<li><a href="#create-usrlocalincludelinuxtypesh">Create /usr/local/include/linux/types.h:</a></li>
<li><a href="#install-gnu-sed">Install GNU sed.</a></li>
</ul>
</li>
<li><a href="#build-the-kernel">Build the Kernel</a><ul>
<li><a href="#build-the-kernel-manually">Build the Kernel Manually</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-3">

<h2 id="prefix">Prefix</h2>

<p>The study focuses on the branch <code>emu-master-dev</code> implementation of the <em>classic</em> Android emulator, in combination of gonk layer and kernel used in <code>emulator-x86-kk</code>. Mozilla’s customization is not a main focus in this document, but might still be referred.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-4">

<h2 id="build-run-emulator">Build &amp; Run Emulator</h2>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-5">

<h3 id="classic-and-qemu2-emulator">Classic and QEMU2 Emulator</h3>

<p>The original emulator was based on QEMU 0.10.5 around 2009. There’s a
 new project based on QEMU 2.2.0 for Android M or later. Therefore, the 
legacy emulator is referred as <em>classic</em> emulator while the new emulator is referred as <em>qemu2</em> emulator.</p>

<p>To summary, here’s the comparison.</p>

<table>
<thead>
<tr>
  <th></th>
  <th>classic</th>
  <th>qemu2</th>
</tr>
</thead>
<tbody><tr>
  <td>QEMU Version</td>
  <td>0.10.5</td>
  <td>2.2.0</td>
</tr>
<tr>
  <td>Since</td>
  <td>~2009</td>
  <td>~2014</td>
</tr>
<tr>
  <td>Virtual Platform</td>
  <td>Goldfish</td>
  <td>Ranchu</td>
</tr>
<tr>
  <td>Compatible Android Versions</td>
  <td>Cupcake ~ Lollipop</td>
  <td>M ~</td>
</tr>
<tr>
  <td>Support Emulation Arch</td>
  <td>x86, arm, mips</td>
  <td>arm64, mips64</td>
</tr>
</tbody></table>


</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-6">

<h3 id="build-emulator">Build Emulator</h3>

<p>Get the latest dev branch source code:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-7">

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">$ mkdir emu-master-dev &amp;&amp; <span class="hljs-built_in">cd</span> emu-master-dev<br>$ repo init -u https://android.googlesource.com/platform/manifest -b emu-master-dev<br>$ repo sync<br></code></pre>

<p>Use the build script to build <em>classic</em> and <em>qemu2</em> emulators:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-8">

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">$ <span class="hljs-built_in">cd</span> external/qemu<br>$ ./android-rebuild.sh --build-qemu-android<br></code></pre>

<blockquote>
  <p>To build with the experimental Qt GUI, pass <code>--ui=qt</code>. The default is SDL2.</p>
</blockquote>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-9">

<h3 id="emulator-binaries">Emulator Binaries</h3>

<p><img longdesc="./emulator.png" alt="Alt text" title="" type="image/png" src="blob:http://marxi.co/67dce4e8-f5b3-da42-a9ad-86c0ad3d7665" class=""></p>

<ul><li><strong>emulator</strong> - front-end used to find proper emulation engine and setup environment variables (mainly <code>LD_LIBRARY_PATH</code>).</li>
<li><strong>green nodes</strong> - classic emulation engines.</li>
<li><strong>blue nodes</strong> - qemu2 emulation engines.</li>
<li><strong>orange nodes</strong> - GLES / EGL emulation libraries.</li>
</ul>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-10">

<h3 id="launch-emulator-from-aosp-b2g-tree">Launch Emulator from AOSP / B2G Tree</h3>

<p>Besides using AVD or passing everything through the command line arguments, emulator is capable of finding images from the built AOSP / B2G tree directly if you have proper environment variables set. Here’s an example:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-11">

<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><span class="hljs-comment"># In ${B2G} or ${AOSP}</span><br>$ <span class="hljs-built_in">export</span> ANDROID_BUILD_TOP=<span class="hljs-variable">${PWD}</span><br>$ <span class="hljs-built_in">export</span> ANDROID_PRODUCT_OUT=<span class="hljs-variable">${PWD}</span>/out/target/product/generic_x86/<br>$ ./out/host/darwin-x86/bin/emulator -gpu on <br></code></pre>

<p>If the emulator doesn’t boot, try deleting <code>${ANDROID_PRODUCT_OUT}/userdata-qemu.img</code> first. Note that <code>-gpu on</code> is necessary for B2G. </p>

<p>To show kernel message, use <code>-show-kernel</code>. The message is redirected through the emulated system’s <code>ttyS0</code> or <code>ttyGF0</code> (goldfish tty).</p>

<p>For older emulator builds, qemu monitor can be redirected to stdio through <code>-qemu -monitor stdio</code>, but it’s no longer support in newer code. See <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/console.c#L2601">console.c</a>.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-12">

<h3 id="use-writable-system-image">Use Writable System Image</h3>

<p>By default, <code>system.img</code> and <code>userdata.img</code> are read only init images, while <code>system-qemu.img</code> and <code>userdata-qemu.img</code> are writable. See <code>emulator -help-disk-images</code> for more information.</p>

<p>In usual case, a writable image is created under <code>/tmp/android-xxx/</code>. To use a writable system image on boot directly, simply move <code>${ANDROID_PRODUCT_OUT}/system.img</code> to <code>${ANDROID_PRODUCT_OUT}/system-qemu.img</code>.</p>

<blockquote>
  <p>The emulator version used in emulator-x86-kk has a bug and it complains <code>ko:Missing initial system image path!</code> when using <code>system-qemu.img</code>. It’s fixed in newer versions.</p>
</blockquote>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-13">

<h2 id="emulator-initialization">Emulator Initialization</h2>

<p><em>android/main-emulator.c:main</em> <br>
It all starts with the front-end binary <code>emulator</code> at <a target="_blank" href="http://marxi.co/%28https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/main-emulator.c#L87%29">main-emulator.c</a>. It’s checks whether it should launch a 32 or 64 bits emulation engine, what emulation architecture it should pick, and setup necessary environment variables such as <code>LD_LIBRARY_PATH</code>.</p>

<p><em>android/main.c:main</em> <br>
The main function of an emulation engine binary is at <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/main.c#L171">main.c</a>. The main function setups UI skin window (with SDL2 or Qt5), parses the given AVD and auto-config for missing properties. Eventually it generates a full list of final hardware configuration at <code>hardware-qemu.ini</code>, and pass the final configuration to another core main function at <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/vl-android.c#L2144">vl-android.c</a>. The core main function is redefined as <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/vl-android.c#L234">qemu_main</a> at compiling.</p>

<blockquote>
  <p>Although skin window is setup here, nothing is shown on screen, even the window itself, until <code>qemu_main</code> finishes machine setup and trigger the skin window to start working.</p>
</blockquote>

<p><em>vl-android.c:main</em> <br>
<code>qemu_main</code> is the most interesting part of the initialization. It takes care of initializing all virtual hardware, as well as some android specific services defined in <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/qemu-setup.c#L229">android_emulation_setup()</a> – mainly the telnet console and adb support. Most importantly, it starts the <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/main-loop.c#L311">main loop</a>, which is the core of all I/O handling in QEMU. </p>

<p>The main loop runs on main thread when using SDL2, on the other hand, since Qt has its own event loop and must run on main thread, the QEMU main loop has to be run in a background thread when using Qt.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-14">

<h3 id="machine-initialization">Machine Initialization</h3>

<p>In order to initialize proper platform on different emulation engine, each CPU-specific emulation engine (e.g. <code>emulator64-x86</code>) registers its emulated machines statically through <code>machine_init</code> statement. </p>

<p>The macro generates a function to register a machine with gcc special attribute <code>__attribute__((constructor))</code>, which conceptually resembles static constructor in modern languages, and is invoked when the program loads.</p>

<ul><li><a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/i386/pc.c#L1332">x86 machine registration</a></li>
<li><a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/android_arm.c#L159">arm machine registration</a></li>
</ul>

<p>Later in <code>qemu_main</code>, it invokes <code>module_call_init(MODULE_INIT_MACHINE)</code>, which triggers the registered machine initialization function to initialize the platform.</p>

<p>Refer <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/qemu/module.h#L34">machine_init()</a>, <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/qemu/module.h#L18-L21">module_init()</a>, <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/util/module.c#L58-L69">register_module_init()</a>, and <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/hw/boards.h#L15-L23">QEMUMachine</a>.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-15">

<h3 id="the-main-loop">The Main Loop</h3>

<p>The core of qemu is designed to be event driven (although worker threads are also used in some cases) by using an event loop. Quote the description from <a target="_blank" href="http://blog.vmsplice.net/2011/03/qemu-internals-overall-architecture-and.html">QEMU Internals: Overall architecture and threading model</a>: </p>

<p><em>QEMU’s main event loop is <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/main-loop.c#L262">main_loop_wait()</a> and it performs the following tasks:</em></p>

<ol><li rel="1"><p><em>Waits for file descriptors to become readable or writable. File descriptors play a critical role because files, sockets, pipes, and various other resources are all file descriptors. File descriptors can be added using qemu_set_fd_handler().</em></p>

<blockquote>
  <p>In Android emulator, the main loop also <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/main-loop.c#L299">polls charpipe</a> right after file descriptors which will be explained later.</p>
</blockquote></li>
<li rel="2"><p><em>Runs expired timers. Timers can be added using qemu_mod_timer().</em></p></li>
<li rel="3"><em>Runs bottom-halves (BHs), which are like timers that expire immediately. BHs are used to avoid reentrancy and overflowing the call stack. BHs can be added using qemu_bh_schedule().</em></li>
</ol>

<p>The term <em>bottom half</em> mentioned above comes from the concept of <a target="_blank" href="http://www.makelinux.net/ldd3/chp-10-sect-4">Linux Device Driver</a>, where interrupt handlers can choose to delay lengthy works later. In QEMU, this applies to event / timer handlers instead. Those handlers can schedule bottom halves to do some jobs later, and since executing bottom halves is the last step of an event loop, bottom halves are done in the same event loop as where they were scheduled. </p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-16">

<div rel="4f113cdb2de02e994ff99e0fc873a334" class="flow-chart"><svg style="overflow: hidden; position: relative; top: -0.100098px;" xmlns="http://www.w3.org/2000/svg" width="206.36666870117188" version="1.1" height="401.58333015441895"><desc>Created with Raphaël 2.1.0</desc><defs><marker refY="1.5" refX="1.5" orient="auto" markerWidth="3" markerHeight="3" id="raphael-marker-endblock33"><use stroke="none" fill="black" stroke-width="1.6667" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" xlink:href="#raphael-marker-block"></use></marker></defs><rect transform="matrix(1,0,0,1,38.8,2)" stroke-width="2" style="" stroke="#000000" fill="#ffffff" ry="0" rx="0" r="0" height="37.91666603088379" width="128.76667022705078" y="0" x="0"></rect><text transform="matrix(1,0,0,1,38.8,2)" font-weight="normal" font-family="sans-serif" font-size="14px" fill="#000000" stroke="#000000" font="10px &quot;Arial&quot;" text-anchor="start" y="18.958333015441895" x="10" style="text-anchor: start; font: 14px sans-serif;"><tspan dy="5.625000953674316">select(rfd, timer)</tspan></text><rect transform="matrix(1,0,0,1,23.25,91.9167)" stroke-width="2" style="" stroke="#000000" fill="#ffffff" ry="0" rx="0" r="0" height="37.91666603088379" width="159.86666870117188" y="0" x="0"></rect><text transform="matrix(1,0,0,1,23.25,91.9167)" font-weight="normal" font-family="sans-serif" font-size="14px" fill="#000000" stroke="#000000" font="10px &quot;Arial&quot;" text-anchor="start" y="18.958333015441895" x="10" style="text-anchor: start; font: 14px sans-serif;"><tspan dy="5.625000953674316">qemu_iohandler_poll</tspan></text><rect transform="matrix(1,0,0,1,47.6833,181.8333)" stroke-width="2" style="" stroke="#000000" fill="#ffffff" ry="0" rx="0" r="0" height="37.91666603088379" width="111" y="0" x="0"></rect><text transform="matrix(1,0,0,1,47.6833,181.8333)" font-weight="normal" font-family="sans-serif" font-size="14px" fill="#000000" stroke="#000000" font="10px &quot;Arial&quot;" text-anchor="start" y="18.958333015441895" x="10" style="text-anchor: start; font: 14px sans-serif;"><tspan dy="5.625000953674316">charpipe_poll</tspan></text><rect transform="matrix(1,0,0,1,2,271.75)" stroke-width="2" style="" stroke="#000000" fill="#ffffff" ry="0" rx="0" r="0" height="37.91666603088379" width="202.36666870117188" y="0" x="0"></rect><text transform="matrix(1,0,0,1,2,271.75)" font-weight="normal" font-family="sans-serif" font-size="14px" fill="#000000" stroke="#000000" font="10px &quot;Arial&quot;" text-anchor="start" y="18.958333015441895" x="10" style="text-anchor: start; font: 14px sans-serif;"><tspan dy="5.625000953674316">qemu_clock_run_all_timers</tspan></text><rect transform="matrix(1,0,0,1,45.575,361.6667)" stroke-width="2" style="" stroke="#000000" fill="#ffffff" ry="0" rx="0" r="0" height="37.91666603088379" width="115.21666717529297" y="0" x="0"></rect><text transform="matrix(1,0,0,1,45.575,361.6667)" font-weight="normal" font-family="sans-serif" font-size="14px" fill="#000000" stroke="#000000" font="10px &quot;Arial&quot;" text-anchor="start" y="18.958333015441895" x="10" style="text-anchor: start; font: 14px sans-serif;"><tspan dy="5.625000953674316">qemu_bh_poll</tspan><tspan x="10" dy="18"></tspan></text><path font-weight="normal" font-family="sans-serif" marker-end="url(#raphael-marker-endblock33)" stroke-width="2" d="M103.18333435058594,39.91666603088379C103.18333435058594,39.91666603088379,103.18333435058594,77.84144496917725,103.18333435058594,88.91518413182348" stroke="#000000" fill="none" style="font-family: sans-serif; font-weight: normal;"></path><path font-weight="normal" font-family="sans-serif" marker-end="url(#raphael-marker-endblock33)" stroke-width="2" d="M103.18333435058594,129.83333206176758C103.18333435058594,129.83333206176758,103.18333435058594,167.75811100006104,103.18333435058594,178.83185016270727" stroke="#000000" fill="none" style="font-family: sans-serif; font-weight: normal;"></path><path font-weight="normal" font-family="sans-serif" marker-end="url(#raphael-marker-endblock33)" stroke-width="2" d="M103.18333435058594,219.74999809265137C103.18333435058594,219.74999809265137,103.18333435058594,257.6747770309448,103.18333435058594,268.74851619359106" stroke="#000000" fill="none" style="font-family: sans-serif; font-weight: normal;"></path><path font-weight="normal" font-family="sans-serif" marker-end="url(#raphael-marker-endblock33)" stroke-width="2" d="M103.18333435058594,309.66666412353516C103.18333435058594,309.66666412353516,103.18333435058594,347.5914430618286,103.18333435058594,358.66518222447485" stroke="#000000" fill="none" style="font-family: sans-serif; font-weight: normal;"></path></svg></div>

<blockquote>
  <p>The main loop is often referred as iothread. If you’re interested at QEMU’s threading and event handling, check <a target="_blank" href="http://events.linuxfoundation.org/sites/events/files/slides/Improving%20the%20QEMU%20Event%20Loop%20-%203.pdf">Improving the QEMU Event Loop</a> from KVM Forum 2015.</p>
</blockquote>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-17">

<h2 id="skin-ui-handling">Skin &amp; UI Handling</h2>

<p>Android emulator is designed to use a 60Hz refresh rate no matter how the underlying window system handles input events. It’s done by registering the <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/vl-android.c#L1202-L1217">gui_update()</a> callback (or <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/vl-android.c#L1219-L1224">nographic_update()</a> in case the emulator is launched with <code>-nographic</code>) with a timer to the main-loop. </p>

<p>The timer times out around every 16ms. On each timeout, the callback updates framebuffer if OpenGL emulation is not enabled, collects input events and send the input events to the goldfish kernel.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-18">

<div rel="10bb6bba9e3db92529ff81136e73c688" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.25px;" xmlns="http://www.w3.org/2000/svg" width="1408.9000053405762" version="1.1" height="524.9999923706055"><desc>Created with Raphaël 2.1.0</desc><defs><path id="raphael-marker-block" d="M5,0 0,2.5 5,5z" stroke-linecap="round"></path><marker refY="2.5" refX="2.5" orient="auto" markerWidth="5" markerHeight="5" id="raphael-marker-endblock55"><use stroke="none" fill="#000" stroke-width="1.0000" transform="rotate(180 2.5 2.5) scale(1,1)" xlink:href="#raphael-marker-block"></use></marker></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="90.21666717529297" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="70.21666717529297" y="30" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="55.108333587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">main_loop</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="90.21666717529297" y="467.0833263397217" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="70.21666717529297" y="477.0833435058594" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="55.108333587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">main_loop</tspan></text><path stroke-width="2" d="M55.108333587646484,57.91666603088379L55.108333587646484,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="89.93333435058594" y="20" x="120.21666717529297"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="69.93333435058594" y="30" x="130.2166748046875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="165.18333435058594" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">vl_android</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="89.93333435058594" y="467.0833263397217" x="120.21666717529297"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="69.93333435058594" y="477.0833435058594" x="130.2166748046875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="165.18333435058594" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">vl_android</tspan></text><path stroke-width="2" d="M165.18333435058594,57.91666603088379L165.18333435058594,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="73.28333282470703" y="20" x="230.1500015258789"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="53.28333282470703" y="30" x="240.14999389648438"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="266.7916679382324" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">console</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="73.28333282470703" y="467.0833263397217" x="230.1500015258789"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="53.28333282470703" y="477.0833435058594" x="240.14999389648438"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="266.7916679382324" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">console</tspan></text><path stroke-width="2" d="M266.7916679382324,57.91666603088379L266.7916679382324,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="68.28333282470703" y="20" x="412.5166702270508"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="48.28333282470703" y="30" x="422.51666259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="446.6583366394043" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">display</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="68.28333282470703" y="467.0833263397217" x="412.5166702270508"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="48.28333282470703" y="477.0833435058594" x="422.51666259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="446.6583366394043" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">display</tspan></text><path stroke-width="2" d="M446.6583366394043,57.91666603088379L446.6583366394043,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="98.05000305175781" y="20" x="536.1666679382324"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="78.05000305175781" y="30" x="546.1749877929688"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="585.1916694641113" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">framebuffer</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="98.05000305175781" y="467.0833263397217" x="536.1666679382324"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="78.05000305175781" y="477.0833435058594" x="546.1749877929688"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="585.1916694641113" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">framebuffer</tspan></text><path stroke-width="2" d="M585.1916694641113,57.91666603088379L585.1916694641113,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="139.03333282470703" y="20" x="858.0250091552734"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="119.03333282470703" y="30" x="868.0250244140625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="927.541675567627" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">emulator_window</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="139.03333282470703" y="467.0833263397217" x="858.0250091552734"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="119.03333282470703" y="477.0833435058594" x="868.0250244140625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="927.541675567627" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">emulator_window</tspan></text><path stroke-width="2" d="M927.541675567627,57.91666603088379L927.541675567627,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="32.483333587646484" y="20" x="1090.633337020874"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="12.483333587646484" y="30" x="1100.63330078125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="1106.8750038146973" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">ui</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="32.483333587646484" y="467.0833263397217" x="1090.633337020874"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="12.483333587646484" y="477.0833435058594" x="1100.63330078125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="1106.8750038146973" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">ui</tspan></text><path stroke-width="2" d="M1106.8750038146973,57.91666603088379L1106.8750038146973,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="111.58333587646484" y="20" x="1174.6166687011719"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="91.58333587646484" y="30" x="1184.61669921875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="1230.4083366394043" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">event_sdl2/qt</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="111.58333587646484" y="467.0833263397217" x="1174.6166687011719"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="91.58333587646484" y="477.0833435058594" x="1184.61669921875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="1230.4083366394043" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">event_sdl2/qt</tspan></text><path stroke-width="2" d="M1230.4083366394043,57.91666603088379L1230.4083366394043,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="72.70000076293945" y="20" x="1306.2000045776367"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="52.70000076293945" y="30" x="1316.2000732421875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="1342.5500049591064" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">window</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="72.70000076293945" y="467.0833263397217" x="1306.2000045776367"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="52.70000076293945" y="477.0833435058594" x="1316.2000732421875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="1342.5500049591064" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">window</tspan></text><path stroke-width="2" d="M1342.5500049591064,57.91666603088379L1342.5500049591064,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="75.5" y="73.95833587646484" x="72.39583587646484"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="110.14583396911621" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">gui_update</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M55.108333587646484,95.83333206176758C55.108333587646484,95.83333206176758,138.6805455561364,95.83333206176758,160.18569971013744,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="79.4000015258789" y="111.875" x="176.28750610351562"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="215.98750114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">dpy_refresh</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M165.18333435058594,133.74999809265137C165.18333435058594,133.74999809265137,241.33631307469386,133.74999809265137,261.7875524781408,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="159.86666870117188" y="149.79165649414062" x="276.79168701171875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="356.72500228881836" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">android_display_refresh</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M266.7916679382324,171.66666412353516C266.7916679382324,171.66666412353516,412.6101657830877,171.66666412353516,441.6599446506175,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="118.53333282470703" y="187.7083282470703" x="456.6583251953125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="515.9250030517578" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">qframebuffer_poll</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M446.6583366394043,209.58333015441895C446.6583366394043,209.58333015441895,555.4030926129167,209.58333015441895,580.1998704642987,209.58333015441895" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="172.3333282470703" y="225.625" x="670.2000122070312"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="234.58333015441895" x="756.3666725158691" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624997138977051">emulator_window_refresh</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M585.1916694641113,247.49999618530273C585.1916694641113,247.49999618530273,880.3146952047337,247.49999618530273,922.5368858990707,247.49999618530273" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="196.5833282470703" y="263.54168701171875" x="658.0750122070312"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="272.49999618530273" x="756.3666725158691" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">qframebuffer_check_updates</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M927.541675567627,285.4166622161865C927.541675567627,285.4166622161865,632.4186498270046,285.4166622161865,590.1964591326675,285.4166622161865" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="302.3500061035156" y="305.4166622161865" x="605.1916694641113"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="292.3500061035156" y="310.41668701171875" x="610.1917114257812"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="319.3749952316284" x="756.3666725158691" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625005722045898">update framebuffer if no OpenGL emulation</tspan></text><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="159.3333282470703" y="349.375" x="937.5416259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="358.3333282470703" x="1017.2083396911621" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625025749206543">skin_ui_process_events</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M927.541675567627,371.2499942779541C927.541675567627,371.2499942779541,1072.8489604507386,371.2499942779541,1101.8678469337428,371.2499942779541" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="103.53333282470703" y="387.29168701171875" x="1116.875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="396.2499942779541" x="1168.6416702270508" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">skin_event_poll</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M1106.8750038146973,409.1666603088379C1106.8750038146973,409.1666603088379,1202.3015628700377,409.1666603088379,1225.412682641253,409.1666603088379" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="192.0833282470703" y="425.2083435058594" x="1128.6708984375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="434.1666603088379" x="1224.7125043869019" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625014305114746">skin_window_process_event</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M1106.8750038146973,447.0833263397217C1106.8750038146973,447.0833263397217,1303.468451183504,447.0833263397217,1337.5459286326866,447.0833263397217" stroke="#000000" fill="none" style=""></path></svg></div>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-19">

<h2 id="the-goldfish-virtual-platform">The Goldfish Virtual Platform</h2>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-20">

<h3 id="goldfish-device-registration">Goldfish Device Registration</h3>

<p>The core of goldfish device registration is <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/goldfish/device.c#L99-L102">goldfish_device_add()</a>:</p>

<ul><li>dev: the device description, refer <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/hw/android/goldfish/device.h#L18-L29">goldfish_device</a>.</li>
<li>mem_read: an array of callbacks for <em>byte</em>, <em>word</em> and <em>dword</em> memory read operations, respectively. See <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/exec/cpu-common.h#L59">CPUReadMemoryFunc</a>.</li>
<li>mem_wrtie: an array of callbacks for <em>byte</em>, <em>word</em> and <em>dword</em> memory write operations, respectively. See <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/exec/cpu-common.h#L58">CPUWriteMemoryFunc</a>.</li>
<li>opaque: anything the caller wants to keep. It will be carried back to the mem_read / mem_write callback functions on invocation, which happens in <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/exec.c#L1610-L1611">subpage_readlen()</a> and <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/exec.c#L1626-L1628">subpage_writelen</a>.</li>
</ul>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-21">

<pre class="prettyprint hljs-dark"><code class="language-c hljs cpp"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">goldfish_device_add</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> goldfish_device *dev,<br>                       CPUReadMemoryFunc **mem_read,<br>                       CPUWriteMemoryFunc **mem_write,<br>                       <span class="hljs-keyword">void</span> *opaque)</span></span>;<br></code></pre>

<blockquote>
  <p>All the goldfish virtual hardware are appeared as platform devices – meaning they’re connected to CPU directly, not through any kind of buses. Further, goldfish virtual devices are all operated through memory-mapped I/O.</p>
</blockquote>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-22">

<h3 id="goldfish-platform-bus">Goldfish Platform Bus</h3>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-23">

<h4 id="discoverability">Discoverability</h4>

<p>Since a platform device is not naturally discoverable as it’s not connected through any kind of buses, the driver doesn’t know which I/O port, memory address or interrupt it should use.</p>

<p><em>Platform bus</em> is a special <em>platform device</em> to overcome this issue. It plays the role of a bus for other platform devices. Think about PCI.</p>

<blockquote>
  <p>In the new qemu-android implementation for Android M and later, it no longer uses <em>platform bus</em> in favor of <em>device tree</em>. Refer the article <a target="_blank" href="http://lwn.net/Articles/448502/">Platform devices and device trees</a> for more information about device trees.</p>
</blockquote>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-24">

<h4 id="virtual-device-design">Virtual Device Design</h4>

<ul><li>Goldfish Platform Bus uses the MMIO address region 0xff001000 to 0xff801000. </li>
<li>0xff001000 - 0xff001fff are reserved by <code>goldfish_device_bus</code> as a set of <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/docs/GOLDFISH-VIRTUAL-HARDWARE.TXT#L73-L89">32bit I/O registers</a> for bus operations.</li>
<li>The bus itself uses IRQ 1 on ARM with goldfish interrupt controller, and IRQ 4 on x86 with qemu’s built-in virtual i8259.</li>
</ul>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-25">

<h4 id="kernel-driver-implementation">Kernel Driver Implementation</h4>

<p><a target="_blank" href="https://github.com/mozilla-b2g/kernel_goldfish/blob/b2g-goldfish-3.4/arch/x86/mach-goldfish/pdev_bus.c">pdev_bus.c</a> registers a <em>platform device</em> <code>goldfish_pdev_bus</code> at I/O port 0x1000, which plays the role of a <em>platform bus</em>.</p>

<p>The bus scan process is as following:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-26">

<div rel="05c9e828982c6cbc850865f3d2a95b9e" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.316895px;" xmlns="http://www.w3.org/2000/svg" width="759.5583324432373" version="1.1" height="954.1666526794434"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="61.61666488647461" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="41.61666488647461" y="30" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="40.808332443237305" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">kernel</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="61.61666488647461" y="896.2499866485596" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="41.61666488647461" y="906.2499389648438" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="915.2083196640015" x="40.808332443237305" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62498664855957">kernel</tspan></text><path stroke-width="2" d="M40.808332443237305,57.91666603088379L40.808332443237305,896.2499866485596" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="86.36666870117188" y="20" x="377.6083354949951"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="66.36666870117188" y="30" x="387.60833740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="420.79166984558105" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">pdev_bus</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="86.36666870117188" y="896.2499866485596" x="377.6083354949951"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="66.36666870117188" y="906.2499389648438" x="387.60833740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="915.2083196640015" x="420.79166984558105" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62498664855957">pdev_bus</tspan></text><path stroke-width="2" d="M420.79166984558105,57.91666603088379L420.79166984558105,896.2499866485596" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="81.01667022705078" y="73.95833587646484" x="190.2916717529297"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">goldfish_init</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M40.808332443237305,95.83333206176758C40.808332443237305,95.83333206176758,371.0487667695188,95.83333206176758,415.79570061988164,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="359.98333740234375" y="111.875" x="50.80834197998047"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">platform_device_register(&amp;goldfish_pdev_bus_device)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M420.79166984558105,133.74999809265137C420.79166984558105,133.74999809265137,90.55123551929955,133.74999809265137,45.8043016689367,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="154.0500030517578" y="149.79165649414062" x="153.77500915527344"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">goldfish_pdev_bus_init</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M40.808332443237305,171.66666412353516C40.808332443237305,171.66666412353516,371.0487667695188,171.66666412353516,415.79570061988164,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="347.7166748046875" y="187.7083282470703" x="56.941673278808594"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">platform_driver_register(&amp;goldfish_pdev_bus_driver)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M420.79166984558105,209.58333015441895C420.79166984558105,209.58333015441895,90.55123551929955,209.58333015441895,45.8043016689367,209.58333015441895" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="210.11666870117188" y="229.58333015441895" x="60.808332443237305"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="200.11666870117188" y="234.5833282470703" x="65.80833435058594"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="243.54166316986084" x="165.86666679382324" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">found driver / device matches</tspan></text><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="173.5" y="273.54168701171875" x="144.0500030517578"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="282.49999618530273" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">goldfish_pdev_bus_probe</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M40.808332443237305,295.4166622161865C40.808332443237305,295.4166622161865,371.0487667695188,295.4166622161865,415.79570061988164,295.4166622161865" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="36.58333206176758" y="311.4583435058594" x="212.50833129882812"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="320.4166622161865" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625016212463379">writel</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M420.79166984558105,333.3333282470703C420.79166984558105,333.3333282470703,90.55123551929955,333.3333282470703,45.8043016689367,333.3333282470703" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="135.98332977294922" y="353.3333282470703" x="60.808332443237305"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="125.98332977294922" y="358.3333435058594" x="65.80833435058594"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="367.2916612625122" x="128.7999973297119" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.6250152587890625">goldfish_bus_write</tspan></text><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="75.5" y="397.29168701171875" x="193.0500030517578"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="406.2499942779541" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">request_irq</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M420.79166984558105,419.1666603088379C420.79166984558105,419.1666603088379,90.55123551929955,419.1666603088379,45.8043016689367,419.1666603088379" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="190.68333435058594" y="435.2083435058594" x="135.45834350585938"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="444.1666603088379" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625014305114746">goldfish_pdev_bus_interrupt</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M40.808332443237305,457.0833263397217C40.808332443237305,457.0833263397217,371.0487667695188,457.0833263397217,415.79570061988164,457.0833263397217" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="33.849998474121094" y="473.125" x="213.875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="482.0833263397217" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62502384185791">readl</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M420.79166984558105,494.99999237060547C420.79166984558105,494.99999237060547,90.55123551929955,494.99999237060547,45.8043016689367,494.99999237060547" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="133.25" y="514.9999923706055" x="60.808332443237305"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="123.25" y="520" x="65.80833435058594"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="528.9583253860474" x="127.4333324432373" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">goldfish_bus_read</tspan></text><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="129.89999389648438" y="562.9166259765625" x="445.7916564941406"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="571.8749914169312" x="510.74166679382324" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624971389770508">goldfish_new_pdev</tspan></text><path stroke-dasharray="0" stroke-width="2" d="M420.79166984558105,557.9166584014893L440.79166984558105,557.9166584014893" stroke="#000000" fill="none" style=""></path><path stroke-dasharray="0" stroke-width="2" d="M440.79166984558105,557.9166584014893L440.79166984558105,590.833324432373" stroke="#000000" fill="none" style=""></path><path marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" stroke-width="2" d="M440.79166984558105,590.833324432373C440.79166984558105,590.833324432373,431.71078300476074,590.833324432373,425.78692322969437,590.833324432373" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="33.849998474121094" y="596.875" x="213.875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="605.833324432373" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624991416931152">readl</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M420.79166984558105,618.7499904632568C420.79166984558105,618.7499904632568,90.55123551929955,618.7499904632568,45.8043016689367,618.7499904632568" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="133.25" y="638.7499904632568" x="60.808332443237305"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="123.25" y="643.75" x="65.80833435058594"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="652.7083234786987" x="127.4333324432373" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624990463256836">goldfish_bus_read</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="225.5833282470703" y="686.6666564941406" x="440.79166984558105"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="215.5833282470703" y="691.6666259765625" x="445.7916564941406"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="700.6249895095825" x="553.5833339691162" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624969482421875">loop until all devices info loaded</tspan></text><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="237.5833282470703" y="730.625" x="112.00833892822266"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="739.5833225250244" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.6249895095825195">schedule_work(&amp;pdev_bus_worker)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M420.79166984558105,752.4999885559082C420.79166984558105,752.4999885559082,90.55123551929955,752.4999885559082,45.8043016689367,752.4999885559082" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="147.93333435058594" y="768.5416259765625" x="156.8416748046875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="777.4999885559082" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624968528747559">goldfish_pdev_worker</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M40.808332443237305,790.416654586792C40.808332443237305,790.416654586792,371.0487667695188,790.416654586792,415.79570061988164,790.416654586792" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="165.39999389648438" y="806.4583129882812" x="148.10833740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="815.416654586792" x="230.80000114440918" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625008583068848">platform_device_register</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M420.79166984558105,828.3333206176758C420.79166984558105,828.3333206176758,90.55123551929955,828.3333206176758,45.8043016689367,828.3333206176758" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="217.5500030517578" y="848.3333206176758" x="440.79166984558105"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="207.5500030517578" y="853.3333129882812" x="445.7916564941406"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="862.2916536331177" x="549.56667137146" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625007629394531">loop until all devices registered</tspan></text></svg></div>

<p>After the bus scan finishes, <code>goldfish_pdev_bus_device</code> can be removed through <code>platform_device_unregister</code>, although the driver didn’t do so. </p>

<p>Those platform devices registered still need corresponding drivers to work. For exmaple, the driver for <em>qemu_pipe</em> is at <a target="_blank" href="https://github.com/mozilla-b2g/kernel_goldfish/blob/b2g-goldfish-3.4/drivers/misc/qemupipe/qemu_pipe.c">qemu_pipe.c</a>.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-27">

<h4 id="procioports">/proc/ioports</h4>

<p>/proc/ioports lists all registered PMIO. <code>goldfish_pdev_bus</code> is registered at I/O port 0x1000.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-28">

<pre class="prettyprint hljs-dark"><code class="language-text hljs">0000-001f : dma1
0020-0021 : pic1
0040-0043 : timer0
0050-0053 : timer1
0060-0060 : keyboard
0064-0064 : keyboard
0070-0071 : rtc_cmos
  0070-0071 : rtc0
0080-008f : dma page reg
00a0-00a1 : pic2
00c0-00df : dma2
00f0-00ff : fpu
03c0-03df : vga+
0cf8-0cff : PCI conf1
1000-10ff : goldfish_pdev_bus
c000-c0ff : 0000:00:02.0
  c000-c01f : ne2k-pci</code></pre>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-29">

<h4 id="prociomem">/proc/iomem</h4>

<p>/proc/iomen lists all registered MMIO and real memory.</p>

<p><code>goldfish_device_bus</code> is a special device which contains only the bus state for bus scanning only. It can be thought as the corresponding device implementation of <code>goldfish_pdev_bus_device</code>, and can also be removed after scan finishes.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-30">

<pre class="prettyprint hljs-dark"><code class="language-text hljs">00000000-0000ffff : reserved
00010000-0009efff : System RAM
0009f000-0009ffff : reserved
000a0000-000bffff : Video RAM area
000c0000-000c8bff : Video ROM
000c9000-000c91ff : Adapter ROM
000e8000-000fffff : reserved
  000f0000-000fffff : System ROM
00100000-1ffeffff : System RAM
  00200000-0067f9ec : Kernel code
  0067f9ed-008906ff : Kernel data
  008dd000-00a3dfff : Kernel bss
1fff0000-1fffffff : ACPI Tables
ff001000-ff001fff : goldfish_device_bus
ff004000-ff004fff : goldfish_audio.0
ff005000-ff005fff : goldfish_mmc.0
ff010000-ff010fff : goldfish-battery.0
ff011000-ff011fff : goldfish_nand.0
ff012000-ff013fff : qemu_pipe
ff014000-ff014fff : goldfish_tty.0
ff015000-ff015fff : goldfish_tty.1
ff016000-ff016fff : goldfish_fb.0
ff017000-ff017fff : goldfish_events.0
fffc0000-ffffffff : reserved</code></pre>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-31">

<h3 id="emulator-implementation-x86">Emulator Implementation (x86)</h3>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-32">

<div rel="079df814f530993aad15ebc000edad42" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.483398px;" xmlns="http://www.w3.org/2000/svg" width="934.5416793823242" version="1.1" height="514.9999923706055"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="89.93333435058594" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="69.93333435058594" y="30" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="54.96666717529297" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">vl_android</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="89.93333435058594" y="457.0833263397217" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="69.93333435058594" y="467.0833435058594" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="476.0416593551636" x="54.96666717529297" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">vl_android</tspan></text><path stroke-width="2" d="M54.96666717529297,57.91666603088379L54.96666717529297,457.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="70.79999923706055" y="20" x="329.2833423614502"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="50.79999923706055" y="30" x="339.2833557128906"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="364.68334197998047" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">module</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="70.79999923706055" y="457.0833263397217" x="329.2833423614502"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="50.79999923706055" y="467.0833435058594" x="339.2833557128906"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="476.0416593551636" x="364.68334197998047" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">module</tspan></text><path stroke-width="2" d="M364.68334197998047,57.91666603088379L364.68334197998047,457.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="37.766666412353516" y="20" x="475.1666774749756"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="17.766666412353516" y="30" x="485.16668701171875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="494.05001068115234" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">pc</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="37.766666412353516" y="457.0833263397217" x="475.1666774749756"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="17.766666412353516" y="467.0833435058594" x="485.16668701171875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="476.0416593551636" x="494.05001068115234" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">pc</tspan></text><path stroke-width="2" d="M494.05001068115234,57.91666603088379L494.05001068115234,457.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="102.18333435058594" y="20" x="532.9333438873291"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="82.18333435058594" y="30" x="542.933349609375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="584.0250110626221" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">pc_machine</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="102.18333435058594" y="457.0833263397217" x="532.9333438873291"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="82.18333435058594" y="467.0833435058594" x="542.933349609375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="476.0416593551636" x="584.0250110626221" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">pc_machine</tspan></text><path stroke-width="2" d="M584.0250110626221,57.91666603088379L584.0250110626221,457.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="64.68333435058594" y="20" x="655.116678237915"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="44.68333435058594" y="30" x="665.11669921875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="687.458345413208" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">device</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="64.68333435058594" y="457.0833263397217" x="655.116678237915"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="44.68333435058594" y="467.0833435058594" x="665.11669921875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="476.0416593551636" x="687.458345413208" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">device</tspan></text><path stroke-width="2" d="M687.458345413208,57.91666603088379L687.458345413208,457.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="20" x="827.3750114440918"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="30" x="837.3750610351562"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="865.958345413208" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">hw_pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="457.0833263397217" x="827.3750114440918"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="467.0833435058594" x="837.3750610351562"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="476.0416593551636" x="865.958345413208" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">hw_pipe</tspan></text><path stroke-width="2" d="M865.958345413208,57.91666603088379L865.958345413208,457.0833263397217" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="289.7166748046875" y="73.95833587646484" x="64.96668243408203"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="209.82500457763672" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">module_call_init(MODULE_INIT_MACHINE)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M54.96666717529297,95.83333206176758C54.96666717529297,95.83333206176758,319.78617556713107,95.83333206176758,359.6772001466633,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="109.36666870117188" y="111.875" x="374.683349609375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="429.3666763305664" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">pc_machine_init</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M364.68334197998047,133.74999809265137C364.68334197998047,133.74999809265137,465.28334232230554,133.74999809265137,489.0579517782066,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="249.85000610351562" y="149.79165649414062" x="149.5833282470703"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="274.50833892822266" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">qemu_register_machine(pc_machine)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M494.05001068115234,171.66666412353516C494.05001068115234,171.66666412353516,108.53880392449355,171.66666412353516,59.9734272920629,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="20.516666412353516" y="187.7083282470703" x="309.2375183105469"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="319.4958391189575" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">init</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M54.96666717529297,209.58333015441895C54.96666717529297,209.58333015441895,525.1808783165894,209.58333015441895,579.021323879399,209.58333015441895" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="53.28333282470703" y="225.625" x="512.3958740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="234.58333015441895" x="539.0375108718872" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624997138977051">pc_init1</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M584.0250110626221,247.49999618530273C584.0250110626221,247.49999618530273,517.9532025933418,247.49999618530273,499.04789020906526,247.49999618530273" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="132.36666870117188" y="263.54168701171875" x="524.57080078125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="272.49999618530273" x="590.7541780471802" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">goldfish_device_init</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M494.05001068115234,285.4166622161865C494.05001068115234,285.4166622161865,652.1248371713106,285.4166622161865,682.4585319030646,285.4166622161865" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="164.5833282470703" y="301.4583435058594" x="508.4624938964844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="310.4166622161865" x="590.7541780471802" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625016212463379">goldfish_device_bus_init</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M494.05001068115234,323.3333282470703C494.05001068115234,323.3333282470703,652.1248371713106,323.3333282470703,682.4585319030646,323.3333282470703" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="138.5" y="343.3333435058594" x="712.4583740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="352.2916612625122" x="781.708345413208" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.6250152587890625">goldfish_device_add</tspan></text><path stroke-dasharray="0" stroke-width="2" d="M687.458345413208,338.3333282470703L707.458345413208,338.3333282470703" stroke="#000000" fill="none" style=""></path><path stroke-dasharray="0" stroke-width="2" d="M707.458345413208,338.3333282470703L707.458345413208,371.2499942779541" stroke="#000000" fill="none" style=""></path><path marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" stroke-width="2" d="M707.458345413208,371.2499942779541C707.458345413208,371.2499942779541,698.3774585723877,371.2499942779541,692.4535987973213,371.24999427795404" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="89.08333587646484" y="377.29168701171875" x="635.4624633789062"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="386.2499942779541" x="680.0041780471802" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">pipe_dev_init</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M494.05001068115234,399.1666603088379C494.05001068115234,399.1666603088379,816.76484646438,399.1666603088379,860.964803220823,399.1666603088379" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="138.5" y="415.2083435058594" x="707.4583740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="424.1666603088379" x="776.708345413208" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625014305114746">goldfish_device_add</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M865.958345413208,437.0833263397217C865.958345413208,437.0833263397217,721.4047206640244,437.0833263397217,692.4657625843538,437.0833263397217" stroke="#000000" fill="none" style=""></path></svg></div>

<p>Log printed at <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/goldfish/device.c#L86-L87">goldfish_add_device_no_io()</a>, if enabled:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-33">

<pre class="prettyprint hljs-dark"><code class="hljs http"><span class="hljs-attribute">goldfish_device_bus_init</span>: <span class="hljs-string">base ff001000, irq 4</span><br><span class="hljs-attribute">goldfish_add_device</span>: <span class="hljs-string">goldfish_device_bus, base ff001000 1000, irq 4 1</span><br><span class="hljs-attribute">goldfish_add_device</span>: <span class="hljs-string">goldfish-battery, base ff010000 1000, irq 5 1</span><br><span class="hljs-attribute">goldfish_add_device</span>: <span class="hljs-string">goldfish_nand, base ff011000 1000, irq 0 0</span><br><span class="hljs-attribute">goldfish_add_device</span>: <span class="hljs-string">qemu_pipe, base ff012000 2000, irq 6 1</span><br><span class="hljs-attribute">goldfish_add_device</span>: <span class="hljs-string">goldfish_mmc, base ff005000 1000, irq 7 1</span><br><span class="hljs-attribute">goldfish_add_device</span>: <span class="hljs-string">goldfish_tty, base ff014000 1000, irq 9 1</span><br><span class="hljs-attribute">goldfish_add_device</span>: <span class="hljs-string">goldfish_tty, base ff015000 1000, irq 10 1</span><br><span class="hljs-attribute">goldfish_add_device</span>: <span class="hljs-string">goldfish_fb, base ff016000 1000, irq 11 1</span><br><span class="hljs-attribute">goldfish_add_device</span>: <span class="hljs-string">goldfish_events, base ff017000 1000, irq 3 1</span><br><span class="hljs-attribute">goldfish_add_device</span>: <span class="hljs-string">goldfish_audio, base ff004000 1000, irq 14 1</span><br></code></pre>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-34">

<h3 id="qemu-pipe-goldfish-pipe">QEMU Pipe / Goldfish Pipe</h3>

<p>QEMU Pipe, or Goldfish Pipe, is a special virtual device to provide very fast communication channel between the emulator and the emulated system. In the emulated system, it appears as <code>/dev/qemu_pipe</code> on kernel 3.4 or before, and <code>/dev/goldfish_pipe</code> on kernel 3.10.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-35">

<h4 id="qemu-pipe-services">QEMU Pipe Services</h4>

<p>There are currently 4 types of services using qemu pipe, as described in the <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/docs/ANDROID-QEMU-PIPE.TXT#L288-L315">document</a>. Services are registered through <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/goldfish/pipe.c#L83-L86">goldfish_pipe_add_type()</a>:</p>

<ul><li>pipeName: an unique name of the pipe service.</li>
<li>pipeOpaque: anything the caller wants to keep. It will be carried back to the handler functions.</li>
<li>pipeFuncs: pipe handler functions. Refer <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/hw/android/goldfish/pipe.h#L62-L119">GoldfishPipeFuncs</a>. </li>
</ul>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-36">

<pre class="prettyprint hljs-dark"><code class="language-c hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span><br><span class="hljs-title">goldfish_pipe_add_type</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*               pipeName,<br>                       <span class="hljs-keyword">void</span>*                     pipeOpaque,<br>                       <span class="hljs-keyword">const</span> GoldfishPipeFuncs*  pipeFuncs )</span></span>;<br></code></pre>

<blockquote>
  <p>The <code>hwpipe</code> parameter in <code>init</code> function is an instance of <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/goldfish/pipe.c#L131-L142">struct Pipe</a>, however the definition of the structure is never exposed to pipe services. Pipe services are responsible of generating their own identifier or encapsulation for a given pipe connection, and return it in the <code>init</code> function. The return value will later be passed as <code>pipe</code> parameter when <code>sendBuffers</code>, <code>recvBuffers</code>, <code>poll</code> or <code>close</code> functions are invoked.</p>
</blockquote>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-37">

<h5 id="workflow">Workflow</h5>

<p>For a user space program, the first write after a fd opened is always the pipe name (with optional arguments appended, <code>pipe:qemud:gsm</code> for example). Afterward, readings / writings to the fd are redirected to the pipe service.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-38">

<pre class="prettyprint hljs-dark"><code class="language-c hljs cpp">fd = open(<span class="hljs-string">"/dev/qemu_pipe"</span>, O_RDWR);<br><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* pipeName = <span class="hljs-string">"&lt;pipename&gt;"</span>;<br>ret = write(fd, pipeName, <span class="hljs-built_in">strlen</span>(pipeName)+<span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {<br>    <span class="hljs-comment">// error</span><br>}<br>... ready to go<br></code></pre>

<p>Here’s what actually happened for the <code>open()</code> call:</p>

<ol><li rel="1">Kernel generates a channel id, sends it with the command <code>PIPE_CMD_OPEN</code> to the qemu pipe device.</li>
<li rel="2">The qemu pipe generates a pipe connection with the given channel id.</li>
<li rel="3">The qemu pipe then generates a pipe connector, which has the interface as a pipe service, on the pipe channel.</li>
</ol>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-39">

<div rel="a1750acbfc8b4cea380a78a280e6ff29" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.75px;" xmlns="http://www.w3.org/2000/svg" width="710.9083309173584" version="1.1" height="287.49999618530273"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="61.61666488647461" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="41.61666488647461" y="30" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="40.808332443237305" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">kernel</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="61.61666488647461" y="229.58333015441895" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="41.61666488647461" y="239.5833282470703" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="248.54166316986084" x="40.808332443237305" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">kernel</tspan></text><path stroke-width="2" d="M40.808332443237305,57.91666603088379L40.808332443237305,229.58333015441895" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="20" x="206.24166107177734"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="30" x="216.24166870117188"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="244.82499504089355" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">hw_pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="229.58333015441895" x="206.24166107177734"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="239.5833282470703" x="216.24166870117188"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="248.54166316986084" x="244.82499504089355" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">hw_pipe</tspan></text><path stroke-width="2" d="M244.82499504089355,57.91666603088379L244.82499504089355,229.58333015441895" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.96666717529297" y="20" x="365.29165840148926"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.96666717529297" y="30" x="375.2916564941406"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="390.27499198913574" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.96666717529297" y="229.58333015441895" x="365.29165840148926"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.96666717529297" y="239.5833282470703" x="375.2916564941406"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="248.54166316986084" x="390.27499198913574" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">pipe</tspan></text><path stroke-width="2" d="M390.27499198913574,57.91666603088379L390.27499198913574,229.58333015441895" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="125.19999694824219" y="20" x="555.7083339691162"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="105.19999694824219" y="30" x="565.7166748046875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="618.3083324432373" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">pipe_connector</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="125.19999694824219" y="229.58333015441895" x="555.7083339691162"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="105.19999694824219" y="239.5833282470703" x="565.7166748046875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="248.54166316986084" x="618.3083324432373" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">pipe_connector</tspan></text><path stroke-width="2" d="M618.3083324432373,57.91666603088379L618.3083324432373,229.58333015441895" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="184.01666259765625" y="73.95833587646484" x="50.80833435058594"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="142.81666374206543" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">PIPE_CMD_OPEN(channel)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M40.808332443237305,95.83333206176758C40.808332443237305,95.83333206176758,208.54559138255718,95.83333206176758,239.83252151674674,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="125.44999694824219" y="111.875" x="254.82498168945312"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="317.54999351501465" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">pipe_new(channel)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M244.82499504089355,133.74999809265137C244.82499504089355,133.74999809265137,359.6923413017648,133.74999809265137,385.26827386766195,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="172.60000610351562" y="149.79165649414062" x="345.26666259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="431.56666374206543" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">pipeConnector_new(pipe)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M244.82499504089355,171.66666412353516C244.82499504089355,171.66666412353516,568.9914465935435,171.66666412353516,613.3110786417574,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="208.03334045410156" y="187.7083282470703" x="400.2749938964844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="504.2916622161865" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">funcs = &amp;pipeConnector_funcs</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M618.3083324432373,209.58333015441895C618.3083324432373,209.58333015441895,428.6990190245915,209.58333015441895,395.27667422765245,209.58333015441895" stroke="#000000" fill="none" style=""></path></svg></div>

<p>Hence, after the open call, the fd connects to a pipe connector.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-40">

<pre class="prettyprint hljs-dark"><code class="language-text hljs">+------+                          +----------------+
|  fd  |&lt;------pipe channel------&gt;| pipe connector |
+------+                          +----------------+</code></pre>

<p>The first <code>write()</code> is where the actual connection to a pipe service created:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-41">

<div rel="791f75b867562517e2700f9bab5b0894" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.75px;" xmlns="http://www.w3.org/2000/svg" width="765.975004196167" version="1.1" height="401.2499942779541"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="61.61666488647461" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="41.61666488647461" y="30" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="40.808332443237305" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">kernel</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="61.61666488647461" y="343.3333282470703" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="41.61666488647461" y="353.3333435058594" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="362.2916612625122" x="40.808332443237305" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.6250152587890625">kernel</tspan></text><path stroke-width="2" d="M40.808332443237305,57.91666603088379L40.808332443237305,343.3333282470703" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="20" x="290.0416793823242"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="30" x="300.0416564941406"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="328.62501335144043" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">hw_pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="343.3333282470703" x="290.0416793823242"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="353.3333435058594" x="300.0416564941406"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="362.2916612625122" x="328.62501335144043" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.6250152587890625">hw_pipe</tspan></text><path stroke-width="2" d="M328.62501335144043,57.91666603088379L328.62501335144043,343.3333282470703" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="125.19999694824219" y="20" x="485.85834312438965"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="105.19999694824219" y="30" x="495.86663818359375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="548.4583415985107" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">pipe_connector</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="125.19999694824219" y="343.3333282470703" x="485.85834312438965"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="105.19999694824219" y="353.3333435058594" x="495.86663818359375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="362.2916612625122" x="548.4583415985107" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.6250152587890625">pipe_connector</tspan></text><path stroke-width="2" d="M548.4583415985107,57.91666603088379L548.4583415985107,343.3333282470703" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="104.91666412353516" y="20" x="631.0583400726318"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="84.91666412353516" y="30" x="641.058349609375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="683.5166721343994" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">pipe_service</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="104.91666412353516" y="343.3333282470703" x="631.0583400726318"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="84.91666412353516" y="353.3333435058594" x="641.058349609375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="362.2916612625122" x="683.5166721343994" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.6250152587890625">pipe_service</tspan></text><path stroke-width="2" d="M683.5166721343994,57.91666603088379L683.5166721343994,343.3333282470703" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="267.8166809082031" y="73.95833587646484" x="50.808345794677734"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="184.71667289733887" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">PIPE_CMD_WRITE_BUFFER(pipename)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M40.808332443237305,95.83333206176758C40.808332443237305,95.83333206176758,285.41035056859255,95.83333206176758,323.6294159006793,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="81.38333129882812" y="111.875" x="397.8500061035156"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="438.5416774749756" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">sendBuffers</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M328.62501335144043,133.74999809265137C328.62501335144043,133.74999809265137,510.73151294258423,133.74999809265137,543.4537745878679,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="159.60000610351562" y="149.79165649414062" x="358.74169921875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="438.5416774749756" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">goldfish_pipe_find_type</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M548.4583415985107,171.66666412353516C548.4583415985107,171.66666412353516,366.35184200736694,171.66666412353516,333.6295803620833,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="84.91666412353516" y="187.7083282470703" x="396.0833435058594"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="438.5416774749756" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">pipe_service</tspan></text><path stroke-dasharray="6,2" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M328.62501335144043,209.58333015441895C328.62501335144043,209.58333015441895,510.73151294258423,209.58333015441895,543.4537745878679,209.58333015441895" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="20.516666412353516" y="225.625" x="605.7291259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="234.58333015441895" x="615.9875068664551" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624997138977051">init</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M548.4583415985107,247.49999618530273C548.4583415985107,247.49999618530273,654.0667197426546,247.49999618530273,678.5092838248441,247.49999618530273" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="30.816667556762695" y="263.54168701171875" x="600.5874633789062"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="272.49999618530273" x="615.9875068664551" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">peer</tspan></text><path stroke-dasharray="6,2" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M683.5166721343994,285.4166622161865C683.5166721343994,285.4166622161865,577.9082939902555,285.4166622161865,553.4657299080659,285.4166622161865" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="199.8333282470703" y="301.4583435058594" x="338.6250305175781"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="310.4166622161865" x="438.5416774749756" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625016212463379">funcs  = &amp;pipe_service-&gt;funcs</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M548.4583415985107,323.3333282470703C548.4583415985107,323.3333282470703,366.35184200736694,323.3333282470703,333.6295803620833,323.3333282470703" stroke="#000000" fill="none" style=""></path></svg></div>

<p>After the <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/hw/android/goldfish/pipe.c#L429-L433">evil switch</a>, the connection becomes:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-42">

<pre class="prettyprint hljs-dark"><code class="language-text hljs">+------+                          +----------------+
|  fd  |&lt;------pipe channel------&gt;|  pipe service  |
+------+                          +----------------+</code></pre>

<p>Readings and writings afterward go to <code>recvBuffers</code> and <code>sendBuffers</code> of the pipe service, respectively.</p>

<blockquote>
  <p>The service might not be able to consume more writes, or provide anything to read temporarily when a write / read request occurs. In this case, the service returns <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/hw/android/goldfish/pipe.h#L189">PIPE_ERROR_AGAIN</a>. </p>
  
  <p>The client can then choose to be signaled when writing / reading is possible. See <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/docs/ANDROID-QEMU-PIPE.TXT#L167-L229">waiting / signaling</a> sections.</p>
</blockquote>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-43">

<h4 id="adaptation-of-legacy-qemud">Adaptation of Legacy QEMUD</h4>

<p>Before qemu pipe was implemented, communications between emulator and the emulated system were all through serial port with a multiplexing daemon <a target="_blank" href="https://github.com/mozilla-b2g/device_generic_goldfish/blob/b2g-4.4.2_r1/qemud/qemud.c">qemud</a> which lives in the emulated system.</p>

<p>The daemon creates a socket <code>/dev/socket/qemud</code>, and client programs transmit data through the socket. The whole architecture looks like this:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-44">

<pre class="prettyprint hljs-dark"><code class="language-text hljs">emulator &lt;==serial==&gt; qemud &lt;---&gt; /dev/socket/qemud &lt;-+--&gt; client1
                                                      |
                                                      +--&gt; client2</code></pre>

<p>The benefit of using qemud was to avoid writing device drivers for all services such as gsm, gps and other emulated sensors, but instead only needed to implement the multiplexing protocol clients.</p>

<p>The qemu pipe replaces the role and provides much better performance. However, to keep backward compatibility and to avoid too much change to the existing implementation, the <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.c">emulator side qemud</a> is kept but it works as one of the qemu pipe services now. The serial port channel no longer in use, unless you’re running a very old version of Android on the emulator, such as Gingerbread.</p>

<p>For emulated systems since ICS, both <a target="_blank" href="https://github.com/mozilla-b2g/device_generic_goldfish/blob/b2g-4.4.2_r1/qemud/qemud.c">qemud daemon</a> and the corresponding socket <code>/dev/socket/qemud</code> are no longer in use, however it still keeps legagy code for backward compatibility, and consequently the logs / configs look very confusing. For example, You can still find qemud service in <a target="_blank" href="https://github.com/mozilla-b2g/device_generic_goldfish/blob/b2g-4.4.2_r1/init.goldfish.rc#L129-L131">init.goldfish.rc</a>.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-45">

<h5 id="initialization-flow">Initialization Flow</h5>

<p>The first part of the initialization flow keeps the original design – qemud was initailized as a char device since it was using serial port. The adaption happens in <code>_android_qemud_pipe_init</code> function, in which it initialized itself as a pipe service.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-46">

<div rel="a5e504551dba2d6b71e205bc30beab60" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.299805px;" xmlns="http://www.w3.org/2000/svg" width="864.5833320617676" version="1.1" height="524.9999923706055"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="98.86666870117188" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="78.86666870117188" y="30" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="59.43333435058594" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemu_main</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="98.86666870117188" y="467.0833263397217" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="78.86666870117188" y="477.0833435058594" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="59.43333435058594" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">qemu_main</tspan></text><path stroke-width="2" d="M59.43333435058594,57.91666603088379L59.43333435058594,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="89.93333435058594" y="20" x="156.31666564941406"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="69.93333435058594" y="30" x="166.31666564941406"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="201.28333282470703" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">vl_android</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="89.93333435058594" y="467.0833263397217" x="156.31666564941406"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="69.93333435058594" y="477.0833435058594" x="166.31666564941406"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="201.28333282470703" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">vl_android</tspan></text><path stroke-width="2" d="M201.28333282470703,57.91666603088379L201.28333282470703,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="95.81666564941406" y="20" x="282.4916687011719"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="75.81666564941406" y="30" x="292.5"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="330.4000015258789" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemu_char</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="95.81666564941406" y="467.0833263397217" x="282.4916687011719"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="75.81666564941406" y="477.0833435058594" x="292.5"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="330.4000015258789" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">qemu_char</tspan></text><path stroke-width="2" d="M330.4000015258789,57.91666603088379L330.4000015258789,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="94.96666717529297" y="20" x="544.7499961853027"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="74.96666717529297" y="30" x="554.75"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="592.2333297729492" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">hw_qemud</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="94.96666717529297" y="467.0833263397217" x="544.7499961853027"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="74.96666717529297" y="477.0833435058594" x="554.75"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="592.2333297729492" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">hw_qemud</tspan></text><path stroke-width="2" d="M592.2333297729492,57.91666603088379L592.2333297729492,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.96666717529297" y="20" x="784.6166648864746"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.96666717529297" y="30" x="794.6166381835938"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="809.5999984741211" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.96666717529297" y="467.0833263397217" x="784.6166648864746"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.96666717529297" y="477.0833435058594" x="794.6166381835938"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="809.5999984741211" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">pipe</tspan></text><path stroke-width="2" d="M809.5999984741211,57.91666603088379L809.5999984741211,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="121.8499984741211" y="73.95833587646484" x="69.43334197998047"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="130.35833358764648" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">serial_hds_add_at</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M59.43333435058594,95.83333206176758C59.43333435058594,95.83333206176758,171.08861961658658,95.83333206176758,196.2764818201473,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="109.11666870117188" y="111.875" x="211.28334045410156"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="265.84166717529297" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">qemu_chr_open</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M201.28333282470703,133.74999809265137C201.28333282470703,133.74999809265137,301.6333366421004,133.74999809265137,325.39786391330927,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="146.31666564941406" y="153.75" x="355.4000244140625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="162.70833110809326" x="428.55833435058594" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624998092651367">qemu_chr_open_opts</tspan></text><path stroke-dasharray="0" stroke-width="2" d="M330.4000015258789,148.74999809265137L350.4000015258789,148.74999809265137" stroke="#000000" fill="none" style=""></path><path stroke-dasharray="0" stroke-width="2" d="M350.4000015258789,148.74999809265137L350.4000015258789,181.66666412353516" stroke="#000000" fill="none" style=""></path><path marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" stroke-width="2" d="M350.4000015258789,181.66666412353516C350.4000015258789,181.66666412353516,341.3191146850586,181.66666412353516,335.3952549099922,181.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="148.5" y="191.66665649414062" x="355.3999938964844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="200.62499713897705" x="429.6500015258789" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">backend_table[i].open</tspan></text><path stroke-dasharray="0" stroke-width="2" d="M330.4000015258789,186.66666412353516L350.4000015258789,186.66666412353516" stroke="#000000" fill="none" style=""></path><path stroke-dasharray="0" stroke-width="2" d="M350.4000015258789,186.66666412353516L350.4000015258789,219.58333015441895" stroke="#000000" fill="none" style=""></path><path marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" stroke-width="2" d="M350.4000015258789,219.58333015441895C350.4000015258789,219.58333015441895,341.3191146850586,219.58333015441895,335.3952549099922,219.58333015441895" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="221.8333282470703" y="229.5833282470703" x="355.3999938964844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="238.54166316986084" x="466.31666564941406" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">qemu_chr_open_android_qemud</tspan></text><path stroke-dasharray="0" stroke-width="2" d="M330.4000015258789,224.58333015441895L350.4000015258789,224.58333015441895" stroke="#000000" fill="none" style=""></path><path stroke-dasharray="0" stroke-width="2" d="M350.4000015258789,224.58333015441895L350.4000015258789,257.49999618530273" stroke="#000000" fill="none" style=""></path><path marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" stroke-width="2" d="M350.4000015258789,257.49999618530273C350.4000015258789,257.49999618530273,341.3191146850586,257.49999618530273,335.3952549099922,257.49999618530273" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="157.9499969482422" y="263.54168701171875" x="382.3416442871094"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="272.49999618530273" x="461.31666564941406" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">android_qemud_get_cs</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M330.4000015258789,285.4166622161865C330.4000015258789,285.4166622161865,551.0382088080514,285.4166622161865,587.2366646902829,285.4166622161865" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="133.23333740234375" y="305.41668701171875" x="617.2333374023438"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="314.3749952316284" x="683.8499984741211" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625005722045898">android_qemud_init</tspan></text><path stroke-dasharray="0" stroke-width="2" d="M592.2333297729492,300.4166622161865L612.2333297729492,300.4166622161865" stroke="#000000" fill="none" style=""></path><path stroke-dasharray="0" stroke-width="2" d="M612.2333297729492,300.4166622161865L612.2333297729492,333.3333282470703" stroke="#000000" fill="none" style=""></path><path marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" stroke-width="2" d="M612.2333297729492,333.3333282470703C612.2333297729492,333.3333282470703,603.1524429321289,333.3333282470703,597.2285831570625,333.3333282470703" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="126.5999984741211" y="343.3333282470703" x="612.2333297729492"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="116.5999984741211" y="348.3333435058594" x="617.2333374023438"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="357.2916612625122" x="675.5333290100098" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.6250152587890625">adapt qemu-pipe</tspan></text><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="177.36666870117188" y="391.25" x="617.2333374023438"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="400.208327293396" x="705.9166641235352" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625024795532227">_android_qemud_pipe_init</tspan></text><path stroke-dasharray="0" stroke-width="2" d="M592.2333297729492,386.2499942779541L612.2333297729492,386.2499942779541" stroke="#000000" fill="none" style=""></path><path stroke-dasharray="0" stroke-width="2" d="M612.2333297729492,386.2499942779541L612.2333297729492,419.1666603088379" stroke="#000000" fill="none" style=""></path><path marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" stroke-width="2" d="M612.2333297729492,419.1666603088379C612.2333297729492,419.1666603088379,603.1524429321289,419.1666603088379,597.2285831570625,419.1666603088379" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="160.43333435058594" y="425.2083435058594" x="620.7000122070312"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="434.1666603088379" x="700.9166641235352" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625014305114746">goldfish_pipe_add_type</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M592.2333297729492,447.0833263397217C592.2333297729492,447.0833263397217,772.1033380892986,447.0833263397217,804.599384513639,447.0833263397217" stroke="#000000" fill="none" style=""></path></svg></div>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-47">

<h3 id="qemud-services">QEMUD Services</h3>

<p><a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/docs/ANDROID-QEMUD-SERVICES.TXT">Qemud services</a> are registered through <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.c#L2307-L2313">qemud_service_register()</a>:</p>

<ul><li>service_name: an unique name for the service.</li>
<li>max_clients: the maximum number of clients accepted by the service concurrently. If this value is 0, then any number of clients can connect.</li>
<li>serv_opaque: anything the caller wants to keep. It will be carried back to the callback functions.</li>
<li>serv_connect: see <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L114-L121">QemudServiceConnect</a>.  <br>
The <code>channel</code> parameter was used in the legacy serial port implementation. For qemu pipe it’s always -1.  <br>
The <code>client_param</code> is a string, if any, passed from the guest system after the service name. For example, Mozilla’s multi-sim implementation passes “qemud:gsm:1” when connecting the second sim card, and in this case <code>client_param</code> is “1”.</li>
<li>serv_save: see <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L123-L126">QemudServiceSave</a>.</li>
<li>serv_load: see <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L128-L131">QemudServiceLoad</a>.</li>
</ul>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-48">

<pre class="prettyprint hljs-dark"><code class="language-c hljs cpp">QemudService*<br>qemud_service_register( <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*          service_name,<br>                        <span class="hljs-keyword">int</span>                  max_clients,<br>                        <span class="hljs-keyword">void</span>*                serv_opaque,<br>                        QemudServiceConnect  serv_connect,<br>                        QemudServiceSave     serv_save,<br>                        QemudServiceLoad     serv_load );<br></code></pre>

<p>When the <code>serv_connect</code> function is invoked, inside the function it should use <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L85-L99">qemud_client_new()</a> to create and return a new client if the service chooses to accept the connection.</p>

<p>Launch the emulator with <code>-debug-qemud</code> option shows the log:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-49">

<pre class="prettyprint hljs-dark"><code class="hljs http"><span class="hljs-attribute">emulator</span>: <span class="hljs-string">Registered QEMUD service hw-control</span><br><span class="hljs-attribute">emulator</span>: <span class="hljs-string">Registered QEMUD service boot-properties</span><br><span class="hljs-attribute">emulator</span>: <span class="hljs-string">Registered QEMUD service gsm</span><br><span class="hljs-attribute">emulator</span>: <span class="hljs-string">Registered QEMUD service gps</span><br><span class="hljs-attribute">emulator</span>: <span class="hljs-string">Registered QEMUD service camera</span><br><span class="hljs-attribute">emulator</span>: <span class="hljs-string">Registered QEMUD service sensors</span><br><span class="hljs-attribute">emulator</span>: <span class="hljs-string">Registered QEMUD service fingerprintlisten</span><br></code></pre>

<blockquote>
  <p>There were “adb” and “adb-debug” qemud services, but apparently adb services didn’t work well and are currently disabled. See <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/avd/util.c#L240-L244">propertyFile_getAdbdCommunicationMode</a>.</p>
</blockquote>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-50">

<h4 id="workflow-1">Workflow</h4>

<p>The design of qemud differs from qemu pipe slightly. Here’s a simple mapping of equivalent major callbacks used in pipe and qemud services.</p>

<table>
<thead>
<tr>
  <th>Pipe Callback</th>
  <th>QEMUD Callback</th>
  <th>Purpose</th>
</tr>
</thead>
<tbody><tr>
  <td>GoldfishPipeFuncs.init</td>
  <td>QemudServiceConnect</td>
  <td>accepting an incoming client</td>
</tr>
<tr>
  <td>GoldfishPipeFuncs.sendBuffers</td>
  <td>QemudClientRecv</td>
  <td>a client is sending messages to the service</td>
</tr>
<tr>
  <td>GoldfishPipeFuncs.recvBuffers</td>
  <td>-</td>
  <td>a client is reading messages from the service</td>
</tr>
<tr>
  <td>GoldfishPipeFuncs.close</td>
  <td>QemudClientClose</td>
  <td>a client closed the connection</td>
</tr>
</tbody></table>


<p>Unlike pipe services, qemud services are not notified when clients are reading. Instead, qemud services send messages to clients proactively through <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L107">qemud_client_send()</a> or <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.h#L145-L147">qemud_service_broadcast()</a>. For pipe implementation, it writes to the buffer <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/hw-qemud.c#L587-L607">QemudPipeMessage</a>, and <code>recvBuffers</code> reads from the buffer.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-51">

<h4 id="initialization">Initialization</h4>

<p>Functions start with <code>_qemudPipe_</code> in qemud are the implementation of pipe callbacks. For example, <code>_qemudPipe_init</code> implements the <code>init</code> function, and convert the call to the corresponding <code>QemudServiceConnect</code> implementation of a qemud service:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-52">

<div rel="6c85ba1768aee66b45a9e564705925a2" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.132813px;" xmlns="http://www.w3.org/2000/svg" width="924.458330154419" version="1.1" height="524.9999923706055"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="30" x="20.000003814697266"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="48.58333396911621" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">hw_pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="467.0833263397217" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="477.0833435058594" x="20.000003814697266"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="48.58333396911621" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">hw_pipe</tspan></text><path stroke-width="2" d="M48.58333396911621,57.91666603088379L48.58333396911621,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="67.76666641235352" y="20" x="147.1166648864746"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="47.766666412353516" y="30" x="157.11666870117188"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="180.99999809265137" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="67.76666641235352" y="467.0833263397217" x="147.1166648864746"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="47.766666412353516" y="477.0833435058594" x="157.11666870117188"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="180.99999809265137" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">qemud</tspan></text><path stroke-width="2" d="M180.99999809265137,57.91666603088379L180.99999809265137,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="122.71666717529297" y="20" x="516.2916584014893"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="102.71666717529297" y="30" x="526.2916259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="577.6499919891357" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud_service</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="122.71666717529297" y="467.0833263397217" x="516.2916584014893"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="102.71666717529297" y="477.0833435058594" x="526.2916259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="577.6499919891357" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">qemud_service</tspan></text><path stroke-width="2" d="M577.6499919891357,57.91666603088379L577.6499919891357,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="111.05000305175781" y="20" x="659.0083255767822"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="91.05000305175781" y="30" x="669.00830078125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="714.5333271026611" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud_client</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="111.05000305175781" y="467.0833263397217" x="659.0083255767822"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="91.05000305175781" y="477.0833435058594" x="669.00830078125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="714.5333271026611" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">qemud_client</tspan></text><path stroke-width="2" d="M714.5333271026611,57.91666603088379L714.5333271026611,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="104.4000015258789" y="20" x="790.05832862854"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="84.4000015258789" y="30" x="800.0582885742188"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="842.2583293914795" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud_pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="104.4000015258789" y="467.0833263397217" x="790.05832862854"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="84.4000015258789" y="477.0833435058594" x="800.0582885742188"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="486.0416593551636" x="842.2583293914795" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">qemud_pipe</tspan></text><path stroke-width="2" d="M842.2583293914795,57.91666603088379L842.2583293914795,467.0833263397217" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="112.41666412353516" y="73.95833587646484" x="58.58333206176758"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="114.79166603088379" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">_qemudPipe_init</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M48.58333396911621,95.83333206176758C48.58333396911621,95.83333206176758,151.84039611492562,95.83333206176758,175.99085156797383,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="90.5" y="111.875" x="334.0749816894531"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="379.32499504089355" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">serv_connect</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M180.99999809265137,133.74999809265137C180.99999809265137,133.74999809265137,526.8094714812992,133.74999809265137,572.652866024765,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="126.30000305175781" y="149.79165649414062" x="316.17498779296875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="379.32499504089355" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">qemud_client_new</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M577.6499919891357,171.66666412353516C577.6499919891357,171.66666412353516,231.84051860048794,171.66666412353516,185.99712405702218,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="42.46666717529297" y="187.7083282470703" x="426.5333251953125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="447.76666259765625" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">create</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M180.99999809265137,209.58333015441895C180.99999809265137,209.58333015441895,655.437098786279,209.58333015441895,709.5294147100886,209.58333015441895" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="179.3000030517578" y="229.5833282470703" x="206"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="238.54166316986084" x="295.6499996185303" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">qemud_service_add_client</tspan></text><path stroke-dasharray="0" stroke-width="2" d="M180.99999809265137,224.58333015441895L200.99999809265137,224.58333015441895" stroke="#000000" fill="none" style=""></path><path stroke-dasharray="0" stroke-width="2" d="M200.99999809265137,224.58333015441895L200.99999809265137,257.49999618530273" stroke="#000000" fill="none" style=""></path><path marker-end="url(#raphael-marker-endblock55)" stroke-dasharray="0" stroke-width="2" d="M200.99999809265137,257.49999618530273C200.99999809265137,257.49999618530273,191.91911125183105,257.49999618530273,185.99525147676468,257.49999618530273" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="72.71666717529297" y="263.54168701171875" x="411.4083251953125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="272.49999618530273" x="447.76666259765625" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">set service</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M180.99999809265137,285.4166622161865C180.99999809265137,285.4166622161865,655.437098786279,285.4166622161865,709.5294147100886,285.4166622161865" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="66.5999984741211" y="301.4583435058594" x="346.0249938964844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="310.4166622161865" x="379.32499504089355" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625016212463379">add client</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M180.99999809265137,323.3333282470703C180.99999809265137,323.3333282470703,526.8094714812992,323.3333282470703,572.652866024765,323.3333282470703" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="356.6499938964844" y="343.3333282470703" x="200.99999809265137"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="346.6499938964844" y="348.3333435058594" x="205.99998474121094"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="357.2916612625122" x="379.32499504089355" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.6250152587890625">put qemud_client to the head of the client linked list</tspan></text><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="42.46666717529297" y="387.29168701171875" x="490.39581298828125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="396.2499942779541" x="511.62916374206543" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">create</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M180.99999809265137,409.1666603088379C180.99999809265137,409.1666603088379,776.4214471984643,409.1666603088379,837.2573545350812,409.1666603088379" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="84.4000015258789" y="425.2083435058594" x="72.59166717529297"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="434.1666603088379" x="114.79166603088379" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625014305114746">qemud_pipe</tspan></text><path stroke-dasharray="6,2" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M180.99999809265137,447.0833263397217C180.99999809265137,447.0833263397217,77.74293594684195,447.0833263397217,53.59248049379376,447.0833263397217" stroke="#000000" fill="none" style=""></path></svg></div>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-53">

<h4 id="client-sends-messages">Client Sends Messages</h4>

<p>Sending messages to a qemud service is straightforward:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-54">

<div rel="0faf85d833afd5fd0aad51ac6fdac724" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.300781px;" xmlns="http://www.w3.org/2000/svg" width="703.9166793823242" version="1.1" height="325.4166622161865"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="30" x="20.000003814697266"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="48.58333396911621" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">hw_pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="267.49999618530273" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="277.5" x="20.000003814697266"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="286.45832920074463" x="48.58333396911621" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624996185302734">hw_pipe</tspan></text><path stroke-width="2" d="M48.58333396911621,57.91666603088379L48.58333396911621,267.49999618530273" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="67.76666641235352" y="20" x="207.98334121704102"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="47.766666412353516" y="30" x="217.98333740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="241.86667442321777" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="67.76666641235352" y="267.49999618530273" x="207.98334121704102"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="47.766666412353516" y="277.5" x="217.98333740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="286.45832920074463" x="241.86667442321777" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624996185302734">qemud</tspan></text><path stroke-width="2" d="M241.86667442321777,57.91666603088379L241.86667442321777,267.49999618530273" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="104.4000015258789" y="20" x="295.75000762939453"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="84.4000015258789" y="30" x="305.75"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="347.950008392334" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud_pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="104.4000015258789" y="267.49999618530273" x="295.75000762939453"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="84.4000015258789" y="277.5" x="305.75"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="286.45832920074463" x="347.950008392334" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624996185302734">qemud_pipe</tspan></text><path stroke-width="2" d="M347.950008392334,57.91666603088379L347.950008392334,267.49999618530273" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="111.05000305175781" y="20" x="420.15000915527344"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="91.05000305175781" y="30" x="430.1500244140625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="475.67501068115234" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud_client</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="111.05000305175781" y="267.49999618530273" x="420.15000915527344"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="91.05000305175781" y="277.5" x="430.1500244140625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="286.45832920074463" x="475.67501068115234" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624996185302734">qemud_client</tspan></text><path stroke-width="2" d="M475.67501068115234,57.91666603088379L475.67501068115234,267.49999618530273" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="122.71666717529297" y="20" x="551.2000122070312"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="102.71666717529297" y="30" x="561.2000122070312"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="612.5583457946777" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud_service</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="122.71666717529297" y="267.49999618530273" x="551.2000122070312"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="102.71666717529297" y="277.5" x="561.2000122070312"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="286.45832920074463" x="612.5583457946777" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624996185302734">qemud_service</tspan></text><path stroke-width="2" d="M612.5583457946777,57.91666603088379L612.5583457946777,267.49999618530273" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="173.28334045410156" y="73.95833587646484" x="58.58333969116211"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="145.225004196167" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">_qemudPipe_sendBuffers</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M48.58333396911621,95.83333206176758C48.58333396911621,95.83333206176758,206.5560012176511,95.83333206176758,236.87009214962092,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="62.150001525878906" y="111.875" x="263.8333435058594"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="294.9083414077759" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">get client</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M241.86667442321777,133.74999809265137C241.86667442321777,133.74999809265137,321.912585440195,133.74999809265137,342.94027104914704,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="36.61666488647461" y="149.79165649414062" x="276.60003662109375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="294.9083414077759" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">client</tspan></text><path stroke-dasharray="6,2" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M347.950008392334,171.66666412353516C347.950008392334,171.66666412353516,267.90409737535674,171.66666412353516,246.87641176640471,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="59.38333511352539" y="187.7083282470703" x="329.07916259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="358.77084255218506" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">clie_recv</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M241.86667442321777,209.58333015441895C241.86667442321777,209.58333015441895,436.7987468386582,209.58333015441895,470.6834234889984,209.58333015441895" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="59.38333511352539" y="225.625" x="514.425048828125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="234.58333015441895" x="544.116678237915" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624997138977051">clie_recv</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M475.67501068115234,247.49999618530273C475.67501068115234,247.49999618530273,582.9469869458126,247.49999618530273,607.5650674362375,247.49999618530273" stroke="#000000" fill="none" style=""></path></svg></div>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-55">

<h4 id="client-reads-messages">Client Reads Messages</h4>

<p>Reading messages, on the other hand, is a bit more complex. Here shows the case that message buffer was empty when client was reading:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-56">

<div rel="415789cf1eaa19ae4345991c323872a0" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.482422px;" xmlns="http://www.w3.org/2000/svg" width="1103.2666606903076" version="1.1" height="582.9166584014893"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="30" x="20.000003814697266"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="48.58333396911621" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">hw_pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="77.16666793823242" y="524.9999923706055" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="57.16666793823242" y="535" x="20.000003814697266"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="543.9583253860474" x="48.58333396911621" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">hw_pipe</tspan></text><path stroke-width="2" d="M48.58333396911621,57.91666603088379L48.58333396911621,524.9999923706055" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="67.76666641235352" y="20" x="203.51666641235352"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="47.766666412353516" y="30" x="213.51666259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="237.39999961853027" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="67.76666641235352" y="524.9999923706055" x="203.51666641235352"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="47.766666412353516" y="535" x="213.51666259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="543.9583253860474" x="237.39999961853027" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">qemud</tspan></text><path stroke-width="2" d="M237.39999961853027,57.91666603088379L237.39999961853027,524.9999923706055" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="104.4000015258789" y="20" x="571.083330154419"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="84.4000015258789" y="30" x="581.0833129882812"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="623.2833309173584" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud_pipe</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="104.4000015258789" y="524.9999923706055" x="571.083330154419"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="84.4000015258789" y="535" x="581.0833129882812"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="543.9583253860474" x="623.2833309173584" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">qemud_pipe</tspan></text><path stroke-width="2" d="M623.2833309173584,57.91666603088379L623.2833309173584,524.9999923706055" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="111.05000305175781" y="20" x="695.4833316802979"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="91.05000305175781" y="30" x="705.4833374023438"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="751.0083332061768" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud_client</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="111.05000305175781" y="524.9999923706055" x="695.4833316802979"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="91.05000305175781" y="535" x="705.4833374023438"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="543.9583253860474" x="751.0083332061768" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">qemud_client</tspan></text><path stroke-width="2" d="M751.0083332061768,57.91666603088379L751.0083332061768,524.9999923706055" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="122.71666717529297" y="20" x="950.5499935150146"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="102.71666717529297" y="30" x="960.5499877929688"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="1011.9083271026611" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemud_service</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="122.71666717529297" y="524.9999923706055" x="950.5499935150146"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="102.71666717529297" y="535" x="960.5499877929688"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="543.9583253860474" x="1011.9083271026611" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">qemud_service</tspan></text><path stroke-width="2" d="M1011.9083271026611,57.91666603088379L1011.9083271026611,524.9999923706055" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="168.81666564941406" y="73.95833587646484" x="58.583335876464844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="142.99166679382324" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">_qemudPipe_recvBuffers</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M48.58333396911621,95.83333206176758C48.58333396911621,95.83333206176758,202.48886998626767,95.83333206176758,232.39824661460082,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="62.150001525878906" y="111.875" x="399.26666259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="430.34166526794434" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">get client</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M237.39999961853027,133.74999809265137C237.39999961853027,133.74999809265137,573.1194714570888,133.74999809265137,618.2809531424027,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="36.61666488647461" y="149.79165649414062" x="412.0333557128906"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="430.34166526794434" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">client</tspan></text><path stroke-dasharray="6,2" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M623.2833309173584,171.66666412353516C623.2833309173584,171.66666412353516,287.56385907879985,171.66666412353516,242.40237739348592,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="290.1499938964844" y="187.7083282470703" x="349.1291809082031"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="494.2041664123535" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">msg_list = ProtocolSelector.Pipe.messages</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M237.39999961853027,209.58333015441895C237.39999961853027,209.58333015441895,693.0554950764918,209.58333015441895,746.0076473806885,209.58333015441895" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="169.89999389648438" y="229.58333015441895" x="257.3999996185303"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="159.89999389648438" y="234.5833282470703" x="262.3999938964844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="243.54166316986084" x="342.34999656677246" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">found msg_list is empty</tspan></text><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="145.14999389648438" y="273.54168701171875" x="70.41667175292969"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="282.49999618530273" x="142.99166679382324" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">PIPE_ERROR_AGAIN</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M237.39999961853027,295.4166622161865C237.39999961853027,295.4166622161865,83.49446360137881,295.4166622161865,53.58508697304566,295.4166622161865" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="76.88333129882812" y="311.4583435058594" x="586.2125244140625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="320.4166622161865" x="624.6541633605957" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625016212463379">client_send</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M1011.9083271026611,333.3333282470703C1011.9083271026611,333.3333282470703,308.6687594371017,333.3333282470703,242.3966712733063,333.3333282470703" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="220.89999389648438" y="353.3333282470703" x="771.0083332061768"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="210.89999389648438" y="358.3333435058594" x="776.00830078125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="367.2916612625122" x="881.458330154419" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.6250152587890625">service got something for client</tspan></text><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="133.21665954589844" y="397.29168701171875" x="76.38333892822266"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="406.2499942779541" x="142.99166679382324" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">goldfish_pipe_wake</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M237.39999961853027,419.1666603088379C237.39999961853027,419.1666603088379,83.49446360137881,419.1666603088379,53.58508697304566,419.1666603088379" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="168.81666564941406" y="435.2083435058594" x="58.583335876464844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="444.1666603088379" x="142.99166679382324" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625014305114746">_qemudPipe_recvBuffers</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M48.58333396911621,457.0833263397217C48.58333396911621,457.0833263397217,202.48886998626767,457.0833263397217,232.39824661460082,457.0833263397217" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="27.91666603088379" width="345.8833312988281" y="477.0833263397217" x="257.3999996185303"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="335.8833312988281" y="482.0833435058594" x="262.4000244140625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="491.0416593551636" x="430.34166526794434" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.62501335144043">this time msg_list is not empty and client can read</tspan></text></svg></div>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-57">

<h3 id="chardriverstate">CharDriverState</h3>

<p>In QEMU, a <em>CharDriver</em> is an object to operate on a specific type of char devices. For exmaple, <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/qemu-char.c#L1982-L1990">TCPCharDriver</a> and the corresponding <code>tcp_chr_</code> functions form a driver for TCP net console.</p>

<p><a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/sysemu/char.h#L54-L77"><em>CharDriverState</em></a>, on the other hand, forms an unified interface between a char driver and a user operating on the char driver. By forming an unified interface, the user needs not to know which driver it’s actually operating on, and the driver needs not to know who the user is either. The char driver is referred as the <em>backend</em> for the CharDriverState in this case.</p>

<p>Most character devices are associated with file descriptors, and therefore character devices are polled in the main loop for readings and incoming events (so as writing if opened non-blocking).</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-58">

<pre class="prettyprint hljs-dark"><code class="language-text hljs">+--------+                                 +---------------+     +-----+
| User 1 |---+                         +---| TcpCharDriver |-----| tcp |
+--------+   |                         |   +---------------+     +-----+
             |                         |                                
+--------+   |   +-----------------+   |   +---------------+     +-----+
| User 2 |---+---| CharDriverState |---+---| FDCharDriver  |-----| fd  |
+--------+   |   +-----------------+   |   +---------------+     +-----+
             |                         |                                
+--------+   |                         |   +---------------+     +-----+
| User 3 |---+                         +---| PtyCharDriver |-----| pty |
+--------+                                 +---------------+     +-----+</code></pre>

<blockquote>
  <p>CharDriverState is usually used as a one-to-one connection. However it does support connections to multiple drivers through <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/qemu-char.c#L260-L282">MuxDriver</a>.</p>
</blockquote>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-59">

<h4 id="initialization-1">Initialization</h4>

<p><a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/sysemu/char.h#L82">qemu_chr_open()</a> is used to create a new CharDriverState object from a descriptive string <em>filename</em>. The function looks up for a proper backend from the filename, and then use the function defined in the <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/qemu-char.c#L2553-L2594">backend_table</a> to create a CharDriverState associated to the backend.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-60">

<div rel="f7712643568b6c0446ce493b1097854e" class="sequence-diagram"><svg style="overflow: hidden; position: relative;" xmlns="http://www.w3.org/2000/svg" width="488.4000015258789" version="1.1" height="325.4166622161865"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.71666717529297" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.71666717529297" y="30" x="20.008333206176758"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="34.858333587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">user</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.71666717529297" y="267.49999618530273" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.71666717529297" y="277.5" x="20.008333206176758"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="286.45832920074463" x="34.858333587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624996185302734">user</tspan></text><path stroke-width="2" d="M34.858333587646484,57.91666603088379L34.858333587646484,267.49999618530273" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="95.81666564941406" y="20" x="116.06666946411133"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="75.81666564941406" y="30" x="126.07500457763672"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="163.97500228881836" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemu_char</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="95.81666564941406" y="267.49999618530273" x="116.06666946411133"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="75.81666564941406" y="277.5" x="126.07500457763672"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="286.45832920074463" x="163.97500228881836" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624996185302734">qemu_char</tspan></text><path stroke-width="2" d="M163.97500228881836,57.91666603088379L163.97500228881836,267.49999618530273" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="78.86666488647461" y="20" x="231.8833351135254"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="58.86666488647461" y="30" x="241.8833465576172"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="271.3166675567627" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">backend</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="78.86666488647461" y="267.49999618530273" x="231.8833351135254"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="58.86666488647461" y="277.5" x="241.8833465576172"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="286.45832920074463" x="271.3166675567627" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624996185302734">backend</tspan></text><path stroke-width="2" d="M271.3166675567627,57.91666603088379L271.3166675567627,267.49999618530273" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="127.6500015258789" y="20" x="330.75"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="107.6500015258789" y="30" x="340.75"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="394.57500076293945" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">CharDriverState</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="127.6500015258789" y="267.49999618530273" x="330.75"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="107.6500015258789" y="277.5" x="340.75"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="286.45832920074463" x="394.57500076293945" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624996185302734">CharDriverState</tspan></text><path stroke-width="2" d="M394.57500076293945,57.91666603088379L394.57500076293945,267.49999618530273" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="109.11666870117188" y="73.95833587646484" x="44.858341217041016"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="99.41666793823242" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">qemu_chr_open</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M34.858333587646484,95.83333206176758C34.858333587646484,95.83333206176758,135.20833740503986,95.83333206176758,158.97286467624872,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="34.70000076293945" y="111.875" x="200.2958221435547"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="217.64583492279053" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">open</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M163.97500228881836,133.74999809265137C163.97500228881836,133.74999809265137,245.15261266350126,133.74999809265137,266.31904036861874,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="42.46666717529297" y="149.79165649414062" x="311.7124938964844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="332.9458341598511" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">create</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M271.3166675567627,171.66666412353516C271.3166675567627,171.66666412353516,366.47790656157133,171.66666412353516,389.57123458178125,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="16.366666793823242" y="187.7083282470703" x="209.46249389648438"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="217.64583492279053" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">cs</tspan></text><path stroke-dasharray="6,2" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M271.3166675567627,209.58333015441895C271.3166675567627,209.58333015441895,190.1390571820798,209.58333015441895,168.97262947696228,209.58333015441895" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="16.366666793823242" y="225.625" x="91.23333740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="234.58333015441895" x="99.41666793823242" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624997138977051">cs</tspan></text><path stroke-dasharray="6,2" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M163.97500228881836,247.49999618530273C163.97500228881836,247.49999618530273,63.62499847142499,247.49999618530273,39.86047120021611,247.49999618530273" stroke="#000000" fill="none" style=""></path></svg></div>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-61">

<h4 id="writing">Writing</h4>

<p><a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/sysemu/char.h#L89">qemu_chr_write()</a> is used to try to write data into a CS object. Note that success is not guaranteed: the function returns the number of bytes that were really written (which can be 0) and the caller must deal with it. This is very similar to writing to a non-blocking BSD socket on Unix.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-62">

<div rel="4bffc2a393b8900a42f07814fb313d58" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.382813px;" xmlns="http://www.w3.org/2000/svg" width="510.28333282470703" version="1.1" height="249.58333015441895"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.71666717529297" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.71666717529297" y="30" x="20.008333206176758"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="34.858333587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">user</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.71666717529297" y="191.66666412353516" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.71666717529297" y="201.66665649414062" x="20.008333206176758"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="210.62499713897705" x="34.858333587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">user</tspan></text><path stroke-width="2" d="M34.858333587646484,57.91666603088379L34.858333587646484,191.66666412353516" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="95.81666564941406" y="20" x="137.95000076293945"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="75.81666564941406" y="30" x="147.95834350585938"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="185.85833358764648" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemu_char</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="95.81666564941406" y="191.66666412353516" x="137.95000076293945"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="75.81666564941406" y="201.66665649414062" x="147.95834350585938"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="210.62499713897705" x="185.85833358764648" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">qemu_char</tspan></text><path stroke-width="2" d="M185.85833358764648,57.91666603088379L185.85833358764648,191.66666412353516" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="127.6500015258789" y="20" x="253.76666641235352"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="107.6500015258789" y="30" x="263.76666259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="317.59166717529297" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">CharDriverState</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="127.6500015258789" y="191.66666412353516" x="253.76666641235352"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="107.6500015258789" y="201.66665649414062" x="263.76666259765625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="210.62499713897705" x="317.59166717529297" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">CharDriverState</tspan></text><path stroke-width="2" d="M317.59166717529297,57.91666603088379L317.59166717529297,191.66666412353516" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="78.86666488647461" y="20" x="401.4166679382324"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="58.86666488647461" y="30" x="411.41668701171875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="440.8500003814697" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">backend</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="78.86666488647461" y="191.66666412353516" x="401.4166679382324"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="58.86666488647461" y="201.66665649414062" x="411.41668701171875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="210.62499713897705" x="440.8500003814697" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624992370605469">backend</tspan></text><path stroke-width="2" d="M440.8500003814697,57.91666603088379L440.8500003814697,191.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="131" y="73.95833587646484" x="44.85833740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="110.35833358764648" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">qemu_chr_write(cs)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M34.858333587646484,95.83333206176758C34.858333587646484,95.83333206176758,154.6991552710533,95.83333206176758,180.85581898808596,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="62.13333511352539" y="111.875" x="220.65834045410156"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="251.72500038146973" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">chr_write</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M185.85833358764648,133.74999809265137C185.85833358764648,133.74999809265137,288.5257491504308,133.74999809265137,312.58842467295835,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="33.266666412353516" y="149.79165649414062" x="362.5874938964844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="379.22083377838135" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">write</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M317.59166717529297,171.66666412353516C317.59166717529297,171.66666412353516,412.7529061801016,171.66666412353516,435.8462342003115,171.66666412353516" stroke="#000000" fill="none" style=""></path></svg></div>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-63">

<h4 id="reading">Reading</h4>

<p>Reading is not so straightforward. As mentioned before, character devices are only polled in the main loop. Hence readings can not be performed directly, instead reading handlers should be registered to the CharDriverState though <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/sysemu/char.h#L91-L95">qemu_chr_add_handler()</a>.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-64">

<div rel="8c4c8b6e7e87dac79e58d12e2be638c3" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.933594px;" xmlns="http://www.w3.org/2000/svg" width="934.6833572387695" version="1.1" height="287.49999618530273"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.71666717529297" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.71666717529297" y="30" x="20.008333206176758"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="34.858333587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">user</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.71666717529297" y="229.58333015441895" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.71666717529297" y="239.5833282470703" x="20.008333206176758"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="248.54166316986084" x="34.858333587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">user</tspan></text><path stroke-width="2" d="M34.858333587646484,57.91666603088379L34.858333587646484,229.58333015441895" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="95.81666564941406" y="20" x="296.7833442687988"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="75.81666564941406" y="30" x="306.79168701171875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="344.69167709350586" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">qemu_char</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="95.81666564941406" y="229.58333015441895" x="296.7833442687988"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="75.81666564941406" y="239.5833282470703" x="306.79168701171875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="248.54166316986084" x="344.69167709350586" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">qemu_char</tspan></text><path stroke-width="2" d="M344.69167709350586,57.91666603088379L344.69167709350586,229.58333015441895" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="127.6500015258789" y="20" x="472.15001678466797"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="107.6500015258789" y="30" x="482.1500244140625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="535.9750175476074" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">CharDriverState</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="127.6500015258789" y="229.58333015441895" x="472.15001678466797"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="107.6500015258789" y="239.5833282470703" x="482.1500244140625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="248.54166316986084" x="535.9750175476074" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">CharDriverState</tspan></text><path stroke-width="2" d="M535.9750175476074,57.91666603088379L535.9750175476074,229.58333015441895" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="78.86666488647461" y="20" x="658.9583568572998"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="58.86666488647461" y="30" x="668.9583129882812"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="698.3916893005371" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">backend</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="78.86666488647461" y="229.58333015441895" x="658.9583568572998"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="58.86666488647461" y="239.5833282470703" x="668.9583129882812"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="248.54166316986084" x="698.3916893005371" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">backend</tspan></text><path stroke-width="2" d="M698.3916893005371,57.91666603088379L698.3916893005371,229.58333015441895" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="82.71666717529297" y="20" x="821.9666900634766"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="62.71666717529297" y="30" x="831.9750366210938"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="863.325023651123" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">iohandler</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="82.71666717529297" y="229.58333015441895" x="821.9666900634766"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="62.71666717529297" y="239.5833282470703" x="831.9750366210938"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="248.54166316986084" x="863.325023651123" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625001907348633">iohandler</tspan></text><path stroke-width="2" d="M863.325023651123,57.91666603088379L863.325023651123,229.58333015441895" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="289.8333435058594" y="73.95833587646484" x="44.85834503173828"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="189.77500534057617" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">qemu_chr_add_handler(cs, can_read, read)</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M34.858333587646484,95.83333206176758C34.858333587646484,95.83333206176758,299.84754844298004,95.83333206176758,339.69944208333294,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="171.28334045410156" y="111.875" x="354.70001220703125"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="440.33334732055664" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">chr_update_read_handler</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M344.69167709350586,133.74999809265137C344.69167709350586,133.74999809265137,500.86089007969804,133.74999809265137,530.9814169984217,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="142.4166717529297" y="149.79165649414062" x="545.9833374023438"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="617.1833534240723" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">update_read_handler</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M535.9750175476074,171.66666412353516C535.9750175476074,171.66666412353516,666.0805103395651,171.66666412353516,693.3975815800641,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="144.93333435058594" y="187.7083282470703" x="708.4000244140625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="780.8583564758301" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">qemu_set_fd_handler</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M698.3916893005371,209.58333015441895C698.3916893005371,209.58333015441895,830.7295063313131,209.58333015441895,858.3214242376322,209.58333015441895" stroke="#000000" fill="none" style=""></path></svg></div>

<p>In the next event loop, it will poll iohandlers and triggers read on registered handlers.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-65">

<div rel="c104687db132d95a558a48ce7f009a62" class="sequence-diagram"><svg style="overflow: hidden; position: relative; top: -0.800781px;" xmlns="http://www.w3.org/2000/svg" width="604.7416706085205" version="1.1" height="439.1666603088379"><desc>Created with Raphaël 2.1.0</desc><defs></defs><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="90.21666717529297" y="20" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="70.21666717529297" y="30" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="55.108333587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">main_loop</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="90.21666717529297" y="381.2499942779541" x="10"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="70.21666717529297" y="391.25" x="20.000001907348633"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="400.208327293396" x="55.108333587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625024795532227">main_loop</tspan></text><path stroke-width="2" d="M55.108333587646484,57.91666603088379L55.108333587646484,381.2499942779541" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="82.71666717529297" y="20" x="173.61666870117188"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="62.71666717529297" y="30" x="183.625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="214.97500228881836" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">iohandler</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="82.71666717529297" y="381.2499942779541" x="173.61666870117188"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="62.71666717529297" y="391.25" x="183.625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="400.208327293396" x="214.97500228881836" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625024795532227">iohandler</tspan></text><path stroke-width="2" d="M214.97500228881836,57.91666603088379L214.97500228881836,381.2499942779541" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="78.86666488647461" y="20" x="278.508337020874"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="58.86666488647461" y="30" x="288.50836181640625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="317.9416694641113" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">backend</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="78.86666488647461" y="381.2499942779541" x="278.508337020874"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="58.86666488647461" y="391.25" x="288.50836181640625"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="400.208327293396" x="317.9416694641113" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625024795532227">backend</tspan></text><path stroke-width="2" d="M317.9416694641113,57.91666603088379L317.9416694641113,381.2499942779541" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="127.6500015258789" y="20" x="377.37500190734863"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="107.6500015258789" y="30" x="387.375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="441.2000026702881" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">CharDriverState</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="127.6500015258789" y="381.2499942779541" x="377.37500190734863"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="107.6500015258789" y="391.25" x="387.375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="400.208327293396" x="441.2000026702881" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625024795532227">CharDriverState</tspan></text><path stroke-width="2" d="M441.2000026702881,57.91666603088379L441.2000026702881,381.2499942779541" stroke="#000000" fill="none" style=""></path><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.71666717529297" y="20" x="525.0250034332275"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.71666717529297" y="30" x="535.0333862304688"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="38.958333015441895" x="549.883337020874" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625">user</tspan></text><rect stroke-width="2" style="" stroke="#000000" fill="none" ry="0" rx="0" r="0" height="37.91666603088379" width="49.71666717529297" y="381.2499942779541" x="525.0250034332275"></rect><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="29.71666717529297" y="391.25" x="535.0333862304688"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="400.208327293396" x="549.883337020874" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625024795532227">user</tspan></text><path stroke-width="2" d="M549.883337020874,57.91666603088379L549.883337020874,381.2499942779541" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="130.14999389648438" y="73.95833587646484" x="69.9666748046875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="82.91666603088379" x="135.04166793823242" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625004768371582">qemu_iohandler_fill</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M55.108333587646484,95.83333206176758C55.108333587646484,95.83333206176758,182.89181296526658,95.83333206176758,209.97092920056303,95.83333206176758" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="82.96666717529297" y="111.875" x="224.97500610351562"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="120.83333206176758" x="266.45833587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">fd_read_poll</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M214.97500228881836,133.74999809265137C214.97500228881836,133.74999809265137,292.32021993855415,133.74999809265137,312.9405758158763,133.74999809265137" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="91.33333587646484" y="149.79165649414062" x="333.9041748046875"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="158.74999809265137" x="379.5708360671997" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624993324279785">chr_can_read</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M317.9416694641113,171.66666412353516C317.9416694641113,171.66666412353516,413.10290846891996,171.66666412353516,436.1962364891299,171.66666412353516" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="62.46666717529297" y="187.7083282470703" x="464.3083190917969"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="196.66666412353516" x="495.54166984558105" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625002861022949">can_read</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M441.2000026702881,209.58333015441895C441.2000026702881,209.58333015441895,523.530763030757,209.58333015441895,544.8772638859373,209.58333015441895" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="139.86666870117188" y="225.625" x="65.10833740234375"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="234.58333015441895" x="135.04166793823242" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.624997138977051">qemu_iohandler_poll</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M55.108333587646484,247.49999618530273C55.108333587646484,247.49999618530273,182.89181296526658,247.49999618530273,209.97092920056303,247.49999618530273" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="51.349998474121094" y="263.54168701171875" x="240.78334045410156"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="272.49999618530273" x="266.45833587646484" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625006675720215">fd_read</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M214.97500228881836,285.4166622161865C214.97500228881836,285.4166622161865,292.32021993855415,285.4166622161865,312.9405758158763,285.4166622161865" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="59.400001525878906" y="301.4583435058594" x="349.8708190917969"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="310.4166622161865" x="379.5708360671997" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625016212463379">chr_read</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M317.9416694641113,323.3333282470703C317.9416694641113,323.3333282470703,413.10290846891996,323.3333282470703,436.1962364891299,323.3333282470703" stroke="#000000" fill="none" style=""></path><rect style="" stroke="none" fill="#ffffff" ry="0" rx="0" r="0" height="17.91666603088379" width="30.53333282470703" y="339.375" x="480.2749938964844"></rect><text font-family="Andale Mono, monospace" font-size="16px" fill="#000000" stroke="none" font="10px &quot;Arial&quot;" text-anchor="middle" y="348.3333282470703" x="495.54166984558105" style="text-anchor: middle; font: 16px Andale Mono,monospace;"><tspan dy="5.625025749206543">read</tspan></text><path stroke-dasharray="0" marker-end="url(#raphael-marker-endblock55)" stroke-width="2" d="M441.2000026702881,361.2499942779541C441.2000026702881,361.2499942779541,523.530763030757,361.2499942779541,544.8772638859373,361.2499942779541" stroke="#000000" fill="none" style=""></path></svg></div>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-66">

<h4 id="charbuffer">CharBuffer</h4>

<p>The problem of writing to a CharDriverState is that it doesn’t tell how many bytes it can accept, nor notify the user when it’s ready to accept data again. The actual accepted length of data depends wholly on the underlying implementation.</p>

<p>Android emulator provides a wrapper with internal bipartite buffers on top of CharDriverState called <em>CharBuffer</em>. CharBuffer is created through <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/android/charpipe.h#L28">qemu_chr_open_buffer()</a>. It works as a CharDriverState but has different write implementation.</p>

<p>On each write, CharBuffer tries to write as much as possible to the CharDriverState. The remaining bytes not accepted by the CharDriverState are stored to the internal buffer for writing later in the next event loop until it’s empty.</p>

<p>A use case is when user specifies a physical radio device on the host when launching emulator, the radio device will become the backend of a CharDriverState, and QEMUD will use a CharBuffer on top of the CharDriverState.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-67">

<pre class="prettyprint hljs-dark"><code class="language-text hljs">+-------+       +-------------+               +--------------+
| QEMUD |------&gt;| GSM Service |--CharBuffer--&gt;| Radio Device |
+-------+       +-------------+               +--------------+</code></pre>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-68">

<h4 id="charpipe">CharPipe</h4>

<p><em>CharBuffer</em> creates a write buffer on a CharDriverState, while <em>CharPipe</em> works as if 2 CharBuffers are connected to each other – it’s used to create a bidirectional communication channel between 2 CharDriverState users. The CharPipe plays the backend of the CharDriverState on both sides, and also provides write buffers.</p>

<p>CharPipe is created through <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/include/android/charpipe.h#L21">qemu_chr_open_pipe()</a>. Writing on one endpoint triggers the read handler on the other endpoint directly. Remaining bytes not accepted by the read handler are stored to the internal buffer for retry later as how CharBuffer works.</p>

<p>If user does not specify a physical radio device to use, QEMUD will use a CharPipe to connect to the internal emulated modem.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-69">

<pre class="prettyprint hljs-dark"><code class="language-text hljs">+-------+       +-------------+                +-------------+
| QEMUD |------&gt;| GSM Service |&lt;---CharPipe---&gt;| ModemDriver |
+-------+       +-------------+                +-------------+</code></pre>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-70">

<h4 id="charpipe-charbuffer-polling">CharPipe / CharBuffer Polling</h4>

<p>As mentioned before, <a target="_blank" href="https://github.com/android/platform_external_qemu/blob/bc42c43ffe6a38a7dd809b5f1f9c229c918b0382/android/charpipe.c#L442-L443">charpipe_poll</a> is invoked in the main loop. It triggers CharBuffers to re-writing remaining data in the buffers, and the read handlers of CharPipes to re-read.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-71">

<h3 id="opengl-emulation">OpenGL Emulation</h3>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-72">

<pre class="prettyprint hljs-dark"><code class="language-text hljs">         _________            __________          __________
        |         |          |          |        |          |
        |EMULATION|          |EMULATION |        |EMULATION |     GUEST
        |   EGL   |          | GLES 1.1 |        | GLES 2.0 |     SYSTEM
        |_________|          |__________|        |__________|     LIBRARIES
             ^                    ^                    ^
             |                    |                    |
       - - - | - - - - - - - - -  | - - - - - - - - -  | - - - - -
             |                    |                    |
         ____v____________________v____________________v____      GUEST
        |                                                   |     KERNEL
        |                       QEMU PIPE                   |
        |___________________________________________________|
                                 ^
                                 |
      - - - - - - - - - - - - - -|- - - - - - - - - - - - - - - -
                                 |
                                 |    PROTOCOL BYTE STREAM
                            _____v_____
                           |           |
                           |  EMULATOR |
                           |___________|
                                 ^
                                 |   UNMODIFIED PROTOCOL BYTE STREAM
                            _____v_____
                           |           |
                           |  RENDERER |
                           |___________|
                               ^ ^  ^
                               | |  |
             +-----------------+ |  +-----------------+
             |                   |                    |
         ____v____            ___v______          ____v_____
        |         |          |          |        |          |
        |TRANSLATOR          |TRANSLATOR|        |TRANSLATOR|     HOST
        |   EGL   |          | GLES 1.1 |        | GLES 2.0 |     TRANSLATOR
        |_________|          |__________|        |__________|     LIBRARIES
             ^                    ^                    ^
             |                    |                    |
       - - - | - - - - - - - - -  | - - - - - - - - -  | - - - - -
             |                    |                    |
         ____v____            ____v_____          _____v____      HOST 
        |         |          |          |        |          |     SYSTEM
        |   GLX   |          |  GL 2.0  |        |  GL 2.0  |     LIBRARIES
        |_________|          |__________|        |__________|
</code></pre>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-73">

<h2 id="build-goldfish-kernel">Build Goldfish Kernel</h2>

<p>Follow the steps here if you’re interested at building goldfish kernel by yourself.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-74">

<h3 id="special-setup-for-mac-os-x">Special Setup for Mac OS X</h3>

<p>Building qemu-kernel on Ubuntu Linux is quite straightforward, but on Mac OS X there are some tricks need to be done.</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-75">

<h4 id="copy-elfutils-headers">Copy elfutils headers:</h4>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-76">

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">cp <span class="hljs-variable">${B2G}</span>/external/elfutils/host-darwin-fixup/* /usr/<span class="hljs-built_in">local</span>/include/<br>cp <span class="hljs-variable">${B2G}</span>/external/elfutils/libelf/elf.h /usr/<span class="hljs-built_in">local</span>/include/<br></code></pre>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-77">

<h4 id="create-usrlocalincludelinuxtypesh">Create <code>/usr/local/include/linux/types.h</code>:</h4>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-78">

<pre class="prettyprint hljs-dark"><code class="language-c hljs cpp"><span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> &lt;stdint.h&gt;</span><br><br><span class="hljs-preprocessor">#ifndef __u8</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint8_t</span> __u8;<br><span class="hljs-preprocessor">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-preprocessor">#ifndef __u16</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint16_t</span> __u16;<br><span class="hljs-preprocessor">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-preprocessor">#ifndef __u32</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint32_t</span> __u32;<br><span class="hljs-preprocessor">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-preprocessor">#ifndef __u64</span><br><span class="hljs-keyword">typedef</span> uint64_t __u64;<br><span class="hljs-preprocessor">#<span class="hljs-keyword">endif</span></span><br></code></pre>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-79">

<h4 id="install-gnu-sed">Install GNU sed.</h4>

<p>Linux kernel makefiles are not compatible with BSD sed:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-80">

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">brew install gnu-sed<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"/usr/local/opt/gnu-sed/libexec/gnubin:<span class="hljs-variable">$PATH</span>"</span><br></code></pre>

<p>Otherwise you’ll get this error compiling the kernel:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-81">

<pre class="prettyprint hljs-dark"><code class="hljs groovy">arch<span class="hljs-regexp">/x86/</span>boot/header.<span class="hljs-string">S:</span> Assembler <span class="hljs-string">messages:</span><br>arch<span class="hljs-regexp">/x86/</span>boot/header.<span class="hljs-string">S:</span><span class="hljs-number">384</span>: <span class="hljs-string">Error:</span> can<span class="hljs-string">'t resolve `VO__end'</span> {*UND* section} - `VO__text<span class="hljs-string">' {*UND* section}</span><br></code></pre>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-82">

<h3 id="build-the-kernel">Build the Kernel</h3>

<p>This section applies to both Linux and Mac OS X.</p>

<p>Clean previous build with <code>make clean</code> or clean all configs (only necessary for the very first time) with <code>make mrproper</code>, then build the kernel (x86 as the example) with <code>build-kernel.sh</code>:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-83">

<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><span class="hljs-variable">${B2G}</span>/external/qemu/distrib/build-kernel.sh --arch=x86<br><span class="hljs-comment"># or ${AOSP}/prebuilts/qemu-kernel/build-kernel.sh --arch=x86</span><br><span class="hljs-comment"># omit --arch parameter to build arm kernel</span><br></code></pre>

<p>The output should be at <code>/tmp/kernel-qemu</code> directory.</p>

<p>If the cross toolchain version differs from the default version (at the time this document is written, the default version is 4.8), pass <code>--gcc-version=&lt;version&gt;</code>. If you’re using an older version of build script and it doesn’t have the option, export the path to cross compiler directly. For example:</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-84">

<pre class="prettyprint hljs-dark"><code class="hljs bash"><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">${PATH}</span>:<span class="hljs-variable">${B2G}</span>/prebuilts/gcc/darwin-x86/x86/i686-linux-android-<span class="hljs-number">4.7</span>/bin/<br></code></pre>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-85">

<h4 id="build-the-kernel-manually">Build the Kernel Manually</h4>

<p>To build kernel manually, export necessary variables</p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-86">

<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><span class="hljs-built_in">export</span> ARCH=x86 <span class="hljs-comment"># or arm</span><br><span class="hljs-built_in">export</span> SUBARCH=x86 <span class="hljs-comment"># or am</span><br><span class="hljs-built_in">export</span> REAL_CROSS_COMPILE=i686-linux-android-<br><span class="hljs-comment"># or x86_64-linux-android-</span><br><span class="hljs-comment"># or arm-linux-androideabi-</span><br><span class="hljs-built_in">export</span> CROSS_COMPILE=<span class="hljs-variable">${B2G}</span>/external/qemu/distrib/kernel-toolchain/android-kernel-toolchain-<br><span class="hljs-comment"># or CROSS_COMPILE=${AOSP}/prebuilts/qemu-kernel/kernel-toolchain/android-kernel-toolchain-</span><br></code></pre>

<p>Then build the kernel with </p>

</div><div class="wmd-preview-section preview-content" id="wmd-preview-section-87">

<pre class="prettyprint hljs-dark"><code class="language-bash hljs">make distclean <span class="hljs-comment"># optional, to clean all configs, outputs, etc.</span><br>make goldfish_defconfig <span class="hljs-comment"># or goldfish_armv7_defconfig for arm</span><br>make nconfig <span class="hljs-comment"># optional, only if you want to change the config</span><br>make -j8<br></code></pre>

<p>The output should be at <code>arch/arm/boot/zImage</code> or <code>arch/x86/boot/bzImage</code>. Copy and rename it to <code>kernel-qemu</code> before use.</p>

<hr></div><div class="preview-content" id="wmd-preview-section-footnotes"></div></div>
                </div>
            </div>
        </div>
        <div style="-moz-user-select: none; transform: translate(209px, -6px);" class="extension-preview-buttons closed animate">
            <div data-original-title="Drag me!" class="btn-group drag-me dropup" title="">
                <i class="icon-ellipsis-vert"></i>
            </div>
        <div class="btn-group dropup"><button data-original-title="Markdown syntax" class="btn btn-success dropdown-toggle button-markdown-syntax" title="" vine-click="SHOW_HELP">
	<i class="icon-help-circled"></i>
</button>

</div><div class="btn-group dropup"><button data-original-title="Table of contents" class="btn btn-success dropdown-toggle" title="" data-toggle="dropdown">
    <i class="icon-list"></i>
</button>
<div class="dropdown-menu pull-right">
    <h3>Table of contents</h3>
    <hr>
    <div class="table-of-contents"><div class="toc">
<ul>
<li><a href="#study-on-emulator">Study on Emulator</a><ul>
<li><a href="#prefix">Prefix</a></li>
<li><a href="#build-run-emulator">Build &amp; Run Emulator</a><ul>
<li><a href="#classic-and-qemu2-emulator">Classic and QEMU2 Emulator</a></li>
<li><a href="#build-emulator">Build Emulator</a></li>
<li><a href="#emulator-binaries">Emulator Binaries</a></li>
<li><a href="#launch-emulator-from-aosp-b2g-tree">Launch Emulator from AOSP / B2G Tree</a></li>
<li><a href="#use-writable-system-image">Use Writable System Image</a></li>
</ul>
</li>
<li><a href="#emulator-initialization">Emulator Initialization</a><ul>
<li><a href="#machine-initialization">Machine Initialization</a></li>
<li><a href="#the-main-loop">The Main Loop</a></li>
</ul>
</li>
<li><a href="#skin-ui-handling">Skin &amp; UI Handling</a></li>
<li><a href="#the-goldfish-virtual-platform">The Goldfish Virtual Platform</a><ul>
<li><a href="#goldfish-device-registration">Goldfish Device Registration</a></li>
<li><a href="#goldfish-platform-bus">Goldfish Platform Bus</a><ul>
<li><a href="#discoverability">Discoverability</a></li>
<li><a href="#virtual-device-design">Virtual Device Design</a></li>
<li><a href="#kernel-driver-implementation">Kernel Driver Implementation</a></li>
<li><a href="#procioports">/proc/ioports</a></li>
<li><a href="#prociomem">/proc/iomem</a></li>
</ul>
</li>
<li><a href="#emulator-implementation-x86">Emulator Implementation (x86)</a></li>
<li><a href="#qemu-pipe-goldfish-pipe">QEMU Pipe / Goldfish Pipe</a><ul>
<li><a href="#qemu-pipe-services">QEMU Pipe Services</a><ul>
<li><a href="#workflow">Workflow</a></li>
</ul>
</li>
<li><a href="#adaptation-of-legacy-qemud">Adaptation of Legacy QEMUD</a><ul>
<li><a href="#initialization-flow">Initialization Flow</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#qemud-services">QEMUD Services</a><ul>
<li><a href="#workflow-1">Workflow</a></li>
<li><a href="#initialization">Initialization</a></li>
<li><a href="#client-sends-messages">Client Sends Messages</a></li>
<li><a href="#client-reads-messages">Client Reads Messages</a></li>
</ul>
</li>
<li><a href="#chardriverstate">CharDriverState</a><ul>
<li><a href="#initialization-1">Initialization</a></li>
<li><a href="#writing">Writing</a></li>
<li><a href="#reading">Reading</a></li>
<li><a href="#charbuffer">CharBuffer</a></li>
<li><a href="#charpipe">CharPipe</a></li>
<li><a href="#charpipe-charbuffer-polling">CharPipe / CharBuffer Polling</a></li>
</ul>
</li>
<li><a href="#opengl-emulation">OpenGL Emulation</a></li>
</ul>
</li>
<li><a href="#build-goldfish-kernel">Build Goldfish Kernel</a><ul>
<li><a href="#special-setup-for-mac-os-x">Special Setup for Mac OS X</a><ul>
<li><a href="#copy-elfutils-headers">Copy elfutils headers:</a></li>
<li><a href="#create-usrlocalincludelinuxtypesh">Create /usr/local/include/linux/types.h:</a></li>
<li><a href="#install-gnu-sed">Install GNU sed.</a></li>
</ul>
</li>
<li><a href="#build-the-kernel">Build the Kernel</a><ul>
<li><a href="#build-the-kernel-manually">Build the Kernel Manually</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
    <hr>
</div>
</div><div class="btn-group dropup"><button data-original-title="Document statistics" class="btn btn-success dropdown-toggle stat-button" title="" data-toggle="dropdown">
	<i class="icon-chart-bar"></i>
	<span class="value">27360</span>
</button>
<div class="dropdown-menu pull-right stat-button-dropdown">
    <h3> Statistics</h3>
    <hr>
	<div class="stat">
		<div>
			Characters: <span class="value1">27360</span>
		</div>
        
		<div style="">
			Words: <span class="value2">4129</span>
		</div>
        
		<div>
            Paragraphs: <span class="value3">395</span>
		</div>
	</div>
</div>
</div><div class="btn-group dropup"><button data-original-title="Preview document" class="btn btn-success dropdown-toggle button-markdown-syntax" title="" vine-click="PREVIEW_DOCUMENT:1">
	<i class="icon-desktop"></i>
</button>

</div></div>
        <button class="btn btn-success" id="toggle-preview" vine-click="PREVIEW_DOCUMENT:0">
            <i class="icon-direction" title="Back to edit"></i>
        </button>
    <div style="display: none;" class="find-replace"><button type="button" class="close button-find-replace-dismiss">×</button>
<div class="form-inline">
    <div class="form-group">
        <label for="input-find-replace-search-for">Search for</label>
        <input class="form-control" id="input-find-replace-search-for" placeholder="Search for">
    </div>
    <div class="form-group">
        <label for="input-find-replace-replace-with">Replace with</label>
        <input class="form-control" id="input-find-replace-replace-with" placeholder="Replace with">
    </div>
</div>
<div class="pull-right">
    <div class="help-block text-right">
        <span class="found-counter">0</span> found
    </div>
    <div>
        <button type="button" class="btn btn-primary search-button">Search</button>
        <button type="button" class="btn btn-default replace-button">Replace</button>
        <button type="button" class="btn btn-default replace-all-button">All</button>
    </div>
</div>
<div class="pull-left">
    <div class="checkbox">
        <label>
            <input class="checkbox-case-sensitive" type="checkbox"> Case sensitive
        </label>
    </div>
    <div class="checkbox">
        <label>
            <input class="checkbox-regexp" type="checkbox"> Regular expression
        </label>
    </div>
</div>
</div></div>
    <div id="wmd-button-bar" class="hide"><ul class="wmd-button-row" id="wmd-button-row"><li title="Emphasis &lt;em&gt; Ctrl/Cmd+I" id="wmd-italic-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -20px 0px; display: none;"></span></li><li style="left: 0px;" id="wmd-spacer1" class="wmd-spacer wmd-spacer1 btn btn-success"></li><li style="left: 0px;" id="wmd-spacer2" class="wmd-spacer wmd-spacer2 btn btn-success"></li><li title="Numbered List &lt;ol&gt; Ctrl/Cmd+O" id="wmd-olist-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -120px 0px; display: none;"></span></li><li title="Bulleted List &lt;ul&gt; Ctrl/Cmd+U" id="wmd-ulist-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -140px 0px; display: none;"></span></li><li style="left: 0px;" id="wmd-spacer3" class="wmd-spacer wmd-spacer3 btn btn-success"></li><li title="Undo - Ctrl/Cmd+Z" id="wmd-undo-button" style="left: 0px;" class="wmd-button disabled btn btn-success"><span style="background-position: -200px -20px; display: none;"></span></li><li title="Redo - Ctrl/Cmd+Y" id="wmd-redo-button" style="left: 0px;" class="wmd-button disabled btn btn-success"><span style="background-position: -220px -20px; display: none;"></span></li><li title="Table" id="wmd-table-button" style="left: 0px;" class="wmd-button btn btn-success"><span style="background-position: -240px 0px; display: none;"></span></li></ul></div>

    <div style="right: -325px;" class="menu-panel">
        <!--<button class="btn toggle-button" title="Menu">
            <img
                data-stackedit-src="menu-icon.png" width="24" height="24" />
        </button>-->

        <div class="panel-content ">
            <div vine-switch-on="IS_USER_AUTHED">
                <custom style="display: inline;" switch-when="true">
                <div class="username" vine-bind="user"><span>freesamael</span><a href="javascript:void(0)" vine-click="VIP_CHARGE" target="_blank"><span data-original-title="Pro to 2016-08-31" title="" class="vip-status "><i class="icon icon-star"></i><span class="renew">Renew</span></span></a></div>
                <div class="list-group">
                    <a href="javascript:void(0)" class="list-group-item" vine-click="LOG_OUT"><i class="icon-logout"></i>
                        Logout</a> 
                </div>
                </custom>
                <custom style="display: none;" switch-default="">
                <div class="list-group">
                    
                    <a href="javascript:void(0)" class="list-group-item" vine-click="REDIRECT_AUTH:evernote"><i class="icon-login"></i>
                        Link with Evernote</a>
                    
                </div>

                </custom>
            </div>
            <div class="dropdown-header">CURRENT DOCUMENT</div>
            <div class="list-group">
                <a href="javascript:void(0)" class="list-group-item" vine-click="DISCARD_MODIFY"><i class="icon-reply"></i> Restore to last sync</a>
                <a href="javascript:void(0)" class="list-group-item" vine-click="CONFIRM_DELETE_FILE"><i class="icon-trash"></i> Delete document</a>
                <!--<a href="javascript:void(0)"  class="list-group-item" vine-click='EXPORT_MD_FILE' ><i class="icon-download"></i> Export to disk</a> -->
                <!--<a href="javascript:void(0)"  class="list-group-item" data-toggle="modal" data-target=".modal-pdf-hint"><i class="icon-download"></i> Export to PDF</a>-->
                <a href="javascript:void(0)" data-toggle="collapse" data-target=".collapse-export" class="list-group-item"><i class="icon-download"></i> Export as...</a>
                <div class="sub-menu collapse-export clearfix collapse">
                    <ul class="nav">
                        <li><a href="javascript:void(0)" vine-click="EXPORT_MD_FILE">Markdown</a></li>
                        <li><a href="javascript:void(0)" vine-click="EXPORT_HTML_FILE">HTML</a></li>

                        <li><a href="#" data-toggle="modal" data-target=".modal-pdf-hint">PDF</a></li>
                    </ul>
                </div>
                <a href="javascript:void(0)" class="list-group-item" vine-click="PREVIEW_DOCUMENT:1"><i class="icon-desktop"></i> Preview document</a>
                <a href="javascript:void(0)" class="list-group-item" vine-click="SHARE_DOCUMENT"><i class="icon-share"></i> Share link</a>
            </div>
            <div class="dropdown-header">SYSTEM</div>
            <ul class="list-group nav">

                <li><a href="#" class="list-group-item action-load-settings" data-toggle="modal" data-target=".modal-settings"><i class="icon-cog"></i> Settings</a></li>


                
                <li><a tabindex="-1" href="http://marxi.co/client_en" target="_blank" class="list-group-item"><i class="icon-rocket"></i> Get Desktop client</a></li>
                <li><a tabindex="-1" href="https://chrome.google.com/webstore/detail/kidnkfckhbdkfgbicccmdggmpgogehop" target="_blank" class="list-group-item"><i class="icon-gift"></i> Get Chrome app</a></li>
                
                <li><a href="#" data-toggle="modal" vine-click="OPEN_FILE:readme:_blank" class="list-group-item"><i class="icon-doc-text"></i> Welcome document</a></li>
                <li><a href="#" data-toggle="modal" vine-click="SHOW_HELP" class="list-group-item"><i class="icon-help-circled"></i> Quick help</a></li>

                
                <li><a href="#" data-toggle="modal" class="list-group-item" data-target=".modal-about"><i class="icon-attention-circled"></i> About</a></li>

            </ul>
        </div> 

    </div>


    <div class="document-panel">
        <!--<button class="btn toggle-button" title="Select document Ctrl+[ Ctrl+]">
            <i class="icon-folder-open"></i>
        </button>
        <div class="search-bar clearfix">
            <ul class="nav">
                <li><a href="#" class="action-create-file"><i
                        class="icon-file"></i> New document</a></li>
                <li><a href="#" class="action-remove-file-confirm"><i
                        class="icon-trash"></i> Delete document</a></li>
                <li><a href="#" data-toggle="modal" data-target=".modal-document-manager"><i
                        class="icon-layers"></i> Manage documents</a></li>
            </ul>
            <div class="input-group">
                <span class="input-group-addon"><i class="icon-search"></i></span><input
                    type="text" class="form-control" placeholder="Find document" />
            </div>
        </div>
        <div class="panel-content">
            <div class="list-group document-list"></div>
            <div class="list-group document-list-filtered hide"></div>
        </div>
        -->
        <div class="search-bar clearfix">
            <div class="input-group" id="search-and-sync">
                <input placeholder="Search file" class="form-control" vine-model="file_search" type="text">
                <span data-original-title="Sync list from Evernote" class="input-group-addon btn sync-list" vine-click="FETCH_LATEST_NOTES" title=""><i class="icon-arrows-cw"></i></span>
            </div>
        </div>
        <div class="panel-content">
            <div class="folder-top folder-wrapper active list-group">
            </div>
            <div class="list-group document-list">
                <div class="nav" role="menu">
                      

                    <!-- searchlist | file_filter:file_search:notebook,status,title --><div tabindex="1" vine-repeat="searchlist | file_filter:file_search:notebook,status,title" class="active  file-wrapper">
                        
                                                <div>
                                                    <a vine-click="OPEN_FILE:1441338155787" href="javascript:void(0)" class="list-group-item file-item synced " data-file="1441338155787">
                        
                                                        <span class="file-notebook">
                                                            <span class="label label-success">Samael's Notebook </span>
                                    <!--
                                                            -->
                                                            
                                                            <!--
                                          
                                                            -->
                                                        </span>
                                                        <span class="file-action">
                                                            <i data-original-title="Delete document(D)" class="icon-trash" vine-mousedown="CONFIRM_DELETE_FILE:1441338155787" title=""></i>
                                                            <i data-original-title="Open in new window(O)" class="icon-link-ext" vine-mousedown="OPEN_FILE:1441338155787:_blank" title=""></i>
                        
                                                            <i data-original-title="Open in Evernote(V)" class="icon-eye" vine-mousedown="EVERNOTE_VIEW:578e2607-6295-4378-8403-7df4a53dacfc:Samael's Notebook" title=""></i>

                                                            <i data-original-title="Star document(S)" class="icon-star" vine-mousedown="STAR_FILE:1441338155787" title=""></i>
                                </span>
                                <span>Study on Emulator</span>
                                                        <span class="file-status-label">
                                                        </span>
                                                    </a>
                                                    </div>
                                                                    </div><div tabindex="1" vine-repeat="searchlist | file_filter:file_search:notebook,status,title" class=" file-wrapper">
                        
                                                <div>
                                                    <a vine-click="OPEN_FILE:1435818901000" href="javascript:void(0)" class="list-group-item file-item synced " data-file="1435818901000">
                        
                                                        <span class="file-notebook">
                                                            <span class="label label-success">Samael's Notebook </span>
                                    <!--
                                                            -->
                                                            
                                                            <!--
                                          
                                                            -->
                                                        </span>
                                                        <span class="file-action">
                                                            <i data-original-title="Delete document(D)" class="icon-trash" vine-mousedown="CONFIRM_DELETE_FILE:1435818901000" title=""></i>
                                                            <i data-original-title="Open in new window(O)" class="icon-link-ext" vine-mousedown="OPEN_FILE:1435818901000:_blank" title=""></i>
                        
                                                            <i data-original-title="Open in Evernote(V)" class="icon-eye" vine-mousedown="EVERNOTE_VIEW:6b363ea9-1152-43ac-a4ab-1dfb796e422d:Samael's Notebook" title=""></i>

                                                            <i data-original-title="Star document(S)" class="icon-star" vine-mousedown="STAR_FILE:1435818901000" title=""></i>
                                </span>
                                <span>Welcome to Marxico</span>
                                                        <span class="file-status-label">
                                                        </span>
                                                    </a>
                                                    </div>
                                                                    </div><div tabindex="1" vine-repeat="searchlist | file_filter:file_search:notebook,status,title" class=" file-wrapper">
                        
                                                <div>
                                                    <a vine-click="OPEN_FILE:1441092807000" href="javascript:void(0)" class="list-group-item file-item synced " data-file="1441092807000">
                        
                                                        <span class="file-notebook">
                                                            <span class="label label-success">Samael's Notebook </span>
                                    <!--
                                                            -->
                                                            
                                                            <!--
                                          
                                                            -->
                                                        </span>
                                                        <span class="file-action">
                                                            <i data-original-title="Delete document(D)" class="icon-trash" vine-mousedown="CONFIRM_DELETE_FILE:1441092807000" title=""></i>
                                                            <i data-original-title="Open in new window(O)" class="icon-link-ext" vine-mousedown="OPEN_FILE:1441092807000:_blank" title=""></i>
                        
                                                            <i data-original-title="Open in Evernote(V)" class="icon-eye" vine-mousedown="EVERNOTE_VIEW:c81aaf20-c622-4456-bf36-eb51696da25a:Samael's Notebook" title=""></i>

                                                            <i data-original-title="Star document(S)" class="icon-star" vine-mousedown="STAR_FILE:1441092807000" title=""></i>
                                </span>
                                <span>Flights to Orlando</span>
                                                        <span class="file-status-label">
                                                        </span>
                                                    </a>
                                                    </div>
                                                                    </div><div tabindex="1" vine-repeat="searchlist | file_filter:file_search:notebook,status,title" class=" file-wrapper">
                        
                                                <div>
                                                    <a vine-click="OPEN_FILE:1436173408000" href="javascript:void(0)" class="list-group-item file-item synced " data-file="1436173408000">
                        
                                                        <span class="file-notebook">
                                                            <span class="label label-success">Samael's Notebook </span>
                                    <!--
                                                            -->
                                                            
                                                            <!--
                                          
                                                            -->
                                                        </span>
                                                        <span class="file-action">
                                                            <i data-original-title="Delete document(D)" class="icon-trash" vine-mousedown="CONFIRM_DELETE_FILE:1436173408000" title=""></i>
                                                            <i data-original-title="Open in new window(O)" class="icon-link-ext" vine-mousedown="OPEN_FILE:1436173408000:_blank" title=""></i>
                        
                                                            <i data-original-title="Open in Evernote(V)" class="icon-eye" vine-mousedown="EVERNOTE_VIEW:bb9245c9-a17d-40e4-8d17-da54406d2896:Samael's Notebook" title=""></i>

                                                            <i data-original-title="Star document(S)" class="icon-star" vine-mousedown="STAR_FILE:1436173408000" title=""></i>
                                </span>
                                <span>XPIDL Development Notes</span>
                                                        <span class="file-status-label">
                                                        </span>
                                                    </a>
                                                    </div>
                                                                    </div>

                    <div class="dropdown-header archive-splitter">Archives</div>
                    <!-- syncedfiles | file_filter:file_search:notebook,status,title --><div tabindex="1" vine-repeat="syncedfiles | file_filter:file_search:notebook,status,title" class=" folder-wrapper">
                      
                        <a href="javascript:void(0)" data-toggle="collapse" data-target=".folder-content0" class="list-group-item"><i class="icon-folder-empty"></i><i class="icon-folder-open-empty"></i> Samael's Notebook</a>

                        <div class="sub-menu folder-content0 clearfix   collapse">
                            <ul class="nav">
                                <li class=" file-wrapper">
                        <div>
                            <a vine-click="OPEN_FILE:1435916877000" href="javascript:void(0)" class="list-group-item file-item synced " data-file="1435916877000">

                                <span class="file-notebook">
                                    <span class="label label-success">Samael's Notebook </span>
                                    <!--
                                    -->
                                    
                                    <!--
                  
                                    -->
                                </span>
                                <span class="file-action">
                                    <i data-original-title="Delete document(D)" class="icon-trash" vine-mousedown="CONFIRM_DELETE_FILE:1435916877000" title=""></i>
                                    <i data-original-title="Open in new window(O)" class="icon-link-ext" vine-mousedown="OPEN_FILE:1435916877000:_blank" title=""></i>

                                    <i data-original-title="Open in Evernote(V)" class="icon-eye" vine-mousedown="EVERNOTE_VIEW:27c16bc0-65e2-411f-b52b-2ef4ca8cd216:Samael's Notebook" title=""></i>

                                    <i data-original-title="Star document(S)" class="icon-star" vine-mousedown="STAR_FILE:1435916877000" title=""></i>
                                </span>
                                <span>Web IDL Development Notes</span>
                                <span class="file-status-label">
                                </span>
                            </a>
                            </div>
                        </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="list-group document-list-filtered hide"></div>
        </div>
    </div>
</div>

<div class="modal fade modal-document-manager">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h2 class="modal-title">Manage documents</h2>
            </div>
            <div class="modal-body">
                <div></div>
                <ul class="nav nav-pills document-list">
                    <li class="pull-right dropdown"><a href="#" data-toggle="dropdown"><i class="icon-check"></i> Selection <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="#" class="action-select-all"><i class="icon-check"></i> Select all</a></li>
                        <li><a href="#" class="action-unselect-all"><i class="icon-check-empty"></i> Unselect all</a></li>
                        <li class="divider"></li>
                        <li><a href="#" class="action-move-items"><i class="icon-forward"></i> Move to folder</a></li>
                        <li><a href="#" class="action-delete-items"><i class="icon-trash"></i> Delete</a></li>
                    </ul></li>
                    <li class="pull-right"><a href="#" class="action-create-folder"> <i class="icon-folder"></i>
                        Create folder
                    </a></li>
                    <li class="disabled"><a><i class="icon-file"></i> <span class="document-count"></span></a></li>
                    <li class="disabled"><a><i class="icon-folder"></i> <span class="folder-count"></span></a></li>
                </ul>
                <div class="list-group document-list"></div>
                <p class="confirm-delete hide">The following documents will be
                deleted locally:</p>
                <p class="choose-folder hide">Please choose a destination
                folder:</p>
                <div class="list-group selected-document-list hide"></div>
                <div class="list-group select-folder-list hide"></div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-default confirm-delete choose-folder action-cancel hide">Cancel</a>
                <a href="#" class="btn btn-primary confirm-delete action-delete-items-confirm hide">OK</a>
                <a href="#" class="btn btn-primary document-list" data-dismiss="modal">Close</a>
            </div>
        </div>


    </div>
</div>


<div class="modal fade modal-non-unique">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h2 class="modal-title">Ooops...</h2>
            </div>
            <div class="modal-body">
                <p>StackEdit has stopped because another instance was running in
                the same browser.</p>
                <blockquote>
                    <p>If you want to reopen StackEdit, click on
                    "Reload".</p>
                </blockquote>
            </div>
            <div class="modal-footer">
                <a href="javascript:window.location.reload();" class="btn btn-primary">Reload</a>
            </div>
        </div>
    </div>
</div>


<div class="modal fade modal-app-reset">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h2 class="modal-title">Reset application</h2>
            </div>
            <div class="modal-body">
                <p>This will delete all your local documents.</p>
                <blockquote><b>Are you sure?</b></blockquote>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
                <a href="#" class="btn btn-primary action-app-reset" data-dismiss="modal">OK</a>
            </div>
        </div>
    </div>
</div>


<div class="modal fade modal-import-docs-settings">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h2 class="modal-title">Import documents and settings</h2>
            </div>
            <div class="modal-body">
                <p>This will delete all existing local documents.</p>
                <blockquote><b>Are you sure?</b></blockquote>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
                <a href="#" class="btn btn-primary action-import-docs-settings-confirm" data-dismiss="modal">OK</a>
            </div>
        </div>
    </div>
</div>

<div id="modal-generic" class="modal hide fade in">
    <div class="modal-header">
        <a href="#" class="close" data-dismiss="modal">×</a>
        <h3></h3>
    </div>
    <div class="modal-body">
    </div>
    <div class="modal-footer">
    </div>
</div>


<div class="modal modal-insert-link" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3 class="modal-title">Hyperlink</h3>
            </div>
            <div class="modal-body">
                <p>Please provide the link URL and an optional title:</p>
                <div class="input-group">
                    <span class="input-group-addon"><i class="icon-globe"></i></span><input id="input-insert-link" class="col-lg-5 form-control" placeholder="http://example.com/ &quot;optional title&quot;" type="text">
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
                <a href="#" class="btn btn-primary action-insert-link" data-dismiss="modal">OK</a>
            </div>
        </div>
    </div>
</div>


<div class="modal modal-insert-image" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3 class="modal-title">Image</h3>
            </div>
            <div class="modal-body">
                <p>Please provide the image URL:</p>
                <div class="input-group">
                    <span class="input-group-addon"><i class="icon-picture"></i></span><input id="input-insert-image" class="col-lg-5 form-control" placeholder="http://example.com/image.jpg" type="text">
                </div>
                <div class="help-block"><b>NOTE:</b> <span>Marxico supports copying image from clipboard. Try to capture a screenshot and paste.</span></div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-default footer-left-btn"><input id="uploader" name="files[]" multiple="" onchange="" style="position:absolute; top:0; right:0; opacity:0; filter: alpha(opacity=0); font-size:23px; direction: ltr; cursor: pointer;" type="file"><i class="icon-hdd"></i>Import local images &amp; attachments...</a> <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a> <a href="#" class="btn btn-primary action-insert-image" data-dismiss="modal">OK</a>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-save-error">
    <div class="modal-dialog slim">
        <div class="modal-content">

            <div class="modal-header" style="color:#B90B0B;">
                <h3 class="modal-title">Sync Note Error</h3>
            </div>
            <div class="modal-body">
                <p><b>Error code:</b><span class="error-code"></span></p>
                <blockquote><pre class="error-message"></pre></blockquote>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary " data-dismiss="modal">OK</a>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-remove-file-confirm" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3 class="modal-title">Delete</h3>
            </div>
            <div class="modal-body">
                <p id="remove-hint">Are you sure to delete <code id="remove-filename"></code>?</p>
                <blockquote>
                    <h5>NOTE:</h5> <p><code>Delete</code> only removes the file in local storage. If you want to delete the local file and the synced note in Evernote, using <code>Delete thoroughly</code>'.</p><p>It is a bug for Evernote client being unable to delete notes of Marxico. You can do that on Evernote Web.</p> 
                </blockquote>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-danger footer-left-btn action-remove-file" vine-click="DELETE_FILE2" data-dismiss="modal">Delete thoroughly</a>                
                <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
                <a href="#" class="btn btn-primary action-remove-file" data-dismiss="modal" vine-click="DELETE_FILE">Delete</a>
            </div>
        </div>
    </div>
</div>


<div class="modal modal-file-conflict error" role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">

            <div class="modal-header">
                <h3 class="modal-title">File Conflict</h3>
            </div>
            <div class="modal-body">
                <p>Detected that there are local modifications. The local version would be opened. Please carefully check the two versions and decide whether to sync or delete the local one. Please backup your data first.</p>
                <blockquote>
                    If you confirm that the local version is out of date and want the version in Evernote, please click <code>Delete document</code> on the right side menu, and then find the note in Evernote and click the red button on the top right of the note.
                </blockquote>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary " data-dismiss="modal">OK</a>
            </div>
        </div>
    </div>
</div>
<div class="modal modal-version-conflict error" role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">

            <div class="modal-header">
                <h3 class="modal-title">File Conflict</h3>
            </div>
            <div class="modal-body">
                <p>Detected that there is a newer version of this note in Evernote. Please open Evernote to see the newer one, carefully check the two versions and decide whether to sync or delete the local one. Please backup your data first.</p>
                <blockquote>
                    If you confirm that the local version is out of date and want the version in Evernote, please click <code>Delete document</code> on the right side menu, and then find the note in Evernote and click the red button on the top right of the note.
                </blockquote>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary " data-dismiss="modal">OK</a>
            </div>
        </div>
    </div>
</div>


<div class="modal modal-help" role="dialog" tabindex="-1">
    <div class="modal-dialog">
        <div class="markdown-syntax" platform-related="">
            <table class="markdown-table">
		<tbody><tr> <td>Emphasis</td><td><pre>*Italic*	**Bold**</pre></td><td><kbd>Cmd</kbd><kbd>I/B</kbd></td> </tr>
		<tr> <td>Link</td><td><pre>[Opt](http://example.com)</pre></td><td><kbd>Cmd</kbd><kbd>L</kbd></td> </tr>
		<tr> <td>Image</td><td><pre>![Opt](example.jpg)</pre></td><td><kbd>Cmd</kbd><kbd>G</kbd></td> </tr>
		<tr> <td>Heading</td><td>
<pre>Heading1		Heading2
========		--------

## Heading2		###### Heading6
</pre>	
		</td><td><kbd>Cmd</kbd><kbd>H</kbd></td> </tr>
		<tr> <td>List</td><td>
<pre>1. Numbered list	- Bulleted list
2. Numbered list	- Bulleted list
</pre>
		</td><td></td> </tr>
		<tr> <td>Blockquote</td><td>
<pre>&gt; This is quote content
&gt; it can embed heading or list
</pre>		
		</td><td></td> </tr>
		<tr> <td>Code</td><td>
<pre><i>Inline code</i> `var a=1`,  <i>code block:</i>：
```ruby
print 'Hello world'
```
</pre>	
		</td><td><kbd>Cmd</kbd><kbd>K</kbd></td> </tr>
		<tr> <td>LaTex</td><td>
<pre><i>Inline</i> $ y = x $ , <i>block:</i>：
$$ a^2 + b^2 = c^2 $$
</pre>	
		</td><td></td> </tr>
		<tr> <td>Table</td><td>
<pre>| Item      |    Value | Qty  |
| :-------- | --------:| :--: |
| Computer  | 1600 USD |  5   |
</pre>

		</td><td><kbd>Cmd</kbd><kbd>Opt</kbd><kbd>T</kbd></td> </tr>
		</tbody></table>

<table class="key-table">
<tbody><tr><td>Doc Management</td>
<td><kbd>Cmd</kbd><kbd>O</kbd></td>
</tr>
<tr>
<td>Help</td>
<td><kbd>Cmd</kbd><kbd>/</kbd></td>
</tr>
<tr>
</tr><tr>
<td>Maximize Editor</td>
<td><kbd>Cmd</kbd><kbd>Enter</kbd></td>
</tr>
<tr>
<td>Preview Doc</td>
<td><kbd>Cmd</kbd><kbd>Opt</kbd><kbd>Enter</kbd></td>
</tr>
<tr>
<td>Sync Doc</td>
<td><kbd>Cmd</kbd><kbd>S</kbd></td>
</tr>
<tr>
</tr><tr>
<td>Create Doc</td>
<td><kbd>Cmd</kbd><kbd>Opt</kbd><kbd>N</kbd></td>
</tr>
<tr>
<td>Menu</td>
<td><kbd>Cmd</kbd><kbd>M</kbd></td>
</tr>
<!--
<tr>
<td>Zoom FontSize</td>
<td><kbd>Cmd</kbd><kbd>+/-</kbd></td>
</tr>
-->
</tbody></table>

        </div>
    </div>
</div>
<div class="modal modal-notify slim" role="dialog" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

        </div>
    </div>
</div>


<div class="modal modal-auto-sync " role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">

            <div class="modal-header">
                <h3 class="modal-title">Attention</h3>
            </div>
            <div class="modal-body">
                <p>The current document hasn't synced to Evernote for a while. Sync it now?</p>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary " data-dismiss="modal" vine-click="SYNC_FILE">OK</a>
                <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-missing-images " role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">

            <div class="modal-header">
                <h3 class="modal-title">Sync Note Error</h3>
            </div>
            <div class="modal-body">
                <p>There are images failed to load. Please fix and retry. If any questions, backup your data and concat hustgock@gmail.com.</p><blockquote> NOTE: Marxico may fail to load images when opening notes from Evernote occasionally, if this is the case, delete local file and reopen from Evernote.</blockquote><p></p>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary " data-dismiss="modal">OK</a>
                <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-wait-pay slim" role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Thanks for your support!</h3>
            </div>
            <div class="modal-body">
                <p>Please confirm your payment status:</p>
            </div>
            <div class="modal-footer">
                <a href="javascript:void(0)" vine-click="CHECK_PAY_STATUS" class="btn btn-primary" data-dismiss="modal" target="_blank">Accomplished</a>
                <a href="javascript:void(0)" vine-click="HINT_PAY_FAIL" class="btn btn-warning" data-dismiss="modal" target="_blank">No, I had problems</a>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-pay-success slim" role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Payment succeed</h3>
            </div>
            <div class="modal-body">
                <table>
                    <thead><tr><td>Order No.</td><td>Due</td></tr></thead>
                    <tbody><!-- SUCCESS_ORDERS -->
                </tbody></table>
            </div>
            <div class="modal-footer">
                <a href="javascript:void(0)" data-dismiss="modal" class="btn btn-primary">OK</a>
            </div>
        </div>
    </div>
</div>
<div class="modal modal-pay-fail slim" role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Payment failed?</h3>
            </div>
            <div class="modal-body">
                <p>If you have any problem about payment, please keep calm and concat hustgock@gmail.com</p>
            </div>
            <div class="modal-footer">
                <a href="javascript:void(0)" data-dismiss="modal" class="btn btn-primary">OK</a>
            </div>
        </div>
    </div>
</div>
<div class="modal modal-order-not-found slim" role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Sorry, order not found</h3>
            </div>
            <div class="modal-body">
                <p>If you have any problem about payment, please keep calm and concat hustgock@gmail.com</p>
            </div>
            <div class="modal-footer">
                <a href="javascript:void(0)" data-dismiss="modal" class="btn btn-primary">OK</a>
            </div>
        </div>
    </div>
</div>


<div class="modal modal-share-link" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3 class="modal-title">Share link</h3>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <a href="" target="_blank" id="share-link" style="word-break: break-all;"></a>
                    <div class="help-block">Share link enables you to share your note with others.</div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-default footer-left-btn" vine-click="STOP_SHARE_DOCUMENT"><i class="icon-unlink"></i> Stop share</a>
                <a href="#" class="btn btn-primary" data-dismiss="modal">OK</a>
            </div>
        </div>
    </div>
</div>
<div class="modal modal-china-jump slim" role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Are you from China?</h3>
            </div>
            <div class="modal-body">
                <p>If yes, the app would change to Chinese language and link to faster server.</p>
            </div>
            <div class="modal-footer">
                <a href="javascript:void(0)" vine-click="CHANGE_LANGUAGE:zh" class="btn btn-primary" data-dismiss="modal" target="_blank">Yes, I am</a>
                <a href="javascript:void(0)" class="btn btn-warning" data-dismiss="modal" target="_blank">No</a>
            </div>
        </div>
    </div>
</div>
<div class="modal modal-fast-redirect " role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">

            <div class="modal-header">
                <h3 class="modal-title">Fast redirect</h3>
            </div>
            <div class="modal-body">
                <p>Click the link below to enalbe fast redirect from the browser to client when opening notes from Evernote.</p>
                <div><a href="http://marxi.co/batch_settings_en.html?key=fast_redirect" target="_blank" vine-click="ENABLED_FAST_REDIRECT">Enable browser redirect</a></div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-default" data-dismiss="modal">OK</a>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-settings" aria-hidden="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3 class="modal-title">Settings</h3>
                <ul class="nav nav-tabs">
                    <li class="active"><a class="action-load-settings" href="#tabpane-settings-basic" data-toggle="tab">Basic</a></li>
                    <li><a class="action-load-settings" href="#tabpane-settings-style" data-toggle="tab">Style</a></li>
                    <!--<li><a class="action-load-settings"
						href="#tabpane-settings-extensions" data-toggle="tab">Extensions</a></li>-->
					<!--<li><a class="action-load-settings"
						href="#tabpane-settings-utils" data-toggle="tab">Utils</a></li>-->
                </ul>
            </div>
            <div class="modal-body">
                <form id="settings">
                    <div class="tab-content clearfix">
                        <div class="tab-pane active" id="tabpane-settings-basic">
                            <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-lg-4 control-label">Editor</label>
                                <div class="col-lg-7">
                                <select name="editor" class="form-control"><option selected="selected" value="light">Lite</option><option value="ace">Traditional</option></select>
                                <div class="help-block">Lite is recommended generally, however may feels sluggish under certain circumstances. The Traditional is more responsive, and supports Vim &amp; Emacs key bindings and line numbers.</div>
                                </div>
                            </div>
                            <div style="display: none;" class="form-group only-ace editor-related" platform-related="">
                                    <label class="col-lg-4 control-label">Key bindings</label>
                                    <div class="col-lg-7">
                                        <div class="radio">
                                            <label> <input name="key_bindings" value="" type="radio">
                                                Normal
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label> <input name="key_bindings" value="ace/keyboard/vim" type="radio">
                                                Vim <!--<div class='radio-hint'>(Some Markdown shortcuts become Cmd + Opt + *）</div>-->
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label> <input name="key_bindings" value="ace/keyboard/emacs" type="radio">
                                                Emacs<!--<div class='radio-hint'>(All Markdown shortcuts become Cmd + Opt + *)</div>-->
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: none;" class="form-group only-ace editor-related">
                                    <label class="col-lg-4 control-label">Show line number</label>
                                    <div class="col-lg-7">
                                        <div class="checkbox">
                                            <label> <input name="line_number" type="checkbox">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <!--
                                <div class="form-group">
                                    <label class="col-lg-4 control-label">Default layout</label>
                                    <div class="col-lg-7">
                                        <div class="checkbox">
                                            <label> <input type="checkbox" name="layout.editor" checked="checked" disabled>
                                                Editor
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label> <input type="checkbox" name="layout.preview" checked="checked">
                                                Preview
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label> <input type="checkbox" name="layout.toolbar" checked="checked">
                                                Toolbar
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                -->
                                <div class="form-group">
                                    <label class="col-lg-4 control-label">Note saved in Evernote</label>
                                    <div class="col-lg-7">
                                        <div class="checkbox">
                                            <label> <input name="publish.title" checked="checked" type="checkbox">
                                                With title
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label> <input name="publish.tags" type="checkbox">
                                                With tags
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label> <input name="evernote_readonly" checked="checked" type="checkbox">
                                                Read only
                                            </label>

                                            <div class="help-block">Strongly recommended. Notes created by Marxico, may lose data once processed by Evernote editor.</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-4 control-label">Auto sync</label>
                                    <div class="col-lg-7">
                                        <div class="checkbox">
                                            <label> <input name="auto_sync2" type="checkbox">
                                                Auto sync to Evernote every 10 minutes
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        <div class="tab-pane" id="tabpane-settings-style">
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-lg-4 control-label">Code highlight</label>
                                    <div class="col-lg-7">
                                        <select name="code_highlight" class="form-control"><option selected="selected" value="hljs-dark">Dark</option><option value="hljs-light">Light</option><option value="">None</option></select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-4 control-label">LaTex output<a data-original-title="PNG has wider support, however may be fuzzing when scaling.&lt;br&gt;&lt;br&gt;SVG keeps its clarity when scaling, while needs larger size and is incompatible with Android 4.3 below." href="#" title="">(?)</a></label>
                                    <div class="col-lg-7">
                                        <select name="latex_output" class="form-control"><option selected="selected" value="png">PNG</option><option value="svg">SVG</option></select>

                                        <!-- <div class="help-block">PNG has wider support, however may be fuzzing when scaling.&lt;br&gt;&lt;br&gt;SVG keeps its clarity when scaling, while needs larger size and is incompatible with Android 4.3 below.</div> -->
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-4 control-label">Font size</label>
                                    <div class="col-lg-7">
                                        <input value="16" id="input-settings-font-size" name="font_ratio" class="form-control col-lg-7" type="text">
                                    </div>

                                </div>
                                <div class="form-group">
                                    <label class="col-lg-4 control-label"></label>
                                    <div class="col-lg-7">
                                        <div class="checkbox">
                                            <label> <input name="font_size_to_evernote" type="checkbox"> apply font size to Evernote<a data-original-title="Evernote's default font size is 14px. It looks good for large paragraphs. &lt;br&gt;&lt;br&gt;If your notes have lots of LaTex, 16px and above is better." href="#" title="">(?)</a>
                                            </label> 
                                            <!-- <div class="help-block">Evernote&#39;s default font size is 14px. It looks good for large paragraphs. &lt;br&gt;&lt;br&gt;If your notes have lots of LaTex, 16px and above is better.</div> -->
                                        </div>
                                    </div>
                                </div>
                                <br>
                                <div class="form-group">
                                    <label class="col-lg-4 control-label">Preview font</label>
                                    <div class="col-lg-7 form-inline">
                                        <input name="preview_font" class="form-control col-lg-7" placeholder="DEFAULT" type="text">
                                        <div class="help-block">Example: "Helvetica Neue", Arial</div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-4 control-label">Editor font</label>
                                    <div class="col-lg-7 form-inline ">
                                        <input name="editor_font" class="form-control col-lg-7" placeholder="DEFAULT" type="text">
                                        <div class="help-block">Only monospaced fonts are supported. Otherwise it may cause cursor dislocation.</div>
                                        <div class="help-block">Example: Menlo, Consolas, "Courier New"</div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-4 control-label">Custom render CSS</label>
                                    <div class="col-lg-7 form-inline ">
                                        <textarea name="custom_css" class="form-control" spellcheck="false">/**
Write your own CSS. For example:
h1 {
  border-bottom: 1px solid #ccc;
  line-height:1.6;
}
body {
  background:#FDFFD0
}
**/
</textarea>	
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tabpane-settings-extensions" style="display:none;">
						<div class="panel-group accordion-extensions"></div>
						<span class="help-block pull-right"><a target="_blank" href="https://github.com/benweet/stackedit/blob/master/doc/developer-guide.md#developer-guide">Create
								your own extension...</a></span>
					</div>
					<div class="tab-pane" id="tabpane-settings-utils">
						<div class="tab-pane-button-container">
							<a href="#" class="btn btn-block btn-default action-welcome-file" data-dismiss="modal"><i class="icon-help-circled"></i>
								Hello! document</a> <a href="#" class="btn btn-block btn-default action-welcome-tour" data-dismiss="modal"><i class="icon-help-circled"></i> Welcome tour</a>
						</div>
						<div class="tab-pane-button-container">
							<a href="#" class="btn btn-block btn-default action-import-docs-settings"><i class="icon-cog-alt"></i> Import docs &amp; settings</a> <a href="#" class="btn btn-block btn-default action-export-docs-settings" data-dismiss="modal"><i class="icon-cog-alt"></i>
								Export docs &amp; settings</a> <input id="input-file-import-docs-settings" class="hide" type="file">
						</div>
						<div class="tab-pane-button-container">
							<a href="#" class="btn btn-block btn-default action-default-settings" data-dismiss="modal"><i class="icon-wrench"></i>
								Load default settings</a> <a href="#" class="btn btn-block btn-default" data-dismiss="modal" data-toggle="modal" data-target=".modal-app-reset"><i class="icon-fire"></i> Reset application</a> <a target="_blank" href="http://marxi.co/recovery.html" class="btn btn-block btn-default"><i class="icon-medkit"></i> StackEdit recovery</a>
						</div>
                    </div>
                
            </div></form>
            <div class="modal-footer">
                <a href="#" class="btn btn-default" data-dismiss="modal">Cancel</a>
                <a href="#" class="btn btn-primary action-apply-settings" data-dismiss="modal">OK</a>
            </div>
        </div>
    </div>
</div>
</div>



    <div class="modal modal-changelog slim" role="dialog">
    <div class="modal-dialog slim">
        <div class="modal-content">
			<div class="modal-header">
				<h3 class="modal-title">Update!</h3>
			</div>
			<div class="modal-body">
				
				<ul>
					<li>Release Mac &amp; Windows desktop client</li>
					<li>Bug fix</li>

				</ul>
			</div>
			<div class="modal-footer">
				<a href="https://www.evernote.com/shard/s21/sh/7dd652c0-fcb5-4092-a122-2b6ca54508b6/b1d198daf36cede215c6ee29e0fd44fa" class="btn btn-primary" target="_blank">Read more</a>
				<a class="btn btn-success" href="javascript:void(0)" data-dismiss="modal">OK</a>
			</div>
		</div>
	</div>
</div>

    <div class="modal modal-pdf-hint error" role="dialog">
	<div class="modal-dialog slim">
		<div class="modal-content">

			<!--<div class="modal-header" >
				<h3 class="modal-title">File Conflict</h3>
			</div>
			-->
			<div class="modal-body">
<p>Chrome provides <code>Save as PDF</code> in <code>Print</code> function. Steps:</p>
<ol>
<li>Click <code>Export to PDF</code> at the bottom of the page.</li>
<li>Configure the settings as showed below in <code>Print</code> dialog.
<p>
<img lazy-src="https://d31qtcb7c58z3n.cloudfront.net/images/pdf_en.png?vvv"></p>
</li>
<li>Click <code>Save</code>.</li>
</ol>
			</div>
			<div class="modal-footer">
				<a href="#" class="btn btn-primary " vine-click="EXPORT_PDF" data-dismiss="modal">Export to PDF</a>
			</div>
		</div>
	</div>
</div>

    <div class="modal modal-about" role="dialog">
	<div class="modal-dialog slim">
		<div class="modal-content">

			<div class="modal-header">
				<h3 class="modal-title">Marxico</h3>
			</div>
			<div class="modal-body">
            <dl>
                <dt>Version</dt>
                <dd>1.5.0</dd>
                <dt>Feedback</dt>
                <dd>
                Email: hustgock@gmail.com
                <br>
                Twitter: <a href="https://twitter.com/gock2" target="_blank">@gock2</a>
                </dd>
            <dl>
			</dl></dl></div>
			<div class="modal-footer">
				<a href="#" class="btn btn-primary" data-dismiss="modal">OK</a>
			</div>
		</div>
	</div>
</div>



<div style="display: none;" id="edit-conflict-container">
    <div class="message-content">
        <i class="icon-attention-alt"></i> <span class="message">hustgock and john123 are editing this note</span>
    </div>
</div>


    <script src="android-emulator_files/lib.js"></script>


    <script src="android-emulator_files/main_en.js"></script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
    ga('create', 'UA-43559825-4', 'marxi.co');
    ga('send', 'pageview');
    </script>
    

    

<div id="atwho-container"><div id="atwho-ground-4d5f1cb11442891274229"><div id="at-view-notebook" class="atwho-view"><ul class="atwho-view-ul"></ul></div></div><div id="atwho-ground-05e0d5071442891274230"><div id="at-view-notebook" class="atwho-view"><ul class="atwho-view-ul"></ul></div></div><div id="atwho-ground-710990fc1442891274231"><div id="at-view-tag" class="atwho-view"><ul class="atwho-view-ul"></ul></div></div><div id="atwho-ground-7dc545ef1442891274232"><div id="at-view-tag" class="atwho-view"><ul class="atwho-view-ul"></ul></div></div></div><script src="android-emulator_files/theme-earthsong.js"></script><style id="font_size" type="text/css">@media (min-width: 0px) {
#wmd-input, #wmd-input.ace_editor {
   font-size: 14.222222222222221px;
}
#preview-contents {
   font-size: 14.222222222222221px;
}
}@media (min-width: 600px) {
#wmd-input, #wmd-input.ace_editor {
   font-size: 15.11111111111111px;
}
#preview-contents {
   font-size: 15.11111111111111px;
}
}@media (min-width: 1200px) {
#wmd-input, #wmd-input.ace_editor {
   font-size: 16px;
}
#preview-contents {
   font-size: 16px;
}
}</style><style class="custom-content-style" id="content-font_size" type="text/css"></style><i style="display: none; color: white;" title="Raphaël Colour Picker"></i></body></html>